# WebSocket Issues Fix - Progress

## Current Status: **needs-review**

## Summary
Fixed intermittent WebSocket issues causing:
- "WebSocket is closed before the connection is established" errors
- Task status not updating after follow-up prompts
- Conversation not refreshing without page reload
- Task staying in "in review" instead of moving to "in progress"
- **NEW**: Window refresh/flicker while typing long messages (caused by aggressive 60s idle timeout)

## Completed Items

### P1 Fixes (Critical)
- [x] Memoized endpoint in `useDiffStream.ts` - prevents unnecessary reconnections
- [x] Added AbortController in `useJsonPatchWsStream.ts` - cancels pending connections on cleanup
- [x] ~~Added active heartbeat reconnection (60s idle timeout)~~ **REVERTED** - was too aggressive

### P1.1 Fix (Regression Fix)
- [x] Removed 60-second idle timeout that was causing unnecessary WebSocket reconnections while users type long messages. Now relies on backend's 90-second ping/pong keepalive for stale connection detection.

### P2 Fixes (Important)
- [x] Extended `TaskOptimisticContext` for status updates
- [x] Added `updateTaskStatusOptimistically` to `useProjectTasks`
- [x] Updated `useFollowUpSend` to call optimistic status update
- [x] Updated `TaskFollowUpSection` to pass taskId/projectId
- [x] Updated `ProjectTasks.tsx` to use new optimistic context

### P3 Fixes (Nice to have)
- [x] Reviewed backend broadcast - already has 5s timeout, frontend optimistic approach preferred

## Files Modified
1. `frontend/src/hooks/useDiffStream.ts` - Memoized endpoint
2. `frontend/src/hooks/useJsonPatchWsStream.ts` - AbortController, removed aggressive idle timeout
3. `frontend/src/contexts/TaskOptimisticContext.tsx` - Status update registry
4. `frontend/src/hooks/useProjectTasks.ts` - updateTaskStatusOptimistically
5. `frontend/src/hooks/follow-up/useFollowUpSend.ts` - Optimistic status update
6. `frontend/src/components/tasks/TaskFollowUpSection.tsx` - Pass taskId/projectId
7. `frontend/src/pages/ProjectTasks.tsx` - Use new context prop

## Testing Required
Browser testing needed for:
1. Create new task - verify appears on kanban without refresh
2. Send follow-up prompt - verify task moves to "in progress" immediately
3. Navigate rapidly between tasks - check for "closed before established" errors
4. Type long message in follow-up box - verify NO window refresh/reconnection during typing
5. Leave page idle for 2+ minutes - verify connection stays stable (backend keepalive handles it)

## Build Status
- [x] TypeScript check passing (`npm run check`)
- [x] Backend check passing (`cargo check`)
- [x] No lint errors

## Key Insight
The 60-second client-side idle timeout was counterproductive:
- Legitimate idle time is common (waiting for agent response, user typing)
- Backend already has 90-second ping/pong keepalive to detect dead connections
- Client-side timeout caused unnecessary reconnections and UI disruption
