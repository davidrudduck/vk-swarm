# Parallel Setup Script Feature - Progress

## Status: Needs Review (Session 3 Complete)

## Plan Reference
`/home/david/.claude/plans/mighty-wobbling-spring.md`

## Feature Summary
Add a `parallel_setup_script` boolean flag that allows setup scripts to run **concurrently** with the coding agent instead of waiting for setup to complete first. This is useful for long-running setup processes (like `npm install`) that don't need to complete before the agent starts working.

## Session 1: Database & Model Layer - COMPLETE

### Completed Items

- [x] **Sync with origin/main** - Already up to date
- [x] **Create migration** - `crates/db/migrations/20251218000000_add_parallel_setup_script.sql`
  ```sql
  ALTER TABLE projects ADD COLUMN parallel_setup_script BOOLEAN NOT NULL DEFAULT 0;
  ```
- [x] **Update `Project` struct** - Added `parallel_setup_script: bool` field
- [x] **Update `UpdateProject` struct** - Added `parallel_setup_script: Option<bool>` field
- [x] **Update all SQL queries** - Updated 12 queries in `project.rs`:
  - `find_all`
  - `find_most_active`
  - `find_by_id`
  - `find_by_remote_project_id`
  - `find_by_git_repo_path`
  - `find_by_git_repo_path_excluding_id`
  - `create`
  - `update`
  - `find_remote_projects`
  - `find_local_projects`
  - `upsert_remote_project`
  - `find_local_projects_with_last_attempt`
- [x] **Update API route handler** - Updated `projects.rs` to handle new field in update
- [x] **Verify cargo check passes** - PASS with DATABASE_URL
- [x] **Run npm run generate-types** - PASS
- [x] **Verify types in shared/types.ts** - PASS
  - `Project` type includes `parallel_setup_script: boolean`
  - `UpdateProject` type includes `parallel_setup_script: boolean | null`

### Files Modified (Session 1)

**Database:**
- `crates/db/migrations/20251218000000_add_parallel_setup_script.sql` (NEW)

**Backend:**
- `crates/db/src/models/project.rs` - Added field to structs, updated 12 SQL queries
- `crates/server/src/routes/projects.rs` - Updated update handler

**Shared:**
- `shared/types.ts` - Auto-generated with new field

## Session 2: Container Service Logic - COMPLETE

### Completed Items

- [x] **Sync with origin/main** - Rebased onto latest main (2 new commits)
- [x] **Update `start_attempt()` in container.rs** - Added parallel execution logic
  - When `parallel_setup_script` is `true`:
    - Setup script starts independently with `next_action: None`
    - Coding agent starts immediately without waiting for setup
    - Setup failures are logged but don't block the agent
  - When `parallel_setup_script` is `false` (default):
    - Existing sequential behavior: setup → coding agent chain
- [x] **Update `should_finalize()` in container.rs** - Prevent parallel setup scripts from triggering finalization
  - Added check: if `run_reason == SetupScript && next_action.is_none()`, return `false`
  - This prevents parallel-mode setup scripts from setting task to InReview
- [x] **Verify cargo check passes** - PASS (excluding remote crate which has pre-existing issues)
- [x] **Code formatted** - Ran cargo fmt on container.rs

### Files Modified (Session 2)

**Backend:**
- `crates/services/src/services/container.rs` - Modified two methods:
  - `start_attempt()` (~line 694): Added parallel execution logic
  - `should_finalize()` (~line 129): Added parallel setup script handling

### Technical Notes

- **Parallel mode**: Both setup script and coding agent start simultaneously
- **Sequential mode** (default): Setup script chains to coding agent via `next_action`
- **Finalization logic**: Setup scripts without `next_action` (parallel mode) don't trigger task finalization
- **Error handling**: Setup script failures in parallel mode are logged but don't block the coding agent

### Code Changes Summary

**`should_finalize()` changes:**
```rust
// Added: Never finalize setup scripts without next_action (parallel mode)
if matches!(ctx.execution_process.run_reason, ExecutionProcessRunReason::SetupScript)
    && action.next_action.is_none()
{
    return false;
}
```

**`start_attempt()` changes:**
```rust
if project.parallel_setup_script {
    // Parallel mode: start setup script independently
    let setup_action = ExecutorAction::new(..., None);  // No chaining
    self.start_execution(&task_attempt, &setup_action, &SetupScript).await;

    // Start coding agent immediately
    let coding_action = ExecutorAction::new(...);
    self.start_execution(&task_attempt, &coding_action, &CodingAgent).await?
} else {
    // Sequential mode (existing behavior)
    ...
}
```

## Session 3: API & Frontend - COMPLETE

### Completed Items

- [x] **Add checkbox to ProjectSettings.tsx** - Added `parallel_setup_script` field to:
  - `ProjectFormState` interface
  - `projectToFormState()` function
  - `handleSave()` payload
  - UI: Checkbox component with label and helper text below Setup Script textarea
- [x] **Fix NoServerContent.tsx** - Added `parallel_setup_script` to update payload (TypeScript error fix)
- [x] **Add i18n translations** - Added to all 4 locale files:
  - `frontend/src/i18n/locales/en/settings.json`
  - `frontend/src/i18n/locales/ja/settings.json`
  - `frontend/src/i18n/locales/ko/settings.json`
  - `frontend/src/i18n/locales/es/settings.json`
- [x] **npm run lint** - PASS
- [x] **npm run check** - PASS (both frontend and backend)
- [x] **Browser testing with Playwright** - Verified:
  - Desktop dark mode: checkbox visible with good contrast ✓
  - Mobile (375x812) dark mode: checkbox visible and properly laid out ✓
  - Tablet (768x1024) dark mode: checkbox visible with good contrast ✓
  - Tablet (768x1024) light mode: checkbox visible, checked state works ✓
  - Checkbox toggles correctly and shows "unsaved changes" indicator ✓
  - Checkbox is disabled when no setup script is set ✓

### Files Modified (Session 3)

**Frontend:**
- `frontend/src/pages/settings/ProjectSettings.tsx` - Added checkbox UI and form state
- `frontend/src/components/tasks/TaskDetails/preview/NoServerContent.tsx` - Fixed TypeScript error

**i18n:**
- `frontend/src/i18n/locales/en/settings.json` - Added parallelSetup translations
- `frontend/src/i18n/locales/ja/settings.json` - Added parallelSetup translations
- `frontend/src/i18n/locales/ko/settings.json` - Added parallelSetup translations
- `frontend/src/i18n/locales/es/settings.json` - Added parallelSetup translations

### Translation Keys Added

```json
"parallelSetup": {
  "label": "Run setup script in parallel with agent",
  "helper": "When enabled, the setup script runs concurrently with the coding agent instead of waiting for it to complete first. Useful for long-running setup processes."
}
```

### UI Implementation Details

The checkbox is placed directly below the Setup Script textarea helper text:
- Uses shadcn/ui `Checkbox` component
- Label: "Run setup script in parallel with agent" (translated)
- Helper text: Explains the behavior (translated)
- Disabled when `setup_script` is empty (no setup script to parallelize)

## Test Plan (For Session 3)

### Manual Testing Checklist

1. **Sequential mode (default)**
   - Create project with setup_script, leave parallel_setup_script unchecked
   - Start a task attempt
   - Verify: Setup script completes BEFORE coding agent starts
   - Verify: Task transitions: Todo → InProgress → InReview

2. **Parallel mode**
   - Enable parallel_setup_script checkbox
   - Start a task attempt
   - Verify: Both setup script AND coding agent start immediately
   - Verify: Two execution processes visible in logs (SetupScript + CodingAgent)
   - Verify: Task completes normally when agent finishes

3. **Parallel mode - setup script failure**
   - Set setup_script to a failing command (e.g., `exit 1`)
   - Enable parallel_setup_script
   - Start a task attempt
   - Verify: Coding agent continues despite setup failure
   - Verify: Setup script failure is logged

4. **UI validation**
   - Checkbox disabled when no setup_script is set
   - Checkbox enabled when setup_script exists
   - Setting persists after save/reload
