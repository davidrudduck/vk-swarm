# Performance Fixes - Session 3: Frontend Visibility-Based Polling

## Status: needs-review

## Overview
Session 3 focused on adding visibility-based polling to frontend hooks. When the browser tab is hidden (user switches to another tab), polling is automatically disabled to reduce unnecessary network requests and improve client-side performance.

## Completed Items

### Session 1: Bulk Database Operations ✅
- [x] `Task::archive_many()` - Replaced loop with bulk UPDATE
- [x] `Task::delete_stale_remote_tasks()` - Single DELETE with NOT IN
- [x] `Project::delete_stale_remote_projects()` - Same pattern

### Session 2: Recursive CTE for Variable Inheritance ✅
- [x] Analyzed existing `find_inherited()` implementation
- [x] Implemented recursive CTE with window functions
- [x] Used `ROW_NUMBER() OVER (PARTITION BY name ORDER BY depth ASC)` for child-overrides-parent behavior
- [x] Added explicit CAST for SQLite type handling
- [x] Updated SQLx query cache for offline compilation
- **File:** `crates/db/src/models/task_variable.rs:157-221`

### Session 3: Frontend Visibility-Based Polling ✅
- [x] Verified database indexes already exist (no migration needed):
  - `idx_tasks_parent_task_id` - from migration 20251215
  - `idx_execution_processes_pid_running` - from migration 20251219
  - `idx_execution_processes_status` - from existing optimizations
- [x] `useAllTasks.ts` - Added `document.hidden` check to `refetchInterval`
- [x] `useActivityFeed.ts` - Added visibility-based polling
- [x] `useDashboardSummary.ts` - Added visibility-based polling
- [x] `useTaskAttempts.ts` - Added visibility-based polling (with configurable interval support)
- [x] `useProcesses.ts` - Added visibility-based polling
- [x] `useBranchStatus.ts` - Added visibility-based polling

## Validation Results

### cargo test -p db ✅
```text
running 52 tests
test result: ok. 52 passed; 0 failed; 0 ignored
```

### npm run check ✅
- Frontend TypeScript check: passed
- Backend cargo check: passed
- ESLint: Only pre-existing i18n warnings (not related to changes)

### Browser Testing ✅
- Desktop (1280x800): All functionality working
- Tablet (768x1024): All functionality working
- Mobile (375x667): All functionality working
- Light mode: Proper contrast, no accessibility issues
- Dark mode: Proper contrast, no accessibility issues
- Activity feed: Loads and displays correctly
- Kanban board: Loads and displays correctly
- Settings page: Theme switching works correctly
- No console errors (except pre-existing DOM nesting warning)

## Files Changed

| File | Change |
|------|--------|
| `frontend/src/hooks/useAllTasks.ts` | Added `refetchInterval: () => (document.hidden ? false : 10000)` |
| `frontend/src/hooks/useActivityFeed.ts` | Added visibility-based polling |
| `frontend/src/hooks/useDashboardSummary.ts` | Added visibility-based polling |
| `frontend/src/hooks/useTaskAttempts.ts` | Added visibility-based polling with configurable interval |
| `frontend/src/hooks/useProcesses.ts` | Added visibility-based polling |
| `frontend/src/hooks/useBranchStatus.ts` | Added visibility-based polling |

## Performance Impact

| Improvement | Before | After |
|------------|--------|-------|
| Background tab network requests | Continuous (every 5-10s) | None (polling disabled) |
| CPU usage on hidden tabs | Constant polling overhead | Minimal |

## Technical Details

The visibility-based polling pattern uses TanStack Query's functional `refetchInterval`:

```typescript
refetchInterval: () => (document.hidden ? false : 5000),
```

This checks `document.hidden` on each interval evaluation:
- When tab is visible: Returns the polling interval (e.g., 5000ms)
- When tab is hidden: Returns `false` to disable polling

For hooks with configurable intervals (like `useTaskAttempts`), the pattern preserves the ability to completely disable polling:

```typescript
refetchInterval: () => {
  if (baseInterval === false) return false;
  return document.hidden ? false : baseInterval;
},
```

## All Sessions Complete

The performance optimization plan has been fully implemented:
1. ✅ Session 1: Bulk database operations
2. ✅ Session 2: Recursive CTE for variable inheritance
3. ✅ Session 3: Frontend visibility-based polling

## Next Steps
- Code review and merge to main
- Monitor production metrics for performance improvements
