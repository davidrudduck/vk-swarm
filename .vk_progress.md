# ElectricSQL Migration Progress

## Current Status: in-progress

## Plan File
/home/david/.claude/plans/logical-wiggling-wand.md

## Session 1: Validation Module (TDD) - COMPLETED

### Objectives
Replace SQLite CHECK constraints with Rust validation for ElectricSQL compatibility.

### Completed Items
- [x] Create `crates/db/src/validation.rs` with TDD tests first
- [x] Add `validate_task_status()` function - validates: todo, inprogress, inreview, done, cancelled
- [x] Add `validate_execution_status()` function - validates: running, completed, failed, killed
- [x] Add `validate_node_status()` function - validates: pending, online, offline, busy, draining
- [x] Export validation module from `crates/db/src/lib.rs`
- [x] Run `cargo test -p db validation` - 9 tests pass
- [x] Run `npm run check` - all checks pass (frontend TypeScript + backend Cargo)

### Files Changed

| File | Change |
|------|--------|
| `crates/db/src/validation.rs` | New - Validation module with error types, const arrays, validation functions, and 9 TDD tests |
| `crates/db/src/lib.rs` | Added `pub mod validation;` export |

### Test Results

```text
running 9 tests
test validation::tests::test_validate_execution_status_invalid ... ok
test validation::tests::test_validate_node_status_error_message ... ok
test validation::tests::test_validate_execution_status_error_message ... ok
test validation::tests::test_validate_execution_status_valid ... ok
test validation::tests::test_validate_node_status_valid ... ok
test validation::tests::test_validate_task_status_invalid ... ok
test validation::tests::test_validate_task_status_valid ... ok
test validation::tests::test_validate_node_status_invalid ... ok
test validation::tests::test_validate_task_status_error_message ... ok

test result: ok. 9 passed; 0 failed; 0 ignored; 0 measured; 52 filtered out
```

---

## Session 2: Log Entry Model (TDD) - COMPLETED

### Objectives
Create row-level log entries table (instead of JSONL batches) for ElectricSQL compatibility.

### Completed Items
- [x] Create migration file `20251225000000_create_log_entries.sql`
- [x] Create `crates/db/src/models/log_entry.rs` with `DbLogEntry` struct
- [x] Add `CreateLogEntry` request struct with helper methods (stdout, stderr, system, etc.)
- [x] Implement CRUD operations: create, find_by_id, find_by_execution_id, delete_by_execution_id
- [x] Implement cursor-based pagination with forward/backward support (`find_paginated`)
- [x] Add `PaginatedDbLogEntries` result struct with has_more indicator
- [x] Add `to_paginated_logs()` conversion to existing `PaginatedLogs` type
- [x] Export log_entry module from `crates/db/src/models/mod.rs`
- [x] Run `cargo test -p db log_entry` - 15 tests pass
- [x] Run `npm run check` - all checks pass (frontend TypeScript + backend Cargo)

### Files Changed

| File | Change |
|------|--------|
| `crates/db/migrations/20251225000000_create_log_entries.sql` | New - log_entries table with indexes for execution_id and timestamp |
| `crates/db/src/models/log_entry.rs` | New - DbLogEntry model with CRUD, pagination, and 15 TDD tests |
| `crates/db/src/models/mod.rs` | Added `pub mod log_entry;` export |

### Test Results

```text
running 15 tests
test models::log_entry::export_bindings_dblogentry ... ok
test models::log_entry::export_bindings_paginateddblogentries ... ok
test models::log_entry::tests::test_log_entry_create ... ok
test models::log_entry::tests::test_log_entry_delete_by_execution_id ... ok
test models::log_entry::tests::test_log_entry_find_by_execution_id ... ok
test models::log_entry::tests::test_log_entry_find_by_id ... ok
test models::log_entry::tests::test_log_entry_isolation_between_executions ... ok
test models::log_entry::tests::test_log_entry_output_types ... ok
test models::log_entry::tests::test_log_entry_pagination_backward_no_cursor ... ok
test models::log_entry::tests::test_log_entry_pagination_backward_with_cursor ... ok
test models::log_entry::tests::test_log_entry_pagination_empty ... ok
test models::log_entry::tests::test_log_entry_pagination_forward_last_page ... ok
test models::log_entry::tests::test_log_entry_pagination_forward_no_cursor ... ok
test models::log_entry::tests::test_log_entry_pagination_forward_with_cursor ... ok
test models::log_entry::tests::test_log_entry_to_paginated_logs ... ok

test result: ok. 15 passed; 0 failed; 0 ignored; 0 measured; 61 filtered out
```

---

## Session 3: SQLite Performance Pragmas - COMPLETED

### Objectives
Add performance pragmas to SQLite connections for improved database performance.

### Completed Items
- [x] Create TDD test file `crates/db/tests/sqlite_pragmas.rs` with 6 tests
- [x] Test for journal_mode = WAL (already in options, verified)
- [x] Test for synchronous = NORMAL (added to options)
- [x] Test for temp_store = MEMORY (applied via after_connect)
- [x] Test for mmap_size = 256MB (applied via after_connect)
- [x] Test for cache_size = -64000 / 64MB (applied via after_connect)
- [x] Test that pragmas are applied to all connections in the pool
- [x] Update `crates/db/src/lib.rs` with `apply_performance_pragmas()` function
- [x] Update `DBService::new()` to use after_connect hook
- [x] Update `DBService::create_pool()` to apply pragmas + user hooks
- [x] Run `cargo test -p db --test sqlite_pragmas` - 6 tests pass
- [x] Run `npm run check` - all checks pass (frontend TypeScript + backend Cargo)

### Files Changed

| File | Change |
|------|--------|
| `crates/db/tests/sqlite_pragmas.rs` | New - Integration tests for SQLite performance pragmas (6 tests) |
| `crates/db/src/lib.rs` | Modified - Added `SqliteSynchronous` import, `apply_performance_pragmas()` function, and updated pool creation methods |

### Test Results

```text
running 6 tests
test test_sqlite_pragma_mmap_size ... ok
test test_sqlite_pragma_journal_mode_wal ... ok
test test_sqlite_pragma_cache_size ... ok
test test_sqlite_pragma_synchronous_normal ... ok
test test_sqlite_pragma_temp_store_memory ... ok
test test_sqlite_pragmas_applied_to_all_connections ... ok

test result: ok. 6 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
```

### Performance Pragmas Applied

| Pragma | Value | Purpose |
|--------|-------|---------|
| `journal_mode` | WAL | Write-Ahead Logging for concurrent reads/writes |
| `synchronous` | NORMAL | Balanced durability vs performance |
| `temp_store` | MEMORY (2) | Store temp tables in memory |
| `mmap_size` | 256MB | Memory-mapped I/O for faster reads |
| `cache_size` | -64000 (64MB) | Larger page cache for better performance |

---

## Session 4: Electric Client (TDD) - COMPLETED

### Objectives
Create HTTP client for consuming Electric Shape API responses with operation parsing.

### Completed Items
- [x] Create `crates/services/src/services/electric_sync.rs` with TDD tests first
- [x] Implement `ElectricError` enum for error handling (JsonParse, UnknownOperation, etc.)
- [x] Implement `OperationType` enum (Insert, Update, Delete) with serde serialization
- [x] Implement `ControlType` enum (UpToDate, MustRefetch) for control messages
- [x] Implement `ShapeHeaders` struct for parsing message headers
- [x] Implement `RawShapeMessage` struct for deserializing Electric API responses
- [x] Implement `ShapeOperation` enum with parse() and from_raw() methods
- [x] Implement `ShapeConfig` struct for configuring shape subscriptions
- [x] Implement `ShapeState` struct for tracking subscription state (handle, offset)
- [x] Implement `ElectricHeaders` struct for extracting HTTP response headers
- [x] Implement `ElectricClient` with build_url(), fetch(), and parse_ndjson() methods
- [x] Add `electric_sync` module to `crates/services/src/services/mod.rs`
- [x] Add `urlencoding = "2.1"` to services Cargo.toml
- [x] Run `cargo test -p services electric_sync` - 21 tests pass
- [x] Run `npm run check` - all checks pass (frontend TypeScript + backend Cargo)

### Files Changed

| File | Change |
|------|--------|
| `crates/services/src/services/electric_sync.rs` | New - Electric Shape API client with operation parsing and 21 TDD tests |
| `crates/services/src/services/mod.rs` | Added `pub mod electric_sync;` export |
| `crates/services/Cargo.toml` | Added `urlencoding = "2.1"` dependency |

### Test Results

```text
running 21 tests
test services::electric_sync::tests::test_build_url_initial_sync ... ok
test services::electric_sync::tests::test_build_url_live_mode ... ok
test services::electric_sync::tests::test_build_url_with_columns ... ok
test services::electric_sync::tests::test_build_url_with_handle ... ok
test services::electric_sync::tests::test_build_url_with_where_clause ... ok
test services::electric_sync::tests::test_control_type_deserialize ... ok
test services::electric_sync::tests::test_error_display ... ok
test services::electric_sync::tests::test_operation_type_deserialize ... ok
test services::electric_sync::tests::test_parse_control_must_refetch ... ok
test services::electric_sync::tests::test_parse_control_up_to_date ... ok
test services::electric_sync::tests::test_parse_delete_missing_key ... ok
test services::electric_sync::tests::test_parse_insert_missing_value ... ok
test services::electric_sync::tests::test_parse_missing_operation_and_control ... ok
test services::electric_sync::tests::test_parse_ndjson_empty ... ok
test services::electric_sync::tests::test_parse_ndjson_multiple_operations ... ok
test services::electric_sync::tests::test_parse_ndjson_with_empty_lines ... ok
test services::electric_sync::tests::test_parse_shape_delete ... ok
test services::electric_sync::tests::test_parse_shape_insert ... ok
test services::electric_sync::tests::test_parse_shape_update ... ok
test services::electric_sync::tests::test_raw_message_with_complex_value ... ok
test services::electric_sync::tests::test_shape_state_initial ... ok

test result: ok. 21 passed; 0 failed; 0 ignored; 0 measured; 104 filtered out
```

### Key Types Implemented

| Type | Description |
|------|-------------|
| `ShapeOperation` | Enum representing insert/update/delete/control messages |
| `ElectricClient` | HTTP client for fetching and parsing shape data |
| `ShapeConfig` | Configuration for shape subscriptions (table, where, columns) |
| `ShapeState` | Tracks subscription state (handle, offset) |
| `ElectricError` | Error types for parsing and HTTP errors |

---

## Session 5: Electric Proxy Route (TDD) - COMPLETED

### Objectives
Create secure proxy for Electric Shape API with authentication and organization-based WHERE clause injection.

### Completed Items
- [x] Add `electric_url` and `electric_secret` configuration options to `RemoteServerConfig`
- [x] Add `http_client` (reqwest::Client) to `AppState` for proxying requests
- [x] Create `crates/remote/src/validated_where.rs` module for server-side WHERE clause building
- [x] Create `crates/remote/src/routes/electric_proxy.rs` with TDD tests first
- [x] Implement `ELECTRIC_PARAMS` constant - safe parameters to forward (offset, handle, live, cursor, columns)
- [x] Implement `empty_shape_response()` for users without organization memberships
- [x] Implement `proxy_shared_tasks()` handler with organization filtering
- [x] Implement `proxy_table()` helper for URL building and HTTP proxying
- [x] Implement `ProxyError` enum with IntoResponse for error handling
- [x] Add route to `crates/remote/src/routes/mod.rs` (protected routes)
- [x] Add `stream` feature to reqwest in Cargo.toml for response body streaming
- [x] Run `cargo test -p remote electric_proxy` - 6 tests pass
- [x] Run `cargo test -p remote validated_where` - 3 tests pass
- [x] Run `cargo clippy -p remote` - no warnings
- [x] Run `npm run check` - all checks pass (frontend TypeScript + backend Cargo)

### Files Changed

| File | Change |
|------|--------|
| `crates/remote/src/config.rs` | Added `electric_url: Option<String>` and `electric_secret: Option<SecretString>` config options |
| `crates/remote/src/state.rs` | Added `http_client: reqwest::Client` field and constructor parameter |
| `crates/remote/src/app.rs` | Added HTTP client creation with user-agent |
| `crates/remote/src/validated_where.rs` | New - ValidatedWhere struct for server-side WHERE clause building |
| `crates/remote/src/routes/electric_proxy.rs` | New - Electric proxy route with auth and WHERE clause injection (6 tests) |
| `crates/remote/src/routes/mod.rs` | Added `mod electric_proxy` and merged router |
| `crates/remote/src/lib.rs` | Added `pub mod validated_where;` export |
| `crates/remote/Cargo.toml` | Added `stream` feature to reqwest dependency |

### Test Results

```text
running 6 tests
test routes::electric_proxy::tests::test_electric_params_list ... ok
test routes::electric_proxy::tests::test_empty_shape_response ... ok
test routes::electric_proxy::tests::test_filter_unsafe_params ... ok
test routes::electric_proxy::tests::test_format_org_uuids_for_electric ... ok
test routes::electric_proxy::tests::test_proxy_error_display ... ok
test routes::electric_proxy::tests::test_url_building ... ok

test result: ok. 6 passed; 0 failed; 0 ignored; 0 measured; 23 filtered out

running 3 tests
test validated_where::tests::test_validated_where_clone ... ok
test validated_where::tests::test_validated_where_new ... ok
test validated_where::tests::test_validated_where_debug ... ok

test result: ok. 3 passed; 0 failed; 0 ignored; 0 measured; 26 filtered out
```

### Security Features

| Feature | Implementation |
|---------|----------------|
| Auth Required | Route is in `v1_protected` layer with `require_session` middleware |
| WHERE Injection | Server-side `organization_id = ANY($1)` - client cannot override |
| Param Filtering | Only safe params forwarded (offset, handle, live, cursor, columns) |
| Empty Response | Users without orgs receive `[]` instead of unauthorized error |
| Secret Handling | Electric secret passed via `secrecy::ExposeSecret` |
| Streaming | Response body streamed directly without buffering |

### Environment Variables

| Variable | Description |
|----------|-------------|
| `ELECTRIC_URL` | URL of Electric sync service (e.g., `http://localhost:3001`) |
| `ELECTRIC_SECRET` | Optional secret for authenticating with Electric |

---

## Session 6: Electric PostgreSQL Migration - COMPLETED

### Objectives
Enable PostgreSQL logical replication for ElectricSQL sync service.

### Completed Items
- [x] Create migration file `crates/remote/migrations/20251225000000_electric_support.sql`
- [x] Create `electric_sync` role with LOGIN REPLICATION permissions
- [x] Grant CONNECT and USAGE permissions for the electric_sync role
- [x] Create `electric_publication_default` publication for logical replication
- [x] Create `electric_sync_table()` helper function for enabling tables
- [x] Enable sync for `projects` table
- [x] Enable sync for `shared_tasks` table
- [x] Enable sync for `nodes` table
- [x] Enable sync for `node_projects` table
- [x] Enable sync for `node_task_assignments` table
- [x] Enable sync for `node_task_output_logs` table
- [x] Enable sync for `node_task_progress_events` table
- [x] Run `cargo check -p remote` - compiles successfully
- [x] Run `cargo test -p remote` - 34 tests pass
- [x] Run `cargo clippy -p remote` - no warnings
- [x] Run `cargo test --workspace` - 63 tests pass
- [x] Run `npm run check` - all checks pass

### Files Changed

| File | Change |
|------|--------|
| `crates/remote/migrations/20251225000000_electric_support.sql` | New - Electric logical replication setup with role, publication, and helper function |

### Migration Details

The migration performs the following:

1. **Role Creation**: Creates `electric_sync` role with `LOGIN REPLICATION` privileges
2. **Permission Grants**:
   - `CONNECT ON DATABASE remote`
   - `USAGE ON SCHEMA public`
3. **Publication**: Creates `electric_publication_default` for Electric to subscribe
4. **Helper Function**: `electric_sync_table(schema, table)` that:
   - Sets `REPLICA IDENTITY FULL` (required for updates/deletes)
   - Grants `SELECT` to `electric_sync` role
   - Adds table to the publication

### Tables Enabled for Sync

| Table | Description |
|-------|-------------|
| `projects` | Organization workspaces |
| `shared_tasks` | Main task registry |
| `nodes` | Connected worker nodes |
| `node_projects` | Node-project links |
| `node_task_assignments` | Task execution tracking |
| `node_task_output_logs` | Execution stdout/stderr |
| `node_task_progress_events` | Execution milestones |

### PostgreSQL Configuration Required

For this migration to work, the PostgreSQL server must have:
```text
wal_level = logical
```

This is typically set in `postgresql.conf` or via Docker environment variable.

### Verification Commands

After running the migration, verify with:
```sql
-- Check publication exists
SELECT * FROM pg_publication WHERE pubname = 'electric_publication_default';

-- Check tables in publication
SELECT * FROM pg_publication_tables WHERE pubname = 'electric_publication_default';

-- Check role exists
SELECT * FROM pg_roles WHERE rolname = 'electric_sync';
```

---

## Session 7: Docker Compose Electric Setup - COMPLETED

### Objectives
Add ElectricSQL sync service to Docker Compose for local development.

### Completed Items
- [x] Enable `wal_level=logical` in PostgreSQL command (required for Electric replication)
- [x] Add `electric` service using `electricsql/electric:latest` image
- [x] Configure Electric `DATABASE_URL` with `electric_sync` role and default password
- [x] Add Electric configuration: `AUTH_MODE=insecure`, `ELECTRIC_MANUAL_TABLE_PUBLISHING=true`
- [x] Add healthcheck using `curl -sf http://localhost:3000/v1/health`
- [x] Map Electric port 3000 to host port 3001 (configurable via `ELECTRIC_PORT`)
- [x] Add `electric-data` volume for persistent state
- [x] Update `remote-server` to depend on Electric being healthy
- [x] Add `ELECTRIC_URL=http://electric:3000` to remote-server environment
- [x] Update `.env.remote.example` with Electric configuration documentation
- [x] Update migration to create `electric_sync` role with default password
- [x] Test Docker Compose: PostgreSQL + Electric services start and pass healthchecks
- [x] Verify Electric health endpoint returns `{"status":"active"}`
- [x] Run `cargo test --workspace` - all tests pass
- [x] Run `cargo clippy --workspace` - no warnings

### Files Changed

| File | Change |
|------|--------|
| `crates/remote/docker-compose.yml` | Added Electric service, updated PostgreSQL with wal_level=logical, updated remote-server dependencies |
| `crates/remote/.env.remote.example` | Added ElectricSQL configuration section with ELECTRIC_PORT and ELECTRIC_ROLE_PASSWORD |
| `crates/remote/migrations/20251225000000_electric_support.sql` | Updated to use dynamic database name and default password for electric_sync role |

### Docker Compose Changes

```yaml
# New PostgreSQL command for logical replication
command: [ "postgres", "-c", "wal_level=logical" ]

# New Electric service
electric:
  image: electricsql/electric:latest
  environment:
    DATABASE_URL: postgresql://electric_sync:${ELECTRIC_ROLE_PASSWORD:-electric_sync}@remote-db:5432/${POSTGRES_DB:-vibe_remote}
    AUTH_MODE: insecure
    ELECTRIC_MANUAL_TABLE_PUBLISHING: true
  healthcheck:
    test: [ "CMD-SHELL", "curl -sf http://localhost:3000/v1/health || exit 1" ]
  ports:
    - "${ELECTRIC_PORT:-3001}:3000"
```

### Verification

```bash
# Start services
docker compose --env-file .env.remote.example up -d remote-db electric

# Check health endpoint
curl http://localhost:3001/v1/health
# Returns: {"status":"active"}

# Check services status
docker compose ps
# Shows: remote-db (healthy), electric (healthy)
```

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `ELECTRIC_PORT` | 3001 | Host port for Electric service |
| `ELECTRIC_ROLE_PASSWORD` | electric_sync | Password for electric_sync role |

---

## Session 8: Frontend Electric Config (TDD) - COMPLETED

### Objectives
Create frontend Electric SQL configuration and TanStack DB collections for real-time data sync.

### Completed Items
- [x] Install TanStack dependencies: `@tanstack/react-db`, `@tanstack/electric-db-collection`
- [x] Install Electric SQL client: `@electric-sql/client`, `@electric-sql/react`
- [x] Create `frontend/src/lib/electric/config.ts` with TDD tests first
- [x] Implement `ELECTRIC_PROXY_BASE` constant for proxy endpoint URL
- [x] Implement `ELECTRIC_SHAPE_TABLES` configuration object with all sync-enabled tables
- [x] Implement `createShapeUrl()` function for generating shape URLs
- [x] Implement `createShapeStreamOptions()` function for ShapeStream configuration
- [x] Export type definitions: `ElectricTableConfig`, `ElectricShapeTable`, `ShapeStreamOptions`
- [x] Create `frontend/src/lib/electric/collections.ts` with TDD tests
- [x] Implement `ElectricRow` base type for Row<unknown> constraint compatibility
- [x] Implement `ElectricNode`, `ElectricProject`, `ElectricNodeProject`, `ElectricSharedTask` types
- [x] Implement `createSharedTasksCollection()` factory function
- [x] Implement `createNodesCollection()`, `createProjectsCollection()`, `createNodeProjectsCollection()` factories
- [x] Create `frontend/src/lib/electric/index.ts` re-export module
- [x] Run `npm run test` - 67 tests pass (18 new Electric tests)
- [x] Run `npx tsc --noEmit` - TypeScript compilation passes
- [x] Run `npm run lint` - ESLint passes on Electric files
- [x] Test in browser: light mode, dark mode, mobile (375x667), tablet (768x1024), desktop (1280x800)

### Files Changed

| File | Change |
|------|--------|
| `frontend/package.json` | Added `@tanstack/react-db`, `@tanstack/electric-db-collection`, `@electric-sql/client`, `@electric-sql/react` dependencies |
| `frontend/src/lib/electric/config.ts` | New - Electric shape configuration with proxy URL and table definitions |
| `frontend/src/lib/electric/config.test.ts` | New - 10 TDD tests for config module |
| `frontend/src/lib/electric/collections.ts` | New - TanStack DB collections backed by Electric shapes |
| `frontend/src/lib/electric/collections.test.ts` | New - 8 TDD tests for collections module |
| `frontend/src/lib/electric/index.ts` | New - Re-export module for all Electric exports |

### Test Results

```text
✓ frontend/src/lib/electric/config.test.ts (10 tests)
  ✓ Electric Config > getElectricBaseUrl > returns the correct base URL for Electric proxy
  ✓ Electric Config > ELECTRIC_SHAPE_TABLES > contains shared_tasks table definition
  ✓ Electric Config > ELECTRIC_SHAPE_TABLES > contains nodes table definition
  ✓ Electric Config > ELECTRIC_SHAPE_TABLES > contains projects table definition
  ✓ Electric Config > ELECTRIC_SHAPE_TABLES > contains node_projects table definition
  ✓ Electric Config > createShapeUrl > creates URL for shared_tasks table
  ✓ Electric Config > createShapeUrl > creates URL for nodes table
  ✓ Electric Config > createShapeUrl > creates URL for projects table
  ✓ Electric Config > createShapeUrl > creates URL for node_projects table
  ✓ Electric Config > createShapeUrl > throws error for invalid table name

✓ frontend/src/lib/electric/collections.test.ts (8 tests)
  ✓ Electric Collections > createSharedTasksCollection > creates a collection with correct shape URL
  ✓ Electric Collections > createSharedTasksCollection > uses id as the key extractor
  ✓ Electric Collections > createNodesCollection > creates a collection with correct shape URL
  ✓ Electric Collections > createNodesCollection > uses id as the key extractor
  ✓ Electric Collections > createProjectsCollection > creates a collection with correct shape URL
  ✓ Electric Collections > createProjectsCollection > uses id as the key extractor
  ✓ Electric Collections > createNodeProjectsCollection > creates a collection with correct shape URL
  ✓ Electric Collections > createNodeProjectsCollection > uses id as the key extractor

Test Files: 67 passed (67)
Tests:      all passed
```

### Key Types & Functions

| Export | Description |
|--------|-------------|
| `ELECTRIC_PROXY_BASE` | Proxy endpoint URL: `/api/electric/v1/shape` |
| `ELECTRIC_SHAPE_TABLES` | Configuration for all sync-enabled tables |
| `createShapeUrl(table)` | Generates shape URL for a table |
| `createShapeStreamOptions(table)` | Creates ShapeStream configuration |
| `createSharedTasksCollection()` | TanStack DB collection for shared tasks |
| `createNodesCollection()` | TanStack DB collection for nodes |
| `createProjectsCollection()` | TanStack DB collection for projects |
| `createNodeProjectsCollection()` | TanStack DB collection for node-project links |

### Technical Notes

**TypeScript Row<unknown> Constraint Fix:**
The `@tanstack/react-db` library requires types to satisfy `Row<unknown>` which needs an index signature. This was resolved by using intersection types:
```typescript
type ElectricRow = Record<string, unknown>;
export type ElectricNode = ElectricRow & {
  id: string;
  organization_id: string;
  // ... other fields
};
```

### Browser Testing Screenshots

| Mode | Device | Result |
|------|--------|--------|
| Light | Desktop (1280x800) | ✓ Pass |
| Dark | Desktop (1280x800) | ✓ Pass |
| Dark | Mobile (375x667) | ✓ Pass |
| Dark | Tablet (768x1024) | ✓ Pass |

---

## Session 9: useElectricTasks Hook (TDD) - COMPLETED

### Objectives
Create a React hook for real-time task sync using Electric SQL and TanStack DB collections.

### Completed Items
- [x] Create `frontend/src/hooks/useElectricTasks.test.ts` with TDD tests first
- [x] Mock `@electric-sql/react` useShape hook for testing
- [x] Test initial state (empty array when no project)
- [x] Test data loading states (isLoading, error)
- [x] Test task filtering by project_id
- [x] Test exclusion of deleted tasks by default
- [x] Test includeArchived option
- [x] Test tasksById indexing
- [x] Test tasksByStatus grouping
- [x] Test sorting (todo: oldest first FIFO, others: most recent first)
- [x] Create `frontend/src/hooks/useElectricTasks.ts` implementation
- [x] Implement useShape integration with Electric SQL
- [x] Implement project filtering with project_id/remote_project_id compatibility
- [x] Implement deleted_at/archived_at filtering
- [x] Implement status-aware sorting
- [x] Export hook and types from `frontend/src/hooks/index.ts`
- [x] Update `ElectricSharedTask` type with PostgreSQL schema fields
- [x] Run `npm run test` - 83 tests pass (16 new Electric tests)
- [x] Run `npm run check` - all checks pass (frontend TypeScript + backend Cargo)
- [x] Test in browser: light mode, mobile (375x667), tablet (768x1024), desktop (1280x800)

### Files Changed

| File | Change |
|------|--------|
| `frontend/src/hooks/useElectricTasks.ts` | New - Electric SQL task sync hook with filtering, grouping, and sorting |
| `frontend/src/hooks/useElectricTasks.test.ts` | New - 16 TDD tests for useElectricTasks hook |
| `frontend/src/hooks/index.ts` | Added useElectricTasks export and types |
| `frontend/src/lib/electric/collections.ts` | Updated ElectricSharedTask type with PostgreSQL schema fields |

### Test Results

```text
✓ src/hooks/useElectricTasks.test.ts (16 tests)
  ✓ useElectricTasks > initial state > returns empty array when no project is provided
  ✓ useElectricTasks > initial state > returns empty array when project has no tasks
  ✓ useElectricTasks > data loading > sets isLoading to true while syncing
  ✓ useElectricTasks > data loading > sets isLoading to false when data is loaded
  ✓ useElectricTasks > data loading > sets error when sync fails
  ✓ useElectricTasks > tasks filtering > filters tasks by project_id
  ✓ useElectricTasks > tasks filtering > excludes deleted tasks by default
  ✓ useElectricTasks > tasks filtering > includes deleted tasks when includeArchived is true
  ✓ useElectricTasks > tasksById > provides tasks indexed by id
  ✓ useElectricTasks > tasksById > returns empty object when no tasks
  ✓ useElectricTasks > tasksByStatus > groups tasks by status
  ✓ useElectricTasks > tasksByStatus > has all status categories even when empty
  ✓ useElectricTasks > sorting > sorts todo tasks by oldest first (FIFO)
  ✓ useElectricTasks > sorting > sorts non-todo tasks by most recent first
  ✓ useElectricTasks > result shape > returns all expected properties
  ✓ useElectricTasks > result shape > isSyncing reflects Electric sync state

Test Files: 7 passed (7)
Tests:      83 passed (83)
```

### Key Types & Functions

| Export | Description |
|--------|-------------|
| `useElectricTasks(projectId, options)` | Hook for real-time task sync via Electric SQL |
| `UseElectricTasksResult` | Return type with tasks, tasksById, tasksByStatus, isLoading, error, isSyncing |
| `UseElectricTasksOptions` | Options: includeArchived (default: false) |
| `ElectricTask` | Type alias for ElectricSharedTask |

### Hook API

```typescript
const {
  tasks,         // All tasks for project, sorted by activity
  tasksById,     // Tasks indexed by ID for quick lookup
  tasksByStatus, // Tasks grouped by status for Kanban views
  isLoading,     // True while initial sync in progress
  error,         // Error if sync failed
  isSyncing,     // True while actively syncing
} = useElectricTasks('project-id', { includeArchived: false });
```

### Browser Testing Screenshots

| Mode | Device | Result |
|------|--------|--------|
| Light | Desktop (1280x800) | ✓ Pass |
| Light | Tablet (768x1024) | ✓ Pass |
| Light | Mobile (375x667) | ✓ Pass |

### Technical Notes

**PostgreSQL Schema Compatibility:**
The ElectricSharedTask type was extended to include PostgreSQL schema fields:
- `project_id` - PostgreSQL project UUID (primary)
- `remote_project_id` - Legacy field for backwards compatibility
- `deleted_at` - PostgreSQL soft-delete timestamp
- `archived_at` - Legacy field alias for compatibility
- `organization_id`, `creator_user_id`, `deleted_by_user_id`, `shared_at`

---

## Remaining Sessions

- [x] Session 2: Log Entry Model (TDD)
- [x] Session 3: SQLite Performance Pragmas
- [x] Session 4: Electric Client (TDD)
- [x] Session 5: Electric Proxy Route (TDD)
- [x] Session 6: Electric PostgreSQL Migration
- [x] Session 7: Docker Compose Electric Setup
- [x] Session 8: Frontend Electric Config (TDD)
- [x] Session 9: useTasks Hook (TDD)
- [ ] Session 10: Node Runner Electric Integration
- [ ] Session 11: JSONL Migration Script
- [ ] Session 12: Remove Legacy Sync Code

---

## Next Session Recommendations

1. Continue with Session 10: Node Runner Electric Integration
2. Update node runner to use Electric for real-time task updates
3. Replace WebSocket-based task sync with Electric shape streams
4. Test end-to-end sync between hive and nodes
