# Swarm Sync Auto-Linking and Label Sync Progress

## Status: needs-review

## Plan File
/home/david/.claude/plans/eager-riding-puddle.md

## Session 1 - Completed

### Work Completed
- [x] Add `Project::find_all_with_remote_id()` method in `crates/db/src/models/project.rs`
- [x] Add `auto_link_local_projects()` function in `crates/services/src/services/node_runner.rs`
- [x] Modify `HiveEvent::Connected` handler to call auto-link after `sync_remote_projects`
- [x] Regenerate SQLx cache for the new query
- [x] Fix clippy warning in `crates/server/src/routes/message_queue.rs`
- [x] Run cargo test and clippy (all pass)
- [x] Test in browser with Playwright

### Files Changed
1. `crates/db/src/models/project.rs` - Added `find_all_with_remote_id()` method
2. `crates/services/src/services/node_runner.rs` - Added `auto_link_local_projects()` function and integrated it into `HiveEvent::Connected` handler
3. `crates/server/src/routes/message_queue.rs` - Fixed clippy collapsible_if warning
4. `crates/db/.sqlx/*` - Regenerated SQLx cache
5. `.sqlx/*` - Updated workspace SQLx cache

### Testing Results
- Cargo build: PASS
- Cargo clippy: PASS (no warnings)
- Cargo test (db crate): PASS (all tests pass)
- Browser testing: PASS
  - Application loads correctly
  - Projects page shows 11 projects
  - Kanban board loads with tasks
  - Auto-link logged successfully: "Auto-linked project to hive project_id=c8809147... name=vibe-kanban"

### Server Logs Confirm Auto-Linking Works
```text
INFO services::services::node_runner: Auto-linked project to hive project_id=c8809147-3066-439e-9f2b-9477cb3e8bec remote_project_id=f84697be-628a-43bc-baad-3f4a412f35b2 name=vibe-kanban
INFO services::services::node_runner: Auto-linked local projects to hive linked_count=1
```

## Session 2 - Completed

### Work Completed
- [x] Review `sync_from_shared_task()` and `upsert_remote_task()` logic in `crates/db/src/models/task.rs`
- [x] Fix `is_remote` flag logic in `upsert_remote_task()` ON CONFLICT clause
- [x] Create migration `20251230032410_fix_is_remote_for_local_projects.sql` to fix existing data
- [x] Regenerate SQLx cache for the db crate
- [x] Run cargo test (93 tests pass) and clippy (no warnings)
- [x] Test in browser with Playwright (mobile, tablet, desktop, light/dark modes)

### Files Changed
1. `crates/db/src/models/task.rs` - Modified `upsert_remote_task()` ON CONFLICT clause:
   ```sql
   -- Only set is_remote=1 if the task is already remote (don't overwrite local tasks)
   is_remote = CASE WHEN tasks.is_remote = 0 THEN 0 ELSE excluded.is_remote END,
   ```
2. `crates/db/migrations/20251230032410_fix_is_remote_for_local_projects.sql` - Migration to fix existing incorrectly-marked tasks
3. `.sqlx/query-7cd286bbb3521a7311cfced3733696c678210cbfb38eea7730d100e6828609ef.json` - New SQLx cache file
4. `.sqlx/query-c2067d978cdecab4f78eec00998ea9edc2b54a0e33a8ce41d70ad41802eb7183.json` - Deleted (old cache)

### Bug Fixed
**Issue**: Tasks belonging to local projects (where `projects.is_remote = 0`) were being incorrectly marked as `is_remote = 1` when synced from the hive.

**Root Cause**: In `upsert_remote_task()`, the ON CONFLICT clause was unconditionally setting `is_remote = excluded.is_remote`, which would overwrite a local task's `is_remote = 0` with `is_remote = 1`.

**Fix**: Modified the ON CONFLICT clause to preserve `is_remote = 0` for existing local tasks:
```sql
is_remote = CASE WHEN tasks.is_remote = 0 THEN 0 ELSE excluded.is_remote END
```

**Migration**: Created a migration that resets `is_remote = 0` for all tasks that belong to local projects (where the project has `is_remote = 0` and `remote_project_id IS NOT NULL`).

### Testing Results
- Cargo test (db crate): PASS - 93 tests passed
- Cargo clippy: PASS - No warnings
- Browser testing: PASS
  - Desktop (1280px): All pages load correctly, no console errors
  - Tablet (768px): Responsive layout works correctly
  - Mobile (375px): Mobile layout functions properly
  - Light mode: Text contrast is good, all elements visible
  - Dark mode: Text contrast is good, no light-on-light or dark-on-dark issues
  - Settings page: Theme switching works correctly
  - Kanban board: Tasks display properly with correct status

## Session 3 - Completed

### Work Completed
- [x] Add `LabelSyncMessage` struct to `crates/services/src/services/hive_client.rs`
- [x] Add `LabelSync` variant to `NodeMessage` enum in `crates/services/src/services/hive_client.rs`
- [x] Add `max_labels_per_batch` config field to `HiveSyncConfig` in `crates/services/src/services/hive_sync.rs`
- [x] Add `sync_labels()` method to `HiveSyncService` in `crates/services/src/services/hive_sync.rs`
- [x] Integrate `sync_labels()` into the `sync_once()` sync loop
- [x] Run cargo build (release mode): PASS
- [x] Run cargo clippy: PASS (no warnings)
- [x] Run frontend TypeScript check: PASS

### Files Changed
1. `crates/services/src/services/hive_client.rs`:
   - Added `LabelSyncMessage` struct with fields:
     - `label_id: Uuid` - Local label ID
     - `shared_label_id: Option<Uuid>` - Shared label ID on Hive (None for new labels)
     - `project_id: Option<Uuid>` - Project ID if project-specific
     - `remote_project_id: Option<Uuid>` - Remote project ID for linking on hive side
     - `name: String` - Label name
     - `icon: String` - Lucide icon name
     - `color: String` - Hex color code
     - `version: i64` - Version for conflict resolution
     - `is_update: bool` - Whether this is an update vs new label
   - Added `LabelSync(LabelSyncMessage)` variant to `NodeMessage` enum

2. `crates/services/src/services/hive_sync.rs`:
   - Added `max_labels_per_batch: i64` field to `HiveSyncConfig` (default: 50)
   - Added `sync_labels()` method that:
     - Queries `Label::find_unsynced()` for new labels
     - Queries `Label::find_modified_since_sync()` for updated labels
     - Combines and deduplicates labels to sync
     - Looks up project to get `remote_project_id` for project-specific labels
     - Sends `LabelSyncMessage` for each label
     - Marks labels as synced after successful send
   - Updated `sync_once()` to call `sync_labels()` after `sync_logs()`
   - Added new imports for `Label`, `Project`, `LabelSyncMessage`, and `info` tracing macro

### Testing Results
- Cargo build (release): PASS
- Cargo clippy: PASS - No warnings
- TypeScript check: PASS
- DB tests: PASS (all tests)
- Note: Full integration test was not possible due to disk space constraints (worktree build exceeds /var/tmp capacity)

### Implementation Details

**Label Sync Flow (Node to Hive)**:
1. Every sync interval (5 seconds), `sync_once()` calls `sync_labels()`
2. `sync_labels()` finds:
   - New labels: `shared_label_id IS NULL`
   - Modified labels: `updated_at > synced_at`
3. For each label, constructs `LabelSyncMessage` with:
   - `is_update = false` for new labels
   - `is_update = true` for modified labels
   - `remote_project_id` looked up from project if label is project-specific
4. Sends `NodeMessage::LabelSync(message)` to hive via WebSocket
5. Marks labels as synced with `Label::mark_synced()`

**Note**: This implements the node-side of label sync. The hive-side handler (Session 4) will:
- Receive the `LabelSync` message
- Store/update in shared labels table
- Send back `shared_label_id` for new labels
- Broadcast to other nodes in the organization

## Remaining Work (Session 4+)
- [ ] Session 4: Label sync on hive side (handle incoming label sync, store in shared_labels table, broadcast to other nodes)
- [ ] Session 5: Task execution sync enhancement
- [ ] Session 6: Integration testing
- [ ] Session 7: Documentation updates

## Next Session Recommendations
1. Implement hive-side label sync handler in `crates/remote/src/nodes/ws/session.rs`:
   - Handle `NodeMessage::LabelSync` message
   - Create/update shared labels in hive database
   - Respond with `shared_label_id` for new labels
   - Broadcast label changes to other nodes in the organization
2. Create `SharedLabel` model in `crates/remote/src/db/` if needed
3. Add migration for shared_labels table in hive database if needed
