# Markdown Rendering Fixes

## Status: needs-review

## Completed Items

- [x] Created `markdown-preprocessor.ts` to escape mid-word underscores
- [x] Integrated preprocessor into `MarkdownRenderer` component
- [x] Updated heading styles (h1-h6) for proper visual hierarchy
- [x] Fixed FileViewDialog prose-sm overriding custom styles
- [x] Fixed inline code font size (relative sizing instead of fixed)
- [x] ESLint passes: `cd frontend && npm run lint`
- [x] TypeScript passes: `cd frontend && npx tsc --noEmit`

## Changes Made

### Problem 1: Poor Heading Hierarchy (FIXED - Session 1)
**Before:**
- h1: `text-lg` (18px) - only 2px larger than body
- h2: `text-base` (14px) - same size as body
- h3: `text-sm` (12px) - smaller than body

**After:**
- h1: `text-xl font-semibold` (20px)
- h2: `text-lg font-semibold` (18px)
- h3: `text-base font-semibold` (14px)
- h4: `text-base font-medium` (14px)
- h5: `text-sm font-semibold` (12px)
- h6: `text-sm font-medium` (12px)

### Problem 2: Underscore Italic Misinterpretation (FIXED - Session 1)
Variable names like `connection_token_service` were rendering with middle words italicized because markdown interprets `_word_` as italic.

**Solution:** Created `preprocessMarkdown()` function that:
- Escapes underscores preceded by word characters (`snake_case` -> `snake\_case`)
- Preserves underscores in code blocks (fenced and inline)
- Preserves underscores in URLs
- Preserves intentional italics (` _italic_` with leading space)

### Problem 3: FileViewDialog prose-sm Override (FIXED - Session 2)
The FileViewDialog (used for viewing .claude/plans files) was passing `className="prose prose-sm dark:prose-invert max-w-none"` to MarkdownRenderer. The Tailwind Typography `prose-sm` class was overriding all custom heading/list styles with smaller sizes.

**Solution:** Removed `prose prose-sm dark:prose-invert` from FileViewDialog, keeping only `max-w-none`. The custom element overrides in MarkdownRenderer now properly control typography.

### Problem 4: Inline Code Too Small (FIXED - Session 2)
Inline code was using `text-sm` which is a fixed 14px size, making code smaller than surrounding text.

**Solution:** Changed to `text-[0.9em]` which is 90% of parent font size (relative sizing). This ensures inline code is slightly smaller but scales with context.

## Files Changed

| File | Action |
|------|--------|
| `frontend/src/components/ui/markdown-preprocessor.ts` | **Created** (Session 1) |
| `frontend/src/components/ui/markdown-renderer.tsx` | **Modified** (Session 1 & 2) |
| `frontend/src/components/dialogs/shared/FileViewDialog.tsx` | **Modified** (Session 2) |

## Commits

```text
fd557d1b fix: improve markdown heading hierarchy and prevent underscore italics
[pending] fix: remove prose-sm override in FileViewDialog and use relative code sizing
```

## Next Steps

1. Commit the Session 2 changes
2. Update PR #83 with the additional fixes
3. Merge after approval
