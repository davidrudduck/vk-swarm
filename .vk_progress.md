# Unified Project View with Sorting - Progress Tracker

## Status: needs-review

## Pull Request
https://github.com/davidrudduck/vibe-kanban/pull/88

## Overview
Merge local and remote projects into a single unified view with sorting options, and remove the Active Tasks banner.

## Completed Items

### Session 1: Backend - MergedProject Endpoint ✅
- [x] Added `MergedProject` struct with `#[derive(TS)]` in `crates/server/src/routes/projects.rs`
  - Includes: `id`, `name`, `git_repo_path`, `created_at`, `remote_project_id`, `has_local`, `local_project_id`, `nodes`, `last_attempt_at`
- [x] Added `NodeLocation` struct with `#[derive(TS)]`
  - Includes: `node_id`, `node_name`, `node_short_name`, `node_status`, `node_public_url`, `remote_project_id`
- [x] Added `MergedProjectsResponse` wrapper struct
- [x] Added `find_local_projects_with_last_attempt()` query in `crates/db/src/models/project.rs`
  - Uses LEFT JOIN to task_attempts to get MAX(updated_at) as last_attempt_at
  - Returns `Vec<(Project, Option<DateTime<Utc>>)>`
- [x] Created `get_merged_projects()` route handler with merging logic:
  - Fetches local projects with last attempt timestamps
  - Fetches remote projects from cached_projects
  - Fetches node information from cached_nodes
  - Groups linked projects by remote_project_id
  - Creates MergedProject entries with correct location info
  - Adds `truncate_node_name()` helper (e.g., "tardis.raverx.net" → "tardis")
- [x] Registered route: `GET /api/merged-projects`
- [x] Updated `crates/server/src/bin/generate_types.rs` with new type declarations
- [x] Updated SQLx offline cache (`npm run prepare-db`)
- [x] Ran `npm run generate-types` to create TypeScript types in `shared/types.ts`
- [x] Tested endpoint with curl - returns correct merged project structure

### Session 2: Frontend - UnifiedProjectCard Component ✅
- [x] Created `UnifiedProjectCard.tsx` with props for `MergedProject`
  - Accepts `project: MergedProject`, `isFocused`, `onRefresh`, `onEdit` props
- [x] Implemented card layout: name, linked badge, menu, date, location badges
  - Card displays project name, created date with calendar icon
  - "Linked" badge shown when `remote_project_id` is set (with dark mode support)
  - Dropdown menu with context-sensitive actions
- [x] Implemented location badge logic
  - Shows "local" badge when `has_local` is true
  - Shows node short names for remote locations
  - Map pin icon with gray styling
- [x] Implemented conditional actions menu based on `has_local`
  - Local projects: View, Open in IDE, Link to Remote, Edit Settings, Delete
  - Remote-only projects: View, Link to Local Folder
- [x] Created `useMergedProjects.ts` hook for fetching merged projects
- [x] Added `getMerged()` method to `projectsApi` in `lib/api.ts`
- [x] Added `linkToLocalFolder` translation key to all locales (en, ja, ko, es)
- [x] Added temporary test section in `ProjectList.tsx` for Session 2 verification
- [x] Tested in browser with Playwright:
  - Verified rendering at desktop (1280x720), tablet (768x1024), mobile (375x667) viewports
  - Verified dropdown menu actions for local projects
  - Verified light and dark mode styling

### Session 3: Frontend - ProjectSortControls & ProjectList Update ✅
- [x] Created `ProjectSortControls.tsx` dropdown component
  - Four sort options: A→Z, Z→A, Recent Activity, Oldest Activity
  - Icons for each option (ArrowDownAZ, ArrowUpZA, Clock, History)
  - Uses shadcn/ui Select component
- [x] Added localStorage persistence for sort option
  - Key: `project-sort-option`
  - Default: `name_asc`
  - `loadSortOption()` and `saveSortOption()` helper functions
- [x] Added i18n translation keys for sorting in all locales (en, ja, ko, es)
  - `sort.label`, `sort.nameAsc`, `sort.nameDesc`, `sort.recentActivity`, `sort.oldestActivity`
  - Added `sections.allProjects` key
- [x] Updated `ProjectList.tsx`:
  - Removed `StatusSummaryBanner` component and import
  - Removed separate local/remote project sections
  - Now fetches from `/api/merged-projects` using `useMergedProjects` hook
  - Added sorting controls next to "All Projects (N)" header
  - Uses `UnifiedProjectCard` for all projects
  - Implemented client-side sorting logic for all 4 options
  - Projects with no `last_attempt_at` sort to bottom for activity-based sorts
- [x] Tested in browser with Playwright:
  - Verified at desktop (1280x720), tablet (768x1024), mobile (375x667) viewports
  - Verified sort dropdown opens and shows all 4 options
  - Verified localStorage persistence - sort option persists after page refresh
  - Verified light and dark mode styling - all text readable
  - No console errors, no TypeScript errors

### Session 4: Frontend - "Link to Local Folder" Action ✅
- [x] Created backend endpoint `POST /api/projects/link-local`
  - Added `LinkToLocalFolderRequest` struct with `remote_project_id`, `local_folder_path`, `project_name`
  - Validates path exists and is a git repository
  - Creates local project or links existing one
  - Links to remote project via `apply_remote_project_link`
- [x] Added type to `generate_types.rs` and regenerated TypeScript types
- [x] Created `LinkToLocalFolderDialog.tsx` component
  - Uses NiceModal pattern with `defineModal`
  - Folder picker with `FolderPickerDialog`
  - Form fields: local folder path (required), project name (optional)
  - Displays remote project name being linked
- [x] Added `linkLocalFolder` method to `projectsApi` in `lib/api.ts`
- [x] Added `linkLocalFolder` mutation to `useProjectMutations.ts`
  - With `onLinkLocalFolderSuccess` and `onLinkLocalFolderError` callbacks
  - Invalidates `mergedProjects` and `unifiedProjects` query caches
- [x] Added i18n translation keys for `linkToLocalFolderDialog` section
- [x] Wired up action in `UnifiedProjectCard.tsx` for remote-only projects
- [x] Tested in browser with Playwright:
  - Verified at desktop (1280x800), tablet (768x1024), mobile (375x667) viewports
  - Verified dropdown menu shows all expected actions
  - Verified light and dark mode styling - all text readable
  - Console warnings are pre-existing (PostHog, React Router future flags)

## Files Modified in Session 4

| File | Change |
|------|--------|
| `crates/server/src/routes/projects.rs` | Added `LinkToLocalFolderRequest` struct and `link_to_local_folder` handler |
| `crates/server/src/bin/generate_types.rs` | Added `LinkToLocalFolderRequest` type generation |
| `frontend/src/lib/api.ts` | Added `linkLocalFolder` API method |
| `frontend/src/hooks/useProjectMutations.ts` | Added `linkLocalFolder` mutation with callbacks |
| `frontend/src/components/dialogs/projects/LinkToLocalFolderDialog.tsx` | Created new dialog component |
| `frontend/src/components/projects/UnifiedProjectCard.tsx` | Wired up LinkToLocalFolderDialog for remote-only projects |
| `frontend/src/i18n/locales/en/projects.json` | Added `linkToLocalFolderDialog` translation keys |

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/merged-projects` | Get unified list of local and remote projects |
| POST | `/api/projects/link-local` | Create local project and link to remote project |

## API Response Example
```json
{
  "success": true,
  "data": {
    "projects": [
      {
        "id": "c8809147-3066-439e-9f2b-9477cb3e8bec",
        "name": "vibe-kanban",
        "git_repo_path": "/home/david/Code/vibe-kanban",
        "created_at": "2025-11-28T03:41:40.239Z",
        "remote_project_id": null,
        "has_local": true,
        "local_project_id": "c8809147-3066-439e-9f2b-9477cb3e8bec",
        "nodes": [],
        "last_attempt_at": "2025-12-17T06:03:03Z"
      }
    ]
  }
}
```

## Summary

All 4 sessions of the unified project view feature are now complete:
1. **Session 1**: Backend merged projects endpoint
2. **Session 2**: UnifiedProjectCard component
3. **Session 3**: Sort controls and ProjectList integration
4. **Session 4**: Link to Local Folder action

The feature allows users to:
- View all local and remote projects in a unified list
- Sort projects by name (A-Z, Z-A) or activity (recent, oldest)
- See which projects are linked to remote organizations
- Link local projects to remote projects
- Link remote-only projects to local folders
