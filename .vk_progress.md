# Open Terminal Feature - Implementation Progress

## Status: in-progress

## Overview
Adding an in-browser terminal that can be opened in:
1. Project root folder (from Project cards/details)
2. Worktree folder (from Task Attempt actions)

This is a web-based terminal rendered with xterm.js, connected to a backend PTY/shell session.

## Session 1: Backend - Terminal Session Manager ✅

### Completed Items
- [x] Added `portable-pty = "0.8"` dependency to `crates/services/Cargo.toml`
- [x] Created `crates/services/src/services/terminal_session.rs`
- [x] Implemented `TerminalSessionManager` with:
  - `detect_tmux()` - Check if tmux binary is available
  - `generate_session_id(path)` - Deterministic session ID from path (SHA256)
  - `create_session(path)` - Create tmux or PTY-based session
  - `write_to_session(id, data)` - Write data to session
  - `resize_session(id, cols, rows)` - Resize terminal dimensions
  - `kill_session(id)` - Kill and cleanup session
  - `subscribe(id)` - Get broadcast receiver for session output
  - `list_sessions()` - List all active sessions
  - `get_session(id)` - Get session info
  - `attach_session(id)` - Reattach to existing tmux session
- [x] Implemented dual-mode backend:
  - **Tmux mode** (preferred): Persistent sessions that survive page refresh
  - **PTY fallback**: Ephemeral sessions when tmux unavailable
- [x] Added session output broadcasting via `tokio::sync::broadcast`
- [x] Registered module in `services/mod.rs`
- [x] All 17 unit tests passing
- [x] Clippy passes with no warnings

### Files Changed
| File | Change |
|------|--------|
| `crates/services/Cargo.toml` | Added `portable-pty = "0.8"` dependency |
| `crates/services/src/services/mod.rs` | Added `pub mod terminal_session;` |
| `crates/services/src/services/terminal_session.rs` | New file with TerminalSessionManager implementation |

### Test Results
```text
running 17 tests
test services::terminal_session::tests::test_detect_tmux_available ... ok
test services::terminal_session::tests::test_generate_session_id ... ok
test services::terminal_session::tests::test_get_session_not_found ... ok
test services::terminal_session::tests::test_list_sessions_empty ... ok
test services::terminal_session::tests::test_manager_clone ... ok
test services::terminal_session::tests::test_manager_initialization ... ok
test services::terminal_session::tests::test_create_duplicate_session ... ok
test services::terminal_session::tests::test_session_exists ... ok
test services::terminal_session::tests::test_session_id_is_deterministic ... ok
test services::terminal_session::tests::test_session_info_serialization ... ok
test services::terminal_session::tests::test_session_not_found ... ok
test services::terminal_session::tests::test_create_session_in_directory ... ok
test services::terminal_session::tests::test_terminal_error_display ... ok
test services::terminal_session::tests::test_kill_session ... ok
test services::terminal_session::tests::test_resize_session ... ok
test services::terminal_session::tests::test_write_to_session ... ok
test services::terminal_session::export_bindings_sessioninfo ... ok

test result: ok. 17 passed; 0 failed; 0 ignored
```

### API Summary
```rust
pub struct TerminalSessionManager {
    sessions: DashMap<String, Arc<RwLock<TerminalSession>>>,
    use_tmux: bool,
    tmux_path: Option<PathBuf>,
}

impl TerminalSessionManager {
    pub fn new() -> Self;
    pub async fn init(&mut self) -> &mut Self;
    pub async fn detect_tmux() -> bool;
    pub fn generate_session_id(path: &Path) -> String;
    pub async fn create_session(&self, working_dir: &Path) -> Result<String, TerminalError>;
    pub async fn write_to_session(&self, session_id: &str, data: &[u8]) -> Result<(), TerminalError>;
    pub async fn resize_session(&self, session_id: &str, cols: u16, rows: u16) -> Result<(), TerminalError>;
    pub async fn kill_session(&self, session_id: &str) -> Result<(), TerminalError>;
    pub async fn subscribe(&self, session_id: &str) -> Result<broadcast::Receiver<TerminalOutput>, TerminalError>;
    pub async fn list_sessions(&self) -> Vec<SessionInfo>;
    pub async fn get_session(&self, session_id: &str) -> Option<SessionInfo>;
    pub fn session_exists(&self, session_id: &str) -> bool;
    pub fn session_count(&self) -> usize;
    pub fn is_using_tmux(&self) -> bool;
    pub async fn attach_session(&self, session_id: &str) -> Result<(), TerminalError>;
}
```

## Session 2: Backend - WebSocket Route ✅

### Completed Items
- [x] Created `crates/server/src/routes/terminal.rs`
- [x] Implemented REST endpoints:
  - `POST /api/terminal/sessions` - Create a new terminal session
  - `GET /api/terminal/sessions` - List all active sessions
  - `GET /api/terminal/sessions/{session_id}` - Get session info
  - `DELETE /api/terminal/sessions/{session_id}` - Kill a session
- [x] Implemented WebSocket endpoint:
  - `WS /api/terminal/ws/{session_id}` - Bidirectional terminal I/O
- [x] Defined WebSocket message types:
  - `Input { data: String }` - Client to server input
  - `Resize { cols: u16, rows: u16 }` - Terminal resize
  - `Output { data: String }` - Server to client output
  - `Exit { code: Option<i32> }` - Session exit notification
  - `Error { message: String }` - Error messages
- [x] Added `tokio-stream` dependency for broadcast stream conversion
- [x] Created `TerminalState` with its own `TerminalSessionManager`
- [x] Registered terminal routes in `routes/mod.rs`
- [x] Made router function async to support terminal state initialization
- [x] Updated `main.rs` to await router initialization
- [x] Added TypeScript type exports for terminal types
- [x] All tests passing (server: 23 tests, workspace: all pass)
- [x] Clippy passes with no warnings
- [x] Manual API testing confirmed all endpoints work

### Files Changed
| File | Change |
|------|--------|
| `crates/server/Cargo.toml` | Added `tokio-stream = "0.1"` dependency |
| `crates/server/src/routes/mod.rs` | Added `pub mod terminal;`, made `router()` async, merged terminal routes |
| `crates/server/src/routes/terminal.rs` | New file with REST + WebSocket handlers |
| `crates/server/src/main.rs` | Updated to await router initialization |
| `crates/server/src/bin/generate_types.rs` | Added terminal type exports |
| `shared/types.ts` | Auto-generated terminal types |

### Test Results
```text
Server tests:
test routes::terminal::export_bindings_createsessionresponse ... ok
test routes::terminal::export_bindings_terminalmessage ... ok
test routes::terminal::tests::test_create_session_response_serialization ... ok
test routes::terminal::tests::test_terminal_message_deserialization ... ok
test routes::terminal::tests::test_terminal_message_serialization ... ok

test result: ok. 23 passed; 0 failed; 0 ignored

Workspace tests: All passing
```

### API Endpoints

**REST API:**
- `POST /api/terminal/sessions` - Create session
  - Body: `{ "working_dir": "/path/to/dir" }`
  - Response: `{ "session_id": "vk-abc12345", "session": SessionInfo }`

- `GET /api/terminal/sessions` - List sessions
  - Response: `SessionInfo[]`

- `GET /api/terminal/sessions/{session_id}` - Get session
  - Response: `SessionInfo`

- `DELETE /api/terminal/sessions/{session_id}` - Delete session
  - Response: `null`

**WebSocket API:**
- `WS /api/terminal/ws/{session_id}` - Terminal I/O
  - Client → Server: `{ "type": "input", "data": "ls\n" }`
  - Client → Server: `{ "type": "resize", "cols": 120, "rows": 40 }`
  - Server → Client: `{ "type": "output", "data": "..." }`
  - Server → Client: `{ "type": "exit", "code": 0 }`
  - Server → Client: `{ "type": "error", "message": "..." }`

### Generated TypeScript Types
```typescript
export type SessionInfo = {
  id: string,
  working_dir: string,
  is_tmux: boolean,
  cols: number,
  rows: number,
  active: boolean,
};

export type CreateSessionResponse = {
  session_id: string,
  session: SessionInfo,
};

export type TerminalMessage =
  | { "type": "input", data: string }
  | { "type": "resize", cols: number, rows: number }
  | { "type": "output", data: string }
  | { "type": "exit", code: number | null }
  | { "type": "error", message: string };
```

## Session 3: Frontend - xterm.js Component ✅

### Completed Items
- [x] Added `@xterm/xterm` and `@xterm/addon-fit` dependencies
- [x] Created `frontend/src/hooks/useTerminalWebSocket.ts` hook
  - WebSocket connection management with reconnection
  - Exponential backoff retry logic
  - Connection state tracking (connecting, connected, disconnected, error)
  - Input/Resize message sending
- [x] Created `frontend/src/hooks/useTerminalSession.ts` hook
  - React Query mutations for session CRUD
  - createSession, deleteSession mutations
  - Session query for fetching session info
- [x] Created `frontend/src/components/terminal/TerminalView.tsx`
  - xterm.js Terminal initialization with Tokyo Night theme
  - FitAddon for responsive resizing
  - ResizeObserver for automatic dimension updates
  - Connection status overlay
  - Keyboard input handling
- [x] Created `frontend/src/components/terminal/TerminalContainer.tsx`
  - Session creation on mount
  - Loading/error states
  - Session lifecycle management
- [x] Added `terminalApi` to `frontend/src/lib/api.ts`
- [x] Created test page at `/terminal-test` route
- [x] Fixed backend session reuse (returns existing session instead of 409)
- [x] Fixed PTY implementation using `portable-pty` crate
- [x] Tested across viewports: mobile (375x667), tablet (768x1024), desktop (1280x800)
- [x] Tested in dark mode and light mode

### Files Changed
| File | Change |
|------|--------|
| `frontend/package.json` | Added `@xterm/xterm`, `@xterm/addon-fit` |
| `frontend/src/hooks/useTerminalWebSocket.ts` | New file - WebSocket hook |
| `frontend/src/hooks/useTerminalSession.ts` | New file - Session mutations hook |
| `frontend/src/components/terminal/TerminalView.tsx` | New file - Terminal component |
| `frontend/src/components/terminal/TerminalContainer.tsx` | New file - Session container |
| `frontend/src/components/terminal/index.ts` | New file - Exports |
| `frontend/src/lib/api.ts` | Added terminalApi |
| `frontend/src/App.tsx` | Added /terminal-test route |
| `frontend/src/pages/TerminalTest.tsx` | New file - Test page |
| `crates/server/src/routes/terminal.rs` | Fixed session reuse on create |
| `crates/services/src/services/terminal_session.rs` | Fixed PTY implementation |

### Test Results
- Desktop (1280x800): ✅ Terminal renders, commands execute, output displays
- Tablet (768x1024): ✅ Terminal responsive, fits container
- Mobile (375x667): ✅ Terminal usable on small screens
- Dark mode: ✅ Tokyo Night theme, light text on dark background
- Light mode: ✅ Terminal maintains dark theme within light app

### Screenshots
- `terminal-dark-mode-with-output.png` - Terminal in dark mode showing ls -la output
- `terminal-light-mode-with-output.png` - Terminal in light mode showing echo output

### Technical Notes
1. **Session Reuse**: Modified `create_session` to return existing session ID instead of 409 error - enables seamless reconnection after page refresh
2. **PTY Implementation**: Switched from tokio::process to portable-pty for proper TTY allocation - fixes shell immediate exit issue
3. **Tmux Mode**: Temporarily disabled due to pipe-pane output capture issues - will revisit in future session
4. **Terminal Theme**: Uses Tokyo Night color scheme hardcoded in TerminalView - future enhancement could make this configurable

## Remaining Sessions

### Session 4: Frontend - UI Integration
- [ ] Add terminal button to Navbar
- [ ] Add terminal toggle to AttemptHeaderActions
- [ ] Add 'terminal' mode to ProjectTasks
- [ ] Render TerminalView when mode is terminal

### Session 5: Frontend - Tabbed Interface
- [ ] Create TerminalsPanel component
- [ ] Create useTerminalTabs hook
- [ ] Support multiple terminal tabs
- [ ] Add/close terminal tabs

### Session 6: Session Persistence & Reconnection
- [ ] GET /api/terminal/sessions endpoint
- [ ] Auto-reconnect to existing sessions
- [ ] Reconnection UI indicator

### Session 7: Mobile & Polish
- [ ] Swipe gesture support
- [ ] Connection error UI
- [ ] Terminal settings
- [ ] Mobile device testing

### Session 8: Integration Testing & Cleanup
- [ ] E2E tests for terminal functionality
- [ ] Code cleanup
- [ ] Documentation update

## Next Steps
1. Add terminal button to Navbar for opening project terminal
2. Add terminal toggle to AttemptHeaderActions for task worktree terminal
3. Integrate TerminalView into the main app UI
4. Consider tabbed terminal interface for multiple sessions
