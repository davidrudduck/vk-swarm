# Git Functions Implementation Progress

## Current Status: needs-review

## Phase 4: PR Auto-Discovery (Session 8)

### Completed Items
- [x] Synced with origin/main and resolved merge conflicts
- [x] Fixed TypeScript compilation errors after merge (LinkProjectDialog removal)
- [x] Implemented `find_active_without_pr()` query in task_attempt model
- [x] Implemented `discover_new_prs()` method in pr_monitor.rs
- [x] Implemented `discover_pr_for_attempt()` method to query GitHub for PRs on branches
- [x] Integrated PR discovery into the monitoring loop (runs before checking existing PRs)
- [x] Created comprehensive test suite in `crates/services/tests/pr_discovery.rs` (4 tests)
- [x] All 4 PR discovery tests passing
- [x] Clippy passes with no errors
- [x] Cargo fmt passes
- [x] Browser tested in mobile, tablet, and desktop viewports
- [x] Browser tested in light and dark modes
- [x] No console errors

### Files Changed (Session 8)
1. `crates/db/src/models/task_attempt.rs` - Added `find_active_without_pr()` query
2. `crates/services/src/services/pr_monitor.rs` - Added PR discovery methods
3. `crates/services/tests/pr_discovery.rs` - New test file with 4 tests
4. `frontend/src/components/dialogs/index.ts` - Removed LinkProjectDialog export (merge fix)
5. `frontend/src/hooks/useProjectMutations.ts` - Added stub mutations (merge fix)
6. `.vk_progress.md` - Updated progress

### Test Results (Session 8)
```text
running 4 tests
test test_find_active_attempts_without_pr_returns_untracked ... ok
test test_find_active_attempts_with_pr_excluded ... ok
test test_find_active_attempts_excludes_done_tasks ... ok
test test_find_active_attempts_includes_in_progress_and_review ... ok

test result: ok. 4 passed; 0 failed
```

### How PR Auto-Discovery Works
1. The PR monitor runs every 60 seconds
2. First, it calls `discover_new_prs()` to find task attempts that:
   - Are for tasks NOT in done/cancelled status
   - Belong to GitHub-enabled projects
   - Don't already have a PR merge record
3. For each discovered attempt, it queries GitHub for PRs on that branch
4. If a PR is found, it creates a merge record in the database
5. If the PR is already merged, it also updates the task status to done
6. Then, the monitor checks existing open PRs for status updates (existing behavior)

### Browser Testing Results (Session 8)
- ✅ Mobile (375x812): Dark mode - UI renders correctly
- ✅ Tablet (768x1024): Dark mode - Layout correct
- ✅ Desktop (1280x800): Dark mode - Full layout, all features accessible
- ✅ Desktop light mode: Settings page with correct contrast
- ✅ Kanban board dark mode: Task cards readable, labels visible
- ✅ No console errors (only pre-existing React Router v7 warnings)

---

## Phase 3: GitHub Integration Final Testing (Session 7)

### Completed Items
- [x] Merged with origin/main and resolved all conflicts
- [x] Regenerated SQLx cache (~150 files) after schema changes
- [x] Updated Project model to remove deprecated `default_validation_steps` field
- [x] Regenerated TypeScript types with GitHub fields
- [x] End-to-end testing with real GitHub repo (anthropics/claude-code)
- [x] Verified GitHub sync: 30 issues, 30 PRs fetched successfully
- [x] Browser tested in mobile (375px), tablet (768px), desktop (1280px)
- [x] Browser tested in light and dark modes - all badges visible with correct contrast
- [x] No console errors (only pre-existing React Router v7 warnings)

### Files Changed (Session 7)
1. `crates/db/src/models/project.rs` - Removed deprecated field, kept GitHub integration
2. `crates/db/.sqlx/*.json` - Regenerated ~150 SQLx query cache files
3. `shared/types.ts` - Regenerated with updated schema
4. `.vk_progress.md` - Updated progress

### Testing Results (Session 7)
- ✅ Merge conflict resolution: Successfully merged origin/main
- ✅ Build: Passes with `SQLX_OFFLINE=true`
- ✅ GitHub sync: anthropics/claude-code returns 30 issues, 30 PRs
- ✅ Mobile (375px) dark mode: GitHub badges visible, good contrast
- ✅ Desktop (1280px) dark mode: Full layout, badges prominent
- ✅ Desktop (1280px) light mode: Full layout, badges with correct colors
- ✅ No console errors (only React Router v7 deprecation warnings)

### Screenshots (Session 7)
- `github-badges-dark-mode-desktop.png` - Desktop dark mode with GitHub badges
- `github-badges-dark-mode-mobile.png` - Mobile dark mode with GitHub badges
- `github-badges-light-mode-desktop.png` - Desktop light mode with GitHub badges

### Notes
- Background sync service infrastructure exists but is not started automatically in main.rs (would require architecture decision on spawn location)
- PR Auto-Discovery (Phase 4) deferred to future session
- Code is merge-ready - all tests pass, no lint errors

---

## Phase 3: GitHub Integration Frontend (Session 6)

### Completed Items
- [x] Create GitHubSettingsDialog component (NiceModal pattern)
- [x] Add toggle/form to project settings (enable/disable, owner, repo fields)
- [x] Display badge with counts in project list/header (GitHubBadges component)
- [x] Implement manual sync button with loading state
- [x] Add API client methods for GitHub integration (setGitHubEnabled, getGitHubCounts, syncGitHubCounts)
- [x] Add i18n strings for GitHub integration (all labels, errors, success messages)
- [x] Update MergedProject type with GitHub fields for UnifiedProjectCard
- [x] Add "Open Terminal" and "GitHub Settings" menu items to project card dropdown
- [x] Browser tested in mobile (375px), tablet (768px), desktop (1280px)
- [x] Browser tested in light and dark modes
- [x] No console errors

### Files Changed (Session 6)
1. `frontend/src/lib/api.ts` - Added setGitHubEnabled, getGitHubCounts, syncGitHubCounts methods
2. `frontend/src/i18n/locales/en/projects.json` - Added GitHub i18n strings
3. `frontend/src/components/dialogs/projects/GitHubSettingsDialog.tsx` - New dialog component
4. `frontend/src/components/projects/GitHubBadges.tsx` - New badge component
5. `frontend/src/components/projects/UnifiedProjectCard.tsx` - Added GitHub badges and menu items
6. `frontend/src/components/projects/ProjectCard.tsx` - Added GitHub badges and menu items (duplicate, not used)
7. `frontend/src/components/dialogs/index.ts` - Exported GitHubSettingsDialog
8. `crates/server/src/routes/projects.rs` - Added GitHub fields to MergedProject struct
9. `shared/types.ts` - Regenerated with MergedProject GitHub fields

### Testing Results (Session 6)
- ✅ Mobile (375px): Dropdown menu shows all 7 items, GitHub badges visible
- ✅ Tablet (768px): Layout and badges correct
- ✅ Desktop (1280px): Full layout, all features accessible
- ✅ Light mode: Badge colors correct (blue for issues, green for PRs)
- ✅ Dark mode: Badge colors adapt with dark theme classes
- ✅ GitHub Settings dialog: Toggle, owner/repo inputs, save/cancel work
- ✅ No console errors (only pre-existing React Router v7 warnings)

---

## Phase 3: GitHub Integration Backend (Session 5)

### Completed Items
- [x] Create database migration for GitHub integration fields (`20251225211019_add_github_integration.sql`)
- [x] Update Project model with new fields (github_enabled, github_owner, github_repo, github_open_issues, github_open_prs, github_last_synced_at)
- [x] Update all SQL queries in Project model to include new fields
- [x] Add new database methods: find_github_enabled(), update_github_counts(), set_github_enabled()
- [x] Implement get_repo_counts() in GhCli (cli.rs) - returns RepoCounts struct
- [x] Add get_repo_counts() method to GitHubService (github.rs) with retry logic
- [x] Create github_sync.rs service for background polling
- [x] Add sync_single_project() function for on-demand syncing
- [x] Create API endpoints: POST /projects/{id}/github, GET /projects/{id}/github/counts, POST /projects/{id}/github/sync
- [x] Regenerate SQLx query cache for db package
- [x] Generate TypeScript types with new fields
- [x] Fix clippy warnings (needless borrow, large enum variant)
- [x] Verify compilation passes

### Files Changed (Session 5)
1. `crates/db/migrations/20251225211019_add_github_integration.sql` - New migration
2. `crates/db/src/models/project.rs` - Added GitHub fields and methods
3. `crates/db/.sqlx/*.json` - Updated SQLx query cache
4. `crates/services/src/services/github.rs` - Added get_repo_counts() method
5. `crates/services/src/services/github/cli.rs` - Added RepoCounts struct and get_repo_counts()
6. `crates/services/src/services/github_sync.rs` - New background sync service
7. `crates/services/src/services/mod.rs` - Added github_sync module
8. `crates/server/src/routes/projects.rs` - Added GitHub integration endpoints
9. `shared/types.ts` - Regenerated with new Project fields

### API Endpoints Created

#### POST /api/projects/{id}/github
Enable/disable GitHub integration for a project.
```typescript
Request: { enabled: boolean, owner?: string, repo?: string }
Response: ApiResponse<Project>
```

#### GET /api/projects/{id}/github/counts
Get current cached GitHub counts for a project.
```typescript
Response: ApiResponse<{ open_issues: number, open_prs: number, last_synced_at: Date | null }>
```

#### POST /api/projects/{id}/github/sync
Trigger an immediate sync of GitHub counts.
```typescript
Response: ApiResponse<{ open_issues: number, open_prs: number, last_synced_at: Date | null }>
```

---

## Phase 2: Clone Frontend Implementation (Session 4)

### Completed Items
- [x] Added "Clone from URL" option to project creation dialog
- [x] Created UI input fields for clone URL, directory, and project name
- [x] Implemented auto-fill from URL (extracts repo name)
- [x] Added progress/loading indicator during clone operation
- [x] Added error handling UI for clone failures
- [x] Added comprehensive i18n strings for clone UI
- [x] Browser testing with Playwright:
  - Desktop (1280px): Light ✓, Dark ✓
  - Tablet (768px): Dark ✓
  - Mobile (375px): Light ✓, Dark ✓
- [x] No console errors (only pre-existing React Router v7 warnings)

### Files Changed (Session 4)
1. `frontend/src/components/projects/ProjectFormFields.tsx` - Added clone mode with URL input, directory picker, auto-fill
2. `frontend/src/components/dialogs/projects/ProjectFormDialog.tsx` - Added clone state handling and submit logic
3. `frontend/src/i18n/locales/en/projects.json` - Added i18n strings for clone UI

### Screenshots
- `clone-ui-desktop-light-options.png` - All 3 options in light mode
- `clone-ui-desktop-light-form.png` - Clone form empty
- `clone-ui-desktop-light-form-filled.png` - Clone form with auto-fill
- `clone-ui-desktop-dark-options.png` - All 3 options in dark mode
- `clone-ui-desktop-dark-form.png` - Clone form in dark mode
- `clone-ui-mobile-dark-options.png` - Mobile dark mode options
- `clone-ui-mobile-dark-form.png` - Mobile dark mode form
- `clone-ui-tablet-dark-form.png` - Tablet dark mode form
- `clone-ui-mobile-light-form.png` - Mobile light mode form
- `clone-ui-mobile-light-options.png` - Mobile light mode options

---

## Phase 2: Clone Backend Implementation (Session 3)

### Completed Items
- [x] Created backend tests (TDD) in `crates/services/tests/git_clone.rs` (6 tests)
- [x] Added `CloneFailed` and `DestinationNotEmpty` error variants to `GitServiceError`
- [x] Implemented `clone()` method in `GitCli` (`crates/services/src/services/git/cli.rs`)
- [x] Implemented `clone_repo()` method in `GitService` (`crates/services/src/services/git.rs`)
- [x] Updated `CreateProject` struct with `clone_url: Option<String>` field
- [x] Updated project creation route to handle clone workflow
- [x] Generated TypeScript types with `clone_url` field
- [x] Updated frontend `ProjectFormDialog.tsx` for TypeScript compatibility
- [x] All 6 clone tests passing
- [x] Clippy passes with no errors
- [x] Browser testing with Playwright (light/dark mode, mobile/desktop)
- [x] Merged with origin/main

### Test Results (Session 3)
```text
running 6 tests
test test_clone_invalid_url_fails ... ok
test test_clone_nonexistent_repo_fails ... ok
test test_clone_to_nonempty_dir_fails ... ok
test test_clone_to_empty_dir_succeeds ... ok
test test_clone_repository_creates_repo ... ok
test test_clone_preserves_history ... ok

test result: ok. 6 passed; 0 failed
```

### Files Changed (Session 3)
1. `crates/services/src/services/git.rs` - Added `clone_repo()`, error variants
2. `crates/services/src/services/git/cli.rs` - Added `clone()` method
3. `crates/services/tests/git_clone.rs` - New test file
4. `crates/db/src/models/project.rs` - Added `clone_url` field to `CreateProject`
5. `crates/server/src/routes/projects.rs` - Handle clone in project creation
6. `crates/db/src/models/log_entry.rs` - Added `clone_url: None` to test
7. `crates/db/tests/bulk_operations.rs` - Added `clone_url: None` to tests
8. `crates/db/tests/task_variable_inheritance.rs` - Added `clone_url: None` to test
9. `crates/deployment/src/lib.rs` - Added `clone_url: None` to auto-create
10. `frontend/src/components/dialogs/projects/ProjectFormDialog.tsx` - Added `clone_url: null`
11. `shared/types.ts` - Generated with `clone_url` field

---

## Phase 1 Frontend: StashDialog + Integration (Session 2)

### Completed Items
- [x] Generated TypeScript types from Rust structs (added to `crates/server/src/bin/generate_types.rs`)
- [x] Added stash API calls to `frontend/src/lib/api.ts`:
  - `getDirtyFiles(attemptId)` - Fetch list of dirty files
  - `stashChanges(attemptId, message?)` - Stash changes with optional message
  - `popStash(attemptId)` - Pop stash to restore changes
- [x] Created React hooks:
  - `useStash.ts` - Mutation hook for stashing changes
  - `usePopStash.ts` - Mutation hook for popping stash
  - `useDirtyFiles.ts` - Query hook for fetching dirty files
- [x] Added i18n strings to `frontend/src/i18n/locales/en/tasks.json` under `git.stashDialog`
- [x] Created `StashDialog.tsx` component following NiceModal pattern
- [x] Exported StashDialog from `frontend/src/components/dialogs/index.ts`
- [x] TypeScript and ESLint checks passing (no new errors)

### Files Changed (Session 2)
1. `crates/server/src/bin/generate_types.rs` - Added stash types to generation
2. `frontend/src/lib/api.ts` - Added stash API methods
3. `frontend/src/hooks/useStash.ts` - New file
4. `frontend/src/hooks/usePopStash.ts` - New file
5. `frontend/src/hooks/useDirtyFiles.ts` - New file
6. `frontend/src/i18n/locales/en/tasks.json` - Added stash dialog strings
7. `frontend/src/components/dialogs/git/StashDialog.tsx` - New file
8. `frontend/src/components/dialogs/index.ts` - Added StashDialog export

---

## Phase 1: Backend - Stash Functions (Session 1)

### Completed Items
- [x] Explored existing git service code structure
- [x] Wrote comprehensive tests in `crates/services/tests/git_stash.rs` (8 tests)
- [x] Implemented `stash_push()` in `crates/services/src/services/git/cli.rs`
- [x] Implemented `stash_pop()` in `crates/services/src/services/git/cli.rs`
- [x] Implemented `stash_list()` in `crates/services/src/services/git/cli.rs`
- [x] Implemented `get_dirty_files()` in `crates/services/src/services/git/cli.rs`
- [x] Implemented `stash_changes()` in `crates/services/src/services/git.rs`
- [x] Implemented `pop_stash()` in `crates/services/src/services/git.rs`
- [x] Implemented `get_dirty_files()` in `crates/services/src/services/git.rs`
- [x] Added `NothingToStash` and `StashEmpty` error types to `GitServiceError`
- [x] Added API endpoints in `crates/server/src/routes/task_attempts.rs`:
  - `GET /task-attempts/{id}/stash/dirty-files` - List dirty files
  - `POST /task-attempts/{id}/stash` - Stash changes
  - `POST /task-attempts/{id}/stash/pop` - Pop stash
- [x] Added corresponding by-task-id routes for cross-node proxying
- [x] All 8 unit tests passing
- [x] All 19 git_workflow tests passing (no regression)
- [x] Server build successful

### Test Results (Session 1)
```text
running 8 tests
test test_pop_empty_stash_returns_error ... ok
test test_get_dirty_files_returns_modified_files ... ok
test test_get_dirty_files_empty_when_clean ... ok
test test_stash_clean_worktree_returns_error ... ok
test test_stash_changes_creates_entry ... ok
test test_pop_stash_restores_changes ... ok
test test_stash_with_custom_message ... ok
test test_stash_includes_untracked_files ... ok

test result: ok. 8 passed; 0 failed; 0 ignored
```
