# Task Archive Fixes 2

## Status: needs-review

## Overview
Bug fixes for task archiving UI issues in the Kanban board.

## Plan Reference
`/home/david/.claude/plans/serialized-purring-porcupine.md`

---

## Session 1: TaskCard UI Improvements ✅

### Objectives
1. Remove redundant "Archived" badge from TaskCard header (archive icon at bottom already indicates state)
2. Combine task labels and archive icon on the same horizontal line at the bottom of each card

### Completed Items
- [x] Removed "Archived" badge JSX from TaskCard header's `right` prop
- [x] Removed unused `Archive` import from lucide-react
- [x] Removed unused `Badge` import from @/components/ui/badge
- [x] Restructured bottom section to combine labels and archive icon on same line using flexbox
- [x] Ran lint check (ESLint) - no errors in TaskCard.tsx
- [x] Ran format check (Prettier) - passes
- [x] Ran TypeScript type check - no errors

### Test Results

#### Visual Testing ✅

| Viewport | Dark Mode | Light Mode |
|----------|-----------|------------|
| Desktop (default) | ✅ | ✅ |
| Mobile (375x667) | ✅ | ✅ |
| Tablet (768x1024) | ✅ | ✅ |

Screenshots saved:
- `.playwright-mcp/desktop-light-mode.png`
- `.playwright-mcp/mobile-light-mode.png`
- `.playwright-mcp/tablet-light-mode.png`

#### Validation Results
- Labels display correctly with icons on the left side of each card's bottom row
- Archive icon displays correctly on the right side of each card's bottom row
- No "Archived" badge appears in card headers
- Layout works correctly at all responsive breakpoints
- No contrast issues in light or dark mode
- Console shows no errors related to changes (only pre-existing React Router warnings)

### Code Changes

**File: `frontend/src/components/tasks/TaskCard.tsx`**

1. **Removed imports** (lines 3-10):
   - Removed `Archive` from lucide-react imports
   - Removed `Badge` import

2. **Removed "Archived" badge from header** (deleted lines ~217-225):
   ```tsx
   // REMOVED:
   {isArchived && (
     <Badge variant="secondary" className="gap-1 px-1.5 py-0.5 text-xs">
       <Archive className="h-3 w-3" />
       {t('badges.archived')}
     </Badge>
   )}
   ```

3. **Restructured bottom section** (lines ~267-280):
   ```tsx
   {/* Labels and Archive Icon - same line */}
   <div className="flex items-center justify-between gap-2">
     <div className="flex flex-wrap gap-1 flex-1 min-w-0">
       {labels?.map((label) => (
         <LabelBadge key={label.id} label={label} size="sm" />
       ))}
     </div>
     <ArchiveToggleIcon
       isArchived={isArchived}
       onArchive={handleArchive}
       onUnarchive={handleUnarchive}
       disabled={task.is_remote || isArchiving}
     />
   </div>
   ```

---

## Session 2: Immediate Visibility Updates ✅

### Objectives
- Fix immediate visibility updates when archiving/unarchiving tasks
- Tasks should disappear immediately when archived (if "show archives" is disabled)
- Tasks should reappear immediately when unarchived

### Root Cause Analysis
The issue was a race condition between optimistic updates and WebSocket broadcasts:
1. User clicks Archive → optimistic update applied → task hidden
2. WebSocket receives server broadcast (still has old `archived_at: null`) → overwrites optimistic state
3. Task reappears briefly until next WebSocket update with correct data

### Solution Implemented
Created a separate `optimisticArchivedOverrides` state in `useProjectTasks.ts` that:
1. Persists archive changes across WebSocket updates
2. Merges with WebSocket data to maintain immediate visibility changes
3. Auto-cleans up when server confirms the change

### Completed Items
- [x] Added `optimisticArchivedOverrides` state to track archive changes
- [x] Implemented `updateTaskArchivedOptimistically` callback for immediate updates
- [x] Created merge logic in `localTasksById` useMemo to combine WebSocket data with optimistic overrides
- [x] Auto-cleanup of overrides when server confirms the change
- [x] Tested archive functionality - task disappears immediately ✅
- [x] Tested unarchive functionality - task reappears immediately ✅
- [x] Tested on mobile (375x667) ✅
- [x] Tested on tablet (768x1024) ✅
- [x] Tested on desktop (1280x800) ✅
- [x] Tested in light mode ✅
- [x] Tested in dark mode ✅
- [x] Verified no new console errors introduced

### Test Results

#### Functional Testing ✅

| Action | Expected | Result |
|--------|----------|--------|
| Archive task (show archives OFF) | Task disappears immediately | ✅ Pass |
| Unarchive task | Task disappears from archived view immediately | ✅ Pass |
| Unarchive task | Task appears in normal view with Archive button | ✅ Pass |

#### Responsive Testing ✅

| Viewport | Archive | Unarchive |
|----------|---------|-----------|
| Mobile (375x667) | ✅ | ✅ |
| Tablet (768x1024) | ✅ | ✅ |
| Desktop (1280x800) | ✅ | ✅ |

#### Theme Testing ✅

| Theme | Archive | Unarchive |
|-------|---------|-----------|
| Light | ✅ | ✅ |
| Dark | ✅ | ✅ |

#### Console Errors
- No new errors introduced
- Only pre-existing React Router future flag warnings present

### Code Changes

**File: `frontend/src/hooks/useProjectTasks.ts`**

1. **Added optimistic archived overrides state** (lines ~45-50):
   ```typescript
   const [optimisticArchivedOverrides, setOptimisticArchivedOverrides] =
     useState<Map<string, { archivedAt: string | null; timestamp: number }>>(
       () => new Map()
     );
   ```

2. **Added callback for optimistic updates** (lines ~52-62):
   ```typescript
   const updateTaskArchivedOptimistically = useCallback(
     (taskId: string, archivedAt: string | null) => {
       setOptimisticArchivedOverrides((prev) => {
         const next = new Map(prev);
         next.set(taskId, { archivedAt, timestamp: Date.now() });
         return next;
       });
     },
     []
   );
   ```

3. **Added merge logic in localTasksById** (lines ~64-95):
   - Merges WebSocket data with optimistic overrides
   - Auto-cleans up when server confirms the change
   - Preserves optimistic state until server catches up

---

## Files Changed

| File | Change |
|------|--------|
| `frontend/src/components/tasks/TaskCard.tsx` | Session 1: Removed "Archived" badge, combined labels + archive icon on same line |
| `frontend/src/hooks/useProjectTasks.ts` | Session 2: Added optimistic archived overrides for immediate visibility updates |

---

## Next Steps
- Create PR to merge into main branch
