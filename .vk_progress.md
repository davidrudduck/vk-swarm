# Task Archive Feature - Progress Tracker

## Status: in-progress

## Overview
Implementing task archiving functionality to allow users to archive completed tasks and free up disk space by cleaning up associated worktrees.

## Completed Items

### Session 1: Database Schema + Model Methods âœ…
- [x] Created migration `20251217000000_add_archived_to_tasks.sql`
  - Added `archived_at` nullable timestamp column
  - Added index `idx_tasks_archived_at` for efficient queries
- [x] Added `archived_at` field to `Task` struct in `crates/db/src/models/task.rs`
- [x] Updated all SELECT queries to include `archived_at` field
- [x] Added `include_archived: bool` parameter to `find_by_project_id_with_attempt_status()`
- [x] Added `Task::archive(pool, id)` method
- [x] Added `Task::unarchive(pool, id)` method
- [x] Added `Task::archive_many(pool, ids)` method for subtask cascade
- [x] Updated `TaskWithProjectInfo` in `all_tasks.rs` with `archived_at` field
- [x] Updated `AllTasksResponse::fetch()` with `include_archived` parameter
- [x] Updated route handlers in `all_tasks.rs` and `tasks.rs` with query params
- [x] Updated WebSocket handler to pass `include_archived` through stream
- [x] Updated event service to include archived tasks in real-time updates
- [x] Updated share service to exclude archived tasks from Hive sharing
- [x] Regenerated TypeScript types (`shared/types.ts`)
- [x] Updated SQLx offline cache
- [x] All checks pass (`npm run check`)
- [x] All tests pass (except pre-existing doctest issue)

## Remaining Work

### Session 2: API Endpoints
- [ ] Create `POST /api/tasks/:task_id/archive` endpoint
- [ ] Create `POST /api/tasks/:task_id/unarchive` endpoint
- [ ] Add `include_subtasks: bool` parameter to archive endpoint
- [ ] Trigger worktree cleanup when archiving tasks
- [ ] Write API tests

### Session 3: Frontend Archive Dialog + Actions
- [ ] Create `ArchiveTaskDialog` component with subtask checkbox
- [ ] Add "Archive Task" option to task dropdown menus (TaskCard, TaskRow)
- [ ] Implement archive mutation hook
- [ ] Handle archive confirmation with subtask count display
- [ ] Add "Unarchive" option for archived tasks

### Session 4: Filter Toggle + Styling
- [ ] Add "Show Archived" toggle to task list toolbar
- [ ] Persist filter preference (localStorage or URL param)
- [ ] Add visual styling for archived tasks (muted/greyed)
- [ ] Add archived badge/indicator
- [ ] E2E browser testing with Playwright

## Design Decisions Made
1. **Archive vs Delete**: Archive preserves all DB records, only sets `archived_at` timestamp
2. **Worktree Cleanup**: Archiving triggers immediate worktree cleanup (user has 5-10GB per worktree)
3. **Subtask Handling**: User choice with checkbox, default is to cascade archive to subtasks
4. **Auto-archive**: Manual only via dropdown menu (no automatic archiving)
5. **Filter Default**: Hide archived tasks by default, toggle to show

## Files Modified in Session 1
- `crates/db/migrations/20251217000000_add_archived_to_tasks.sql` (new)
- `crates/db/src/models/task.rs`
- `crates/db/src/models/all_tasks.rs`
- `crates/server/src/routes/all_tasks.rs`
- `crates/server/src/routes/tasks.rs`
- `crates/services/src/services/events.rs`
- `crates/services/src/services/events/streams.rs`
- `crates/services/src/services/share.rs`
- `.sqlx/` cache files
- `shared/types.ts`

## Next Session Recommendations
1. Start with Session 2: API Endpoints
2. Focus on the archive endpoint first, including worktree cleanup integration
3. The worktree cleanup service already exists - integrate with `WorktreeService::cleanup_worktree()`
4. Test API endpoints manually before moving to frontend
