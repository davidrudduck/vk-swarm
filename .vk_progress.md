# Swarm Implementation - Remote Task Attempt Operations

## Current Status: **in-progress**

## Overview
Implementing remote task attempt operations for the swarm/hive setup. Steps 1-6 complete.

## Completed Items

### Step 1: RemoteTaskAttemptContext ✓
- [x] Added `RemoteTaskAttemptContext` struct to `crates/server/src/middleware/model_loaders.rs`
- [x] Added `is_available()` and `node_url()` helper methods matching `RemoteProjectContext` pattern

### Step 2: Modified load_task_attempt_impl ✓
- [x] Enhanced middleware to load parent Task and Project
- [x] Injects `RemoteTaskAttemptContext` when project is remote
- [x] Uses `shared_task_id` for cross-node routing

### Step 2.5: check_remote_task_attempt_proxy helper ✓
- [x] Added helper function in `crates/server/src/routes/task_attempts.rs`
- [x] Returns `(node_url, node_id, task_id)` tuple when remote and online
- [x] Returns `ApiError::BadGateway` when node offline or no URL
- [x] Added 4 unit tests for the helper

### Step 3: By-Task-ID Routes ✓
- [x] Added `load_task_attempt_by_task_id_middleware` to model_loaders.rs
- [x] Added `load_task_attempt_by_task_id_middleware_with_wildcard` variant
- [x] Middleware validates proxy token when connection token validator is enabled
- [x] Finds task by `shared_task_id`, loads most recent attempt
- [x] Registered by-task-id routes in task_attempts.rs router

### Step 4: Add Proxy Logic to Handlers ✓
Added proxy support to 15 handlers in `task_attempts.rs`:
- [x] `follow_up` - POST proxy
- [x] `stop_task_attempt_execution` - POST proxy
- [x] `get_task_attempt_branch_status` - GET proxy
- [x] `merge_task_attempt` - POST proxy
- [x] `push_task_attempt_branch` - POST proxy
- [x] `force_push_task_attempt_branch` - POST proxy
- [x] `rebase_task_attempt` - POST proxy
- [x] `create_github_pr` - POST proxy
- [x] `change_target_branch` - POST proxy
- [x] `rename_branch` - POST proxy
- [x] `abort_conflicts_task_attempt` - POST proxy
- [x] `attach_existing_pr` - POST proxy
- [x] `list_worktree_files` - GET proxy
- [x] `read_worktree_file` - GET proxy

Also added `Serialize` to request structs and `Deserialize` to response structs as needed for proxy operations.

### Step 5: Add Remote Attempt Start ✓
**Backend:**
- [x] Added `ListProjectNodesResponse` and `ProjectNodeInfo` types in `crates/remote/src/routes/projects.rs`
- [x] Added `GET /projects/{project_id}/nodes` endpoint on hive to list nodes with a project
- [x] Added `list_project_nodes` method to `RemoteClient` in services
- [x] Added `GET /tasks/{id}/available-nodes` endpoint to server that queries hive
- [x] Added `target_node_id: Option<Uuid>` to `CreateTaskAttemptBody`
- [x] Added proxy logic in `create_task_attempt` when target_node_id is set
- [x] Added `CreateTaskAttemptByTaskIdBody` and by-task-id create route for proxied requests
- [x] Added `load_task_by_task_id_middleware` for the create route (doesn't need existing attempt)

**Frontend:**
- [x] Added `ListProjectNodesResponse` and `ProjectNodeInfo` types to api.ts
- [x] Added `tasksApi.availableNodes()` method
- [x] Added `useAvailableNodes` hook
- [x] Updated `useAttemptCreation` hook to support `targetNodeId` parameter
- [x] Added node selector UI to `CreateAttemptDialog.tsx`:
  - Dropdown with "Local (this node)" default option
  - Shows remote nodes with online/offline status indicators
  - Only shows selector when remote nodes are available

### Step 6: Remote Diff Streaming ✓
**Hive Backend:**
- [x] Added `find_latest_by_task_id` to `TaskAssignmentRepository` in `crates/remote/src/db/task_assignments.rs`
- [x] Added `TaskStreamConnectionInfoResponse` struct in `crates/remote/src/routes/tasks.rs`
- [x] Added `GET /tasks/{task_id}/stream-connection-info` endpoint on hive
- [x] Generates JWT connection token with task ID claim for WebSocket authentication
- [x] Returns direct URL (node's public URL), relay URL, attempt ID, and expiry

**Node Backend:**
- [x] Added `get_task_stream_connection_info` method to `RemoteClient`
- [x] Added `GET /api/tasks/{id}/stream-connection-info` server endpoint (proxies to hive)
- [x] Re-exported `TaskStreamConnectionInfoResponse` from remote crate

**Frontend:**
- [x] Added `TaskStreamConnectionInfoResponse` type to `api.ts`
- [x] Added `tasksApi.streamConnectionInfo()` method
- [x] Updated `useDiffStream` hook:
  - Added `RemoteStreamInfo` interface with `taskId` field
  - Fetches connection info when `remoteInfo` provided
  - Builds direct WebSocket URL with token query parameter
  - Returns `connectionType: 'direct' | 'relay' | null`
- [x] Updated `DiffsPanel` component:
  - Added `task?: TaskWithAttemptStatus` prop
  - Builds `remoteStreamInfo` when `task.is_remote && task.shared_task_id`
  - Shows connection indicator (Wifi icon + Direct/Relay label) in header
- [x] Updated `ProjectTasks.tsx` to pass `task` prop to `DiffsPanel`

## Remaining Work
- [ ] Step 7: Add connection status badge (frontend)

## Files Modified
| File | Changes |
|------|---------|
| `crates/server/src/middleware/model_loaders.rs` | Added `RemoteTaskAttemptContext`, enhanced `load_task_attempt_impl`, added by-task-id middleware, added `load_task_by_task_id_middleware` |
| `crates/server/src/routes/task_attempts.rs` | Added `check_remote_task_attempt_proxy` helper, unit tests, by-task-id routes, proxy logic to 15 handlers, target_node_id support |
| `crates/server/src/routes/tasks.rs` | Added `get_available_nodes` and `get_stream_connection_info` handlers |
| `crates/server/src/mcp/task_server.rs` | Added `target_node_id: None` to CreateTaskAttemptBody |
| `crates/remote/src/routes/projects.rs` | Added `ListProjectNodesResponse`, `ProjectNodeInfo`, `list_project_nodes` handler |
| `crates/remote/src/routes/tasks.rs` | Added `TaskStreamConnectionInfoResponse`, `get_stream_connection_info` handler |
| `crates/remote/src/routes/mod.rs` | Made projects module public, re-exported `TaskStreamConnectionInfoResponse` |
| `crates/remote/src/db/task_assignments.rs` | Added `find_latest_by_task_id` method |
| `crates/services/src/services/remote_client.rs` | Added `list_project_nodes` and `get_task_stream_connection_info` methods |
| `frontend/src/lib/api.ts` | Added `ListProjectNodesResponse`, `ProjectNodeInfo`, `TaskStreamConnectionInfoResponse` types, `availableNodes`, `streamConnectionInfo` methods |
| `frontend/src/hooks/useAvailableNodes.ts` | New hook for fetching available nodes |
| `frontend/src/hooks/useDiffStream.ts` | Added `RemoteStreamInfo` interface, remote connection support, `connectionType` return value |
| `frontend/src/hooks/useAttemptCreation.ts` | Added `targetNodeId` parameter support |
| `frontend/src/hooks/index.ts` | Exported `useAvailableNodes` |
| `frontend/src/components/dialogs/tasks/CreateAttemptDialog.tsx` | Added node selector UI |
| `frontend/src/components/panels/DiffsPanel.tsx` | Added `task` prop, remote stream info, connection indicator UI |
| `frontend/src/pages/ProjectTasks.tsx` | Pass `task` prop to `DiffsPanel` |

## Build Status
- [x] `npm run check` passing
- [x] Unit tests passing
- [x] No compiler warnings

## Next Session Recommendations
1. **Step 7**: Add connection status badge (frontend)
   - Show node connection status in attempt view
   - Add relay fallback when direct connection fails

## Architecture Notes
The implementation follows the established pattern from remote projects:
- `RemoteProjectContext` (model_loaders.rs) → `RemoteTaskAttemptContext`
- `check_remote_proxy` (projects.rs) → `check_remote_task_attempt_proxy`
- `load_project_by_remote_id_middleware` → `load_task_attempt_by_task_id_middleware`
- Middleware loads Task + Project to determine if remote context needed
- Proxy logic uses `node_proxy_client().proxy_get()`/`proxy_post()` with by-task-id routes
- Remote attempt start uses `target_node_id` to proxy create request to selected node
