# Task Variables Feature - Implementation Progress

## Status: in-progress

## Overview
Adding a variable system to vibe-kanban that allows users to define key-value pairs at the task level, which are automatically expanded in task descriptions when sent to executors. Child tasks inherit variables from parent tasks.

## Plan File
`/home/david/.claude/plans/plucky-honking-church.md`

---

## Session 1: Variable Expander with Tests (TDD)

### Completed Items
- [x] Created `variable_expander.rs` with comprehensive TDD tests
- [x] Implemented `expand_variables()` function supporting `$VAR` and `${VAR}` syntax
- [x] Added `ExpansionResult` struct with text, undefined_vars, and expanded_vars fields
- [x] Implemented helper functions: `is_var_start()`, `is_var_char()`, `parse_braced_var()`, `parse_simple_var()`
- [x] Added module to `services/mod.rs`
- [x] All 29 tests passing
- [x] Clippy: No warnings
- [x] Formatting: Correctly formatted

### Files Changed
| File | Change |
|------|--------|
| `crates/services/src/services/variable_expander.rs` | NEW - Variable expansion logic with 29 tests |
| `crates/services/src/services/mod.rs` | Added `pub mod variable_expander;` |

### Test Results
```text
running 29 tests
test services::variable_expander::tests::test_adjacent_variables ... ok
test services::variable_expander::tests::test_braced_var_adjacent_chars ... ok
test services::variable_expander::tests::test_braced_var_expansion ... ok
test services::variable_expander::tests::test_dollar_at_end ... ok
test services::variable_expander::tests::test_dollar_followed_by_space ... ok
test services::variable_expander::tests::test_duplicate_undefined_variable ... ok
test services::variable_expander::tests::test_empty_braces ... ok
test services::variable_expander::tests::test_empty_input ... ok
test services::variable_expander::tests::test_empty_value ... ok
test services::variable_expander::tests::test_long_variable_name ... ok
test services::variable_expander::tests::test_lowercase_not_variable ... ok
test services::variable_expander::tests::test_mixed_syntax ... ok
test services::variable_expander::tests::test_multiline_text ... ok
test services::variable_expander::tests::test_no_variables ... ok
test services::variable_expander::tests::test_number_start_not_variable ... ok
test services::variable_expander::tests::test_practical_plan_file ... ok
test services::variable_expander::tests::test_simple_var_expansion ... ok
test services::variable_expander::tests::test_source_tracking ... ok
test services::variable_expander::tests::test_special_chars_in_value ... ok
test services::variable_expander::tests::test_unclosed_brace ... ok
test services::variable_expander::tests::test_undefined_braced_variable ... ok
test services::variable_expander::tests::test_undefined_variable ... ok
test services::variable_expander::tests::test_unicode_text ... ok
test services::variable_expander::tests::test_value_with_dollar_sign ... ok
test services::variable_expander::tests::test_value_with_var_pattern ... ok
test services::variable_expander::tests::test_var_at_boundaries ... ok
test services::variable_expander::tests::test_var_with_underscores_and_numbers ... ok
test services::variable_expander::tests::test_whitespace ... ok
test services::variable_expander::tests::test_braced_lowercase_start ... ok

test result: ok. 29 passed; 0 failed; 0 ignored; 0 measured; 106 filtered out
```

### Validation
- `cargo test -p services variable_expander`: 29/29 tests passed
- `cargo clippy -p services -- -D warnings`: No warnings
- `cargo fmt -p services -- --check`: OK

---

## Session 2: Database Migration + TaskVariable Model (COMPLETED)

### Note
Session 2 work was already completed in origin/main before this session started. This session verified and validated the existing implementation.

### Completed Items
- [x] Database migration created: `20251222080043_add_task_variables.sql`
- [x] TaskVariable model with all structs (`TaskVariable`, `CreateTaskVariable`, `UpdateTaskVariable`, `ResolvedVariable`)
- [x] CRUD operations: `find_by_task_id`, `find_by_id`, `create`, `update`, `delete`
- [x] TypeScript generation with `#[derive(TS)]`
- [x] Types exported in `shared/types.ts`
- [x] Inheritance resolution with `find_inherited()` using recursive CTE (O(1) query)
- [x] REST API routes implemented
- [x] 8 inheritance integration tests passing
- [x] All validation checks passing

### Files Present
| File | Description |
|------|-------------|
| `crates/db/migrations/20251222080043_add_task_variables.sql` | Migration creating `task_variables` table |
| `crates/db/src/models/task_variable.rs` | TaskVariable model with CRUD + inheritance |
| `crates/db/src/models/mod.rs` | Module exports `task_variable` |
| `crates/db/tests/task_variable_inheritance.rs` | 8 integration tests for inheritance |
| `crates/server/src/routes/task_variables.rs` | REST API endpoints |
| `shared/types.ts` | TypeScript types generated |

### Database Schema
```sql
CREATE TABLE task_variables (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    name TEXT NOT NULL CHECK(name GLOB '[A-Z][A-Z0-9_]*'),
    value TEXT NOT NULL,
    created_at TEXT NOT NULL DEFAULT (datetime('now', 'subsec')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now', 'subsec')),
    UNIQUE(task_id, name)
);

CREATE INDEX idx_task_variables_task_id ON task_variables(task_id);
```

### API Endpoints
- `GET /api/tasks/:id/variables` - list own variables
- `GET /api/tasks/:id/variables/resolved` - list with inheritance
- `POST /api/tasks/:id/variables` - create (validates name format)
- `PUT /api/tasks/:id/variables/:var_id` - update
- `DELETE /api/tasks/:id/variables/:var_id` - delete
- `POST /api/tasks/:id/variables/preview` - preview expansion

### Test Results
```text
running 8 tests
test test_find_inherited_child_overrides_parent ... ok
test test_find_inherited_deep_hierarchy ... ok
test test_find_inherited_empty_no_variables ... ok
test test_find_inherited_inherits_from_ancestors ... ok
test test_find_inherited_no_parent_returns_own_vars ... ok
test test_find_inherited_results_sorted_by_name ... ok
test test_find_inherited_partial_override_in_chain ... ok
test test_find_inherited_parent_only_variables ... ok

test result: ok. 8 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
```

### Validation
- `cargo test -p db --test task_variable_inheritance`: 8/8 tests passed
- `cargo clippy -p db -- -D warnings`: No warnings
- `npm run check`: All checks passing

---

## Feature Details

### Variable Expansion
- **Syntax**: Supports `$VAR` and `${VAR}` (braced for adjacent characters)
- **Variable Names**: Must match `[A-Z][A-Z0-9_]*` (uppercase, start with letter)
- **Undefined Variables**: Left unexpanded and tracked in `undefined_vars`
- **Source Tracking**: Tracks which task each variable came from via `expanded_vars`

### ExpansionResult Structure
```rust
pub struct ExpansionResult {
    pub text: String,                              // Expanded text
    pub undefined_vars: Vec<String>,               // Variables that were not defined
    pub expanded_vars: Vec<(String, Option<Uuid>)>, // Variables that were expanded (name, source_task_id)
}
```

### ResolvedVariable Structure
```rust
pub struct ResolvedVariable {
    pub name: String,
    pub value: String,
    pub source_task_id: Uuid,  // Task ID where variable was defined
    pub inherited: bool,        // True if from parent task
}
```

---

## Session 5: Executor Integration (COMPLETED)

### Note
Session 5 work was already completed in origin/main. This session verified and validated the existing implementation in `container.rs`.

### Completed Items
- [x] Variable expansion integrated into `start_attempt()` method in `container.rs`
- [x] Fetches resolved variables using `TaskVariable::get_variable_map()`
- [x] Calls `variable_expander::expand_variables()` on the prompt before sending to executor
- [x] Logs warning for undefined variables that couldn't be expanded
- [x] Logs info about successfully expanded variables
- [x] All 29 variable_expander tests passing
- [x] All 8 inheritance tests passing
- [x] Clippy: No warnings
- [x] Formatting: Correctly formatted

### Implementation Location
**File**: `crates/services/src/services/container.rs` (lines 738-777)

```rust
// Expand task variables ($VAR and ${VAR} syntax) in the prompt
let prompt = {
    // Get resolved variables for this task (including inherited from parent chain)
    let variables = TaskVariable::get_variable_map(&self.db().pool, task.id)
        .await
        .unwrap_or_else(|e| {
            tracing::warn!(task_id = %task.id, error = ?e, "Failed to fetch task variables");
            std::collections::HashMap::new()
        });

    if variables.is_empty() {
        prompt
    } else {
        // Convert (String, Uuid) to (String, Option<Uuid>) for variable_expander
        let variables: HashMap<String, (String, Option<Uuid>)> = variables
            .into_iter()
            .map(|(k, (v, id))| (k, (v, Some(id))))
            .collect();

        let result = variable_expander::expand_variables(&prompt, &variables);

        // Log warning if there are undefined variables
        if !result.undefined_vars.is_empty() {
            tracing::warn!(
                task_id = %task.id,
                undefined_vars = ?result.undefined_vars,
                "Task prompt contains undefined variables that were not expanded"
            );
        }

        if !result.expanded_vars.is_empty() {
            tracing::info!(
                task_id = %task.id,
                expanded_count = result.expanded_vars.len(),
                "Expanded task variables in prompt"
            );
        }

        result.text
    }
};
```

### Execution Flow
1. Task attempt is started via `start_attempt()`
2. Task's enhanced prompt is created with `task.to_enhanced_prompt()`
3. Image paths are canonicalized via `ImageService::canonicalise_image_paths()`
4. **NEW**: Variables are fetched using `TaskVariable::get_variable_map()`
5. **NEW**: Variables are expanded using `variable_expander::expand_variables()`
6. **NEW**: Warnings logged for undefined variables
7. Prompt is passed to executor (setup script or coding agent)

### Test Results
```text
# Variable Expander Tests
running 29 tests
test services::variable_expander::tests::test_adjacent_variables ... ok
test services::variable_expander::tests::test_braced_var_expansion ... ok
... (all 29 tests pass)

# Inheritance Tests
running 8 tests
test test_find_inherited_child_overrides_parent ... ok
test test_find_inherited_deep_hierarchy ... ok
... (all 8 tests pass)
```

### Validation
- `cargo test -p services variable_expander`: 29/29 tests passed
- `cargo test -p db --test task_variable_inheritance`: 8/8 tests passed
- `cargo clippy -p services -p db -- -D warnings`: No warnings
- `cargo fmt --all -- --check`: OK (after formatting fixes)

---

## Session 6: MCP Server Tools (COMPLETED)

### Note
Session 6 work was already completed in origin/main. This session verified and validated the existing implementation in `task_server.rs`.

### Completed Items
- [x] `get_task_variables(task_id)` - Returns resolved variables including inherited ones
- [x] `set_task_variable(task_id, name, value)` - Creates new or updates existing variable
- [x] `delete_task_variable(task_id, name)` - Deletes a variable by name
- [x] MCP types defined: `GetTaskVariablesRequest`, `GetTaskVariablesResponse`, `TaskVariableDetails`, etc.
- [x] Server instructions updated to document the new tools
- [x] Clippy: No warnings
- [x] Formatting: Correctly formatted

### Implementation Location
**File**: `crates/server/src/mcp/task_server.rs`

**MCP Types** (lines 247-328):
- `GetTaskVariablesRequest` / `GetTaskVariablesResponse`
- `TaskVariableDetails` (with `from_resolved()` conversion)
- `SetTaskVariableRequest` / `SetTaskVariableResponse`
- `DeleteTaskVariableRequest` / `DeleteTaskVariableResponse`

**MCP Tools**:
1. `get_task_variables` (lines 780-805) - Fetches resolved variables via REST API
2. `set_task_variable` (lines 807-867) - Creates or updates variable with upsert logic
3. `delete_task_variable` (lines 869-912) - Finds and deletes variable by name

**Server Instructions** (line 918):
```text
"Task variables: Use 'get_task_variables', 'set_task_variable', and 'delete_task_variable' to manage variables that are expanded in task descriptions using $VAR or ${VAR} syntax."
```

### Tool Details

#### `get_task_variables(task_id)`
Returns all resolved variables for a task including inherited ones from parent tasks.
- Calls `/api/tasks/{id}/variables/resolved` REST endpoint
- Returns `TaskVariableDetails` with inheritance info

#### `set_task_variable(task_id, name, value)`
Creates or updates a variable on a task.
- First checks if variable exists via `/api/tasks/{id}/variables`
- If exists: PUT to update
- If not exists: POST to create
- Returns variable details with `created` flag

#### `delete_task_variable(task_id, name)`
Deletes a variable from a task by name.
- Finds variable by name in task's own variables
- Deletes by ID
- Returns confirmation

### Validation
- `cargo clippy -p server -- -D warnings`: No warnings
- `cargo fmt --all -- --check`: OK
- Dev server started successfully with MCP port (3513)

---

## Session 7: Frontend API + Hooks (COMPLETED)

### Note
Session 7 work was already completed in origin/main. This session verified the implementation and tested all API endpoints in the browser.

### Completed Items
- [x] `taskVariablesApi` namespace in `frontend/src/lib/api.ts` with all endpoints
- [x] `useTaskVariables(taskId)` query hook for fetching task's own variables
- [x] `useResolvedVariables(taskId)` query hook for fetching inherited variables
- [x] `useTaskVariableMutations(taskId)` mutation hooks (create, update, delete)
- [x] `usePreviewExpansion(taskId)` mutation hook for previewing variable expansion
- [x] Query keys with `taskVariablesKeys` for cache management
- [x] Hooks exported from `frontend/src/hooks/index.ts`
- [x] ESLint: No errors (278 warnings, all pre-existing)
- [x] TypeScript: Compiles cleanly
- [x] Clippy: No warnings

### Files Present
| File | Description |
|------|-------------|
| `frontend/src/lib/api.ts` | `taskVariablesApi` namespace (lines 551-635) |
| `frontend/src/hooks/useTaskVariables.ts` | React Query hooks for variables |
| `frontend/src/hooks/index.ts` | Hook exports |
| `shared/types.ts` | TypeScript types (TaskVariable, ResolvedVariable, etc.) |

### API Client (`taskVariablesApi`)
```typescript
export const taskVariablesApi = {
  list: (taskId) => Promise<TaskVariable[]>,           // GET /api/tasks/{id}/variables
  listResolved: (taskId) => Promise<ResolvedVariable[]>, // GET /api/tasks/{id}/variables/resolved
  create: (taskId, data) => Promise<TaskVariable>,     // POST /api/tasks/{id}/variables
  update: (taskId, varId, data) => Promise<TaskVariable>, // PUT /api/tasks/{id}/variables/{var_id}
  delete: (taskId, varId) => Promise<void>,           // DELETE /api/tasks/{id}/variables/{var_id}
  preview: (taskId, data) => Promise<PreviewExpansionResponse>, // POST /api/tasks/{id}/variables/preview
};
```

### React Hooks
```typescript
// Query hooks
useTaskVariables(taskId?: string)     // Fetch task's own variables
useResolvedVariables(taskId?: string) // Fetch all resolved (including inherited)

// Mutation hooks
useTaskVariableMutations(taskId, options?) // createVariable, updateVariable, deleteVariable
usePreviewExpansion(taskId)               // Preview variable expansion in text

// Query keys for cache management
taskVariablesKeys = {
  all: ['taskVariables'],
  byTask: (taskId) => ['taskVariables', taskId],
  resolved: (taskId) => ['taskVariables', taskId, 'resolved'],
}
```

### API Testing Results
All REST API endpoints tested and working:
```bash
# List variables (empty)
GET /api/tasks/{id}/variables → {"success":true,"data":[],...}

# Create variable
POST /api/tasks/{id}/variables {"name":"API_KEY","value":"sk-test-12345"}
→ {"success":true,"data":{"id":"...","name":"API_KEY","value":"sk-test-12345",...}

# List resolved (with inheritance)
GET /api/tasks/{child_id}/variables/resolved
→ {"success":true,"data":[{"name":"API_KEY","value":"sk-prod-67890","source_task_id":"...","inherited":true}],...}

# Update variable
PUT /api/tasks/{id}/variables/{var_id} {"value":"sk-prod-67890"}
→ {"success":true,"data":{"id":"...","value":"sk-prod-67890",...}

# Preview expansion
POST /api/tasks/{id}/variables/preview {"text":"Using $API_KEY and $UNKNOWN_VAR"}
→ {"success":true,"data":{"expanded_text":"Using sk-prod-67890 and $UNKNOWN_VAR","undefined_variables":["UNKNOWN_VAR"],...}

# Delete variable
DELETE /api/tasks/{id}/variables/{var_id} → {"success":true,"data":null,...}
```

### Browser Testing
- **Desktop (1920x1080)**: UI renders correctly, tasks display properly
- **Tablet (768x1024)**: Responsive layout works
- **Mobile (375x667)**: Mobile layout adapts correctly
- **Dark Mode**: Theme toggle works, no contrast issues
- **Console Errors**: None

### Validation
- `cd frontend && npm run lint`: 0 errors, 278 warnings
- `cd frontend && npx tsc --noEmit`: OK
- `cargo clippy -p server -p services -p db -- -D warnings`: No warnings

---

## Remaining Steps (Future Sessions)
- Session 8: VariableEditor component
- Session 9: Task form integration
- Session 10: Variables panel
