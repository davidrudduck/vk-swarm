# Performance Fixes - Session 2: Recursive CTE for Variable Inheritance

## Status: needs-review

## Overview
Replaced loop-based parent chain traversal with a single recursive CTE query for `TaskVariable::find_inherited()`, reducing from O(2*depth) queries to O(1) query.

## Completed Items

### Session 1: Bulk Database Operations ✅
- [x] `Task::archive_many()` - Replaced loop with bulk UPDATE
- [x] `Task::delete_stale_remote_tasks()` - Single DELETE with NOT IN
- [x] `Project::delete_stale_remote_projects()` - Same pattern

### Session 2: Recursive CTE for Variable Inheritance ✅
- [x] Analyzed existing `find_inherited()` implementation
- [x] Implemented recursive CTE with window functions
- [x] Used `ROW_NUMBER() OVER (PARTITION BY name ORDER BY depth ASC)` for child-overrides-parent behavior
- [x] Added explicit CAST for SQLite type handling
- [x] Updated SQLx query cache for offline compilation
- **File:** `crates/db/src/models/task_variable.rs:157-221`

## Validation Results

### cargo test -p db ✅
```text
running 52 tests
test result: ok. 52 passed; 0 failed; 0 ignored
```

### npm run check ✅
- Frontend TypeScript check: passed
- Backend cargo check: passed

### Browser Testing ✅
- Tested task variable creation in Edit dialog
- Variable `$TEST_VAR` = `test_value_123` saved successfully
- Variable deletion confirmed
- No console errors
- Server logs clean (no errors during variable operations)

## Files Changed

| File | Change |
|------|--------|
| `crates/db/src/models/task_variable.rs` | Replaced loop-based `find_inherited()` with recursive CTE query |
| `.sqlx/query-*.json` | Added query cache entry for new CTE query |

## Performance Impact

| Function | Before | After |
|----------|--------|-------|
| `find_inherited(10-level hierarchy)` | 20+ queries (chain + vars) | 1 query |

## SQL Query Details

The new implementation uses:
```sql
WITH RECURSIVE task_chain AS (
    SELECT id, parent_task_id, CAST(0 AS INTEGER) as depth
    FROM tasks WHERE id = $1
    UNION ALL
    SELECT t.id, t.parent_task_id, CAST(tc.depth + 1 AS INTEGER)
    FROM tasks t
    INNER JOIN task_chain tc ON t.id = tc.parent_task_id
),
ranked_vars AS (
    SELECT tv.name, tv.value, tc.id as source_task_id, tc.depth,
           ROW_NUMBER() OVER (PARTITION BY tv.name ORDER BY tc.depth ASC) as rn
    FROM task_chain tc
    INNER JOIN task_variables tv ON tv.task_id = tc.id
)
SELECT name, value, source_task_id, depth
FROM ranked_vars WHERE rn = 1
ORDER BY name ASC
```

Key features:
- Recursive CTE traverses parent chain in one pass
- `ROW_NUMBER` with `PARTITION BY name ORDER BY depth ASC` ensures child variables override parents
- Single query regardless of hierarchy depth

## Next Steps (Session 3)
- Add database indexes for running processes and parent_task_id
- Implement visibility-based polling in frontend hooks
- Note: `idx_tasks_parent_task_id` already exists (created in migration 20251215)
