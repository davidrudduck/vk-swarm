# Task Archive Feature - Progress Tracker

## Status: needs-review

## Overview
Implementing task archiving functionality to allow users to archive completed tasks and free up disk space by cleaning up associated worktrees.

## Completed Items

### Session 1: Database Schema + Model Methods ✅
- [x] Created migration `20251217000000_add_archived_to_tasks.sql`
  - Added `archived_at` nullable timestamp column
  - Added index `idx_tasks_archived_at` for efficient queries
- [x] Added `archived_at` field to `Task` struct in `crates/db/src/models/task.rs`
- [x] Updated all SELECT queries to include `archived_at` field
- [x] Added `include_archived: bool` parameter to `find_by_project_id_with_attempt_status()`
- [x] Added `Task::archive(pool, id)` method
- [x] Added `Task::unarchive(pool, id)` method
- [x] Added `Task::archive_many(pool, ids)` method for subtask cascade
- [x] Updated `TaskWithProjectInfo` in `all_tasks.rs` with `archived_at` field
- [x] Updated `AllTasksResponse::fetch()` with `include_archived` parameter
- [x] Updated route handlers in `all_tasks.rs` and `tasks.rs` with query params
- [x] Updated WebSocket handler to pass `include_archived` through stream
- [x] Updated event service to include archived tasks in real-time updates
- [x] Updated share service to exclude archived tasks from Hive sharing
- [x] Regenerated TypeScript types (`shared/types.ts`)
- [x] Updated SQLx offline cache
- [x] All checks pass (`npm run check`)
- [x] All tests pass (except pre-existing doctest issue)

### Session 2: API Endpoints ✅
- [x] Created `POST /api/tasks/:task_id/archive` endpoint
  - Archives task by setting `archived_at` timestamp
  - Validates task is not remote (remote tasks cannot be archived locally)
  - Validates task is not already archived
  - Validates no running execution processes
  - Returns 202 Accepted with `ArchiveTaskResponse`
- [x] Created `POST /api/tasks/:task_id/unarchive` endpoint
  - Clears `archived_at` timestamp
  - Validates task is not remote
  - Validates task is currently archived
  - Returns 200 OK with updated `Task`
- [x] Added `include_subtasks: bool` parameter to archive endpoint (defaults to `true`)
  - Fetches children via `Task::find_children_by_parent_id`
  - Validates no child has running processes
  - Archives all children with `Task::archive_many`
  - Returns count of archived subtasks in response
- [x] Created `GET /api/tasks/:task_id/children` endpoint
  - Returns list of child tasks for archive dialog UI
- [x] Implemented worktree cleanup on archive
  - Gathers all task attempts for task and subtasks
  - Collects `WorktreeCleanup` data with worktree paths
  - Spawns background cleanup task (same pattern as delete_task)
- [x] Added `ArchiveTaskRequest` and `ArchiveTaskResponse` types
- [x] Registered types in `generate_types.rs` for TypeScript generation
- [x] Added routes to router: `/archive`, `/unarchive`, `/children`
- [x] Added analytics tracking for archive/unarchive events
- [x] Regenerated TypeScript types (`shared/types.ts`)
- [x] All checks pass (`npm run check`)
- [x] All tests pass (36 passed, pre-existing doctest issue)
- [x] API tested via curl - all endpoints working correctly
- [x] Frontend verified loading in browser (Playwright)

### Session 3: Frontend Archive Dialog + Actions ✅
- [x] Added `tasksApi.archive()`, `tasksApi.unarchive()`, `tasksApi.getChildren()` to `frontend/src/lib/api.ts`
- [x] Created `ArchiveTaskConfirmationDialog` component in `frontend/src/components/dialogs/tasks/`
  - Shows task title in description
  - Info alert explaining worktree cleanup and data preservation
  - Fetches children on mount and shows checkbox for subtask cascading
  - Cancel and Archive Task buttons with loading states
- [x] Added archive/unarchive handlers to `actions-dropdown.tsx`
  - Archive option shown for non-archived tasks
  - Unarchive option shown for archived tasks
  - Both disabled for remote tasks
- [x] Added translations to `frontend/src/i18n/locales/en/tasks.json`
  - `actionsMenu.archive` and `actionsMenu.unarchive` menu items
  - `archiveDialog.*` translations for dialog content
- [x] All checks pass (`npm run check`)
- [x] E2E tested in browser with Playwright
  - Verified Archive menu item appears in dropdown
  - Verified Archive dialog opens with correct content
  - Verified Cancel button closes dialog

### Session 4: Filter Toggle + Styling ✅
- [x] Added `showArchived` URL parameter state to `ProjectTasks.tsx`
- [x] Added `includeArchived` option to `useProjectTasks` hook
- [x] Updated WebSocket URL to include `include_archived` query parameter
- [x] Added "Toggle archived tasks" button to Navbar toolbar
  - Archive icon with tooltip
  - Active/pressed state when filter is enabled
  - Only visible when viewing a project
- [x] Added archived styling to `TaskCard.tsx`
  - Muted opacity (60%) for archived tasks
  - "Archived" badge with Archive icon in card header
- [x] Added translations for all languages (en, ja, ko, es)
  - `filters.archivedToggleAria` and `filters.archivedToggleTooltip`
  - `badges.archived`
  - `actionsMenu.archive` and `actionsMenu.unarchive`
  - `archiveDialog.*` translations
- [x] All checks pass (`npm run check`)
- [x] E2E tested in browser with Playwright
  - Verified toggle button appears in toolbar
  - Verified toggle updates URL with `?archived=on`
  - Verified button state changes (active/pressed)

## Remaining Work
None - Feature complete!

## Design Decisions Made
1. **Archive vs Delete**: Archive preserves all DB records, only sets `archived_at` timestamp
2. **Worktree Cleanup**: Archiving triggers immediate worktree cleanup (user has 5-10GB per worktree)
3. **Subtask Handling**: User choice with checkbox, default is to cascade archive to subtasks
4. **Auto-archive**: Manual only via dropdown menu (no automatic archiving)
5. **Filter Default**: Hide archived tasks by default, toggle to show
6. **Remote Tasks**: Cannot archive/unarchive remote tasks locally - must be done on origin node
7. **Filter UI**: Toggle in toolbar, consistent with existing UI patterns
8. **URL-based State**: Filter preference stored in URL param (`?archived=on`) for shareability

## Files Modified in Session 4
- `frontend/src/hooks/useProjectTasks.ts` - Added `includeArchived` option and `UseProjectTasksOptions` interface
- `frontend/src/pages/ProjectTasks.tsx` - Added `showArchived` state from URL params, pass to hook
- `frontend/src/components/layout/Navbar.tsx` - Added archive toggle button with tooltip
- `frontend/src/components/tasks/TaskCard.tsx` - Added archived badge and muted styling
- `frontend/src/i18n/locales/en/tasks.json` - Added filter and badge translations
- `frontend/src/i18n/locales/ja/tasks.json` - Added Japanese translations
- `frontend/src/i18n/locales/ko/tasks.json` - Added Korean translations
- `frontend/src/i18n/locales/es/tasks.json` - Added Spanish translations

## API Endpoints Added
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/tasks/:task_id/archive` | Archive a task (with optional subtasks) |
| POST | `/api/tasks/:task_id/unarchive` | Unarchive a task |
| GET | `/api/tasks/:task_id/children` | Get child tasks for archive dialog |

## Feature Summary
The task archive feature is complete. Users can:
1. Archive tasks via the dropdown menu (removes worktrees, preserves data)
2. Optionally cascade archive to subtasks
3. View archived tasks by enabling the filter toggle in the toolbar
4. See archived tasks with muted styling and "Archived" badge
5. Unarchive tasks via the dropdown menu to restore them
