# Activity Feed Improvements - Progress

## Status: needs-review

## Plan Reference
`/home/david/.claude/plans/temporal-pondering-perlis.md`

## Session 1 Progress (Database Migration & Task Model)

### Completed Items

- [x] **Sync with origin/main** - Already up to date
- [x] **Database Migration** - Created `20251218211726_add_activity_at_to_tasks.sql`
  - [x] Added `activity_at` column to tasks table
  - [x] Backfilled from execution_processes (latest execution start time for each task)
  - [x] Created index `idx_tasks_activity_at` for efficient ordering
  - [x] Migration applied successfully to dev database
- [x] **Task struct update** - Added `activity_at: Option<DateTime<Utc>>` field
- [x] **update_status() update** - Now sets `activity_at = datetime('now', 'subsec')` on status changes
- [x] **Updated all Task SELECT queries** - 11 queries updated to include `activity_at`:
  - `find_by_project_id_with_attempt_status` (query + struct mapping)
  - `find_by_id`
  - `find_by_rowid`
  - `find_by_id_and_project_id`
  - `find_by_shared_task_id`
  - `create` (RETURNING clause)
  - `update` (RETURNING clause)
  - `find_children_by_parent_id`
  - `find_remote_by_project_id`
  - `upsert_remote_task` (RETURNING clause)
  - `archive` (RETURNING clause)
  - `unarchive` (RETURNING clause)
- [x] **SQLx prepare cache** - Updated for offline compilation
- [x] **TypeScript types generated** - `activity_at: Date | null` added to Task type
- [x] **Fixed doc test** - Changed code block from ```` ``` ```` to ```` ```text ```` in `to_enhanced_prompt` docstring

### Tests & Validation

- [x] `cargo check --workspace` - PASS
- [x] `cargo test --workspace` - PASS (all tests)
- [x] `cargo clippy --all --all-targets --all-features -- -D warnings` - PASS
- [x] `npm run generate-types` - PASS
- [x] `npm run lint` (frontend) - PASS (warnings only, no errors)
- [x] `npx tsc --noEmit` - PASS

### Files Modified

**Backend:**
- `crates/db/migrations/20251218211726_add_activity_at_to_tasks.sql` - New migration
- `crates/db/src/models/task.rs` - Added field, updated queries, fixed doctest
- `crates/db/.sqlx/*.json` - Updated query cache

**Shared:**
- `shared/types.ts` - Auto-generated with `activity_at` field

### Technical Notes

- `activity_at` is `Option<DateTime<Utc>>` to handle backfill edge cases
- Backfill uses `created_at` for tasks without execution processes
- Column is set automatically on status changes via `update_status()`
- Field is NOT updated for metadata changes (title/description edits)

---

## Session 2 Progress (SharedTask Model & Sync Flow)

### Completed Items

- [x] **Sync with origin/main** - Merged 2 commits from origin/main
- [x] **Database Migration** - Created `20251218213815_add_activity_at_to_shared_tasks.sql`
  - [x] Added `activity_at` column to shared_tasks table
  - [x] Backfilled from `updated_at` for existing shared tasks
  - [x] Created index `idx_shared_tasks_activity_at` for efficient ordering
  - [x] Migration applied successfully to dev database
- [x] **SharedTask struct update** - Added `activity_at: Option<DateTime<Utc>>` field with `#[ts(type = "Date | null")]`
- [x] **SharedTaskInput struct update** - Added `activity_at: Option<DateTime<Utc>>` field
- [x] **Updated all SharedTask SELECT queries** - 4 queries updated to include `activity_at`:
  - `list_by_remote_project_id`
  - `upsert` (INSERT, ON CONFLICT, and RETURNING)
  - `find_by_id`
  - `find_by_rowid`
- [x] **Updated `convert_remote_task()`** - Added `activity_at` parameter (uses `event.created_at` from ActivityEvent)
- [x] **Updated `SyncTask` struct** - Added `activity_at: Option<DateTime<Utc>>` field
- [x] **Updated `sync_from_shared_task()`** - Now includes `activity_at` in INSERT and ON CONFLICT UPDATE
- [x] **Updated `sync_local_task_for_shared_task()`** - Passes `shared_task.activity_at` to `SyncTask`
- [x] **Updated `Task::upsert_remote_task()`** - Added `activity_at` parameter, includes in INSERT and ON CONFLICT UPDATE
- [x] **Updated all call sites for `convert_remote_task()`**:
  - `processor.rs:process_upsert_event` - Uses `event.created_at`
  - `processor.rs:bulk_sync` - Uses `task.updated_at`
  - `publisher.rs:assign_shared_task` - Uses `remote_task.updated_at`
  - `publisher.rs:share_task` - Uses `remote_task.updated_at`
- [x] **Updated all call sites for `Task::upsert_remote_task()`**:
  - `processor.rs:process_upsert_event` - Uses `event.created_at`
  - `processor.rs:bulk_sync` - Uses `shared_task.activity_at`
  - `node_runner.rs:sync_remote_project_tasks` - Uses `task.updated_at`
  - `routes/tasks.rs:create_remote_task` - Uses `response.task.updated_at`
  - `routes/tasks.rs:update_remote_task` - Uses `response.task.updated_at`
- [x] **SQLx prepare cache** - Updated for db crate
- [x] **TypeScript types generated** - `activity_at: Date | null` added to SharedTask type

### Tests & Validation

- [x] `cargo check --workspace` - PASS
- [x] `cargo test --workspace` - PASS (all 223 tests)
- [x] `cargo clippy --all --all-targets --all-features -- -D warnings` - PASS
- [x] `npm run generate-types` - PASS
- [x] `npm run lint` (frontend) - PASS (pre-existing i18n warnings only, no errors)
- [x] `npx tsc --noEmit` - PASS

### Files Modified

**Backend:**
- `crates/db/migrations/20251218213815_add_activity_at_to_shared_tasks.sql` - New migration
- `crates/db/src/models/shared_task.rs` - Added field, updated queries
- `crates/db/src/models/task.rs` - Updated `SyncTask`, `sync_from_shared_task`, `upsert_remote_task`
- `crates/db/.sqlx/*.json` - Updated query cache
- `crates/services/src/services/share.rs` - Updated `convert_remote_task`, `sync_local_task_for_shared_task`
- `crates/services/src/services/share/processor.rs` - Updated call sites for `convert_remote_task` and `Task::upsert_remote_task`
- `crates/services/src/services/share/publisher.rs` - Updated call sites for `convert_remote_task`
- `crates/services/src/services/node_runner.rs` - Updated call site for `Task::upsert_remote_task`
- `crates/server/src/routes/tasks.rs` - Updated call sites for `Task::upsert_remote_task`

**Shared:**
- `shared/types.ts` - Auto-generated with `activity_at` field in SharedTask

### Technical Notes

- `activity_at` in SharedTask is set from the ActivityEvent's `created_at` timestamp
- For bulk sync operations (no event), `updated_at` is used as a reasonable fallback
- For new task creation via publisher, `updated_at` is used as the initial activity timestamp
- The field propagates through the sync flow: ActivityEvent -> SharedTask -> Task

---

## Session 3 Progress (Activity Feed Query & Frontend)

### Completed Items

- [x] **Sync with origin/main** - Already up to date
- [x] **Updated ActivityFeedItem struct** - Renamed `updated_at` to `activity_at`
- [x] **Updated SQL query** in `ActivityFeed::fetch()`:
  - [x] Changed `t.updated_at` to `COALESCE(t.activity_at, t.updated_at) AS activity_at`
  - [x] Updated ORDER BY to use `COALESCE(t.activity_at, t.updated_at) DESC`
  - [x] Updated completed tasks filter to use `COALESCE(t.activity_at, t.updated_at) > $1`
- [x] **Updated query result mapping** - Changed `rec.updated_at` to `rec.activity_at`
- [x] **SQLx prepare cache** - Regenerated for db crate
- [x] **TypeScript types generated** - `activity_at: string` in ActivityFeedItem
- [x] **Updated frontend component** - Changed `item.updated_at` to `item.activity_at` in `ActivityFeedItem.tsx`

### Tests & Validation

- [x] `cargo check --workspace` - PASS
- [x] `cargo test --workspace` - PASS
- [x] `cargo clippy --all --all-targets --all-features -- -D warnings` - PASS
- [x] `npm run generate-types` - PASS
- [x] `npm run lint` (frontend) - PASS (pre-existing i18n warnings only, no errors)
- [x] `npx tsc --noEmit` - PASS

### Browser Testing (E2E with Playwright)

- [x] **Desktop Light Mode** - Activity feed displays correctly with timestamps
- [x] **Desktop Dark Mode** - Activity feed displays correctly, no contrast issues
- [x] **Mobile Light Mode** - Activity feed responsive and readable
- [x] **Mobile Dark Mode** - Activity feed responsive and readable
- [x] **All Tabs** - All, Review, Running, Done tabs work correctly
- [x] **Console Errors** - Only pre-existing DOM nesting warning (unrelated to our changes)
- [x] **Timestamps** - Displaying correctly ("about 1 hour ago", "about 5 hours ago", "1 day ago", etc.)

### Files Modified

**Backend:**
- `crates/db/src/models/activity_feed.rs` - Updated struct and SQL query
- `crates/db/.sqlx/*.json` - Updated query cache

**Frontend:**
- `frontend/src/components/activity/ActivityFeedItem.tsx` - Updated to use `activity_at`

**Shared:**
- `shared/types.ts` - Auto-generated with `activity_at` field in ActivityFeedItem

### Technical Notes

- Using `COALESCE(t.activity_at, t.updated_at)` for backwards compatibility with existing tasks
- The field is now used for ordering the activity feed
- Frontend component uses `formatDistanceToNow` from date-fns for relative timestamps

---

## Remaining Work (Session 4)

### Session 4: End-to-End Testing
- [ ] Manual testing checklist (if swarm available)
- [ ] Verify remote task appears with correct ordering

## Next Session Recommendations

1. Session 3 is COMPLETE - all code changes implemented and E2E tested
2. Session 4 can proceed with swarm testing if available
3. The feature is ready for code review and merge
