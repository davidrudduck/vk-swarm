# Activity Feed Improvements - Progress

## Status: needs-review

## Plan Reference
`/home/david/.claude/plans/temporal-pondering-perlis.md`

## Session 1 Progress (Database Migration & Task Model)

### Completed Items

- [x] **Sync with origin/main** - Already up to date
- [x] **Database Migration** - Created `20251218211726_add_activity_at_to_tasks.sql`
  - [x] Added `activity_at` column to tasks table
  - [x] Backfilled from execution_processes (latest execution start time for each task)
  - [x] Created index `idx_tasks_activity_at` for efficient ordering
  - [x] Migration applied successfully to dev database
- [x] **Task struct update** - Added `activity_at: Option<DateTime<Utc>>` field
- [x] **update_status() update** - Now sets `activity_at = datetime('now', 'subsec')` on status changes
- [x] **Updated all Task SELECT queries** - 11 queries updated to include `activity_at`:
  - `find_by_project_id_with_attempt_status` (query + struct mapping)
  - `find_by_id`
  - `find_by_rowid`
  - `find_by_id_and_project_id`
  - `find_by_shared_task_id`
  - `create` (RETURNING clause)
  - `update` (RETURNING clause)
  - `find_children_by_parent_id`
  - `find_remote_by_project_id`
  - `upsert_remote_task` (RETURNING clause)
  - `archive` (RETURNING clause)
  - `unarchive` (RETURNING clause)
- [x] **SQLx prepare cache** - Updated for offline compilation
- [x] **TypeScript types generated** - `activity_at: Date | null` added to Task type
- [x] **Fixed doc test** - Changed code block from ```` ``` ```` to ```` ```text ```` in `to_enhanced_prompt` docstring

### Tests & Validation

- [x] `cargo check --workspace` - PASS
- [x] `cargo test --workspace` - PASS (all tests)
- [x] `cargo clippy --all --all-targets --all-features -- -D warnings` - PASS
- [x] `npm run generate-types` - PASS
- [x] `npm run lint` (frontend) - PASS (warnings only, no errors)
- [x] `npx tsc --noEmit` - PASS

### Files Modified

**Backend:**
- `crates/db/migrations/20251218211726_add_activity_at_to_tasks.sql` - New migration
- `crates/db/src/models/task.rs` - Added field, updated queries, fixed doctest
- `crates/db/.sqlx/*.json` - Updated query cache

**Shared:**
- `shared/types.ts` - Auto-generated with `activity_at` field

### Technical Notes

- `activity_at` is `Option<DateTime<Utc>>` to handle backfill edge cases
- Backfill uses `created_at` for tasks without execution processes
- Column is set automatically on status changes via `update_status()`
- Field is NOT updated for metadata changes (title/description edits)

## Remaining Work (Sessions 2-4)

### Session 2: SharedTask Model & Sync Flow
- [ ] Add migration for `shared_tasks.activity_at` column
- [ ] Add `activity_at` field to SharedTask and SharedTaskInput structs
- [ ] Update `SharedTask::upsert()` to include field
- [ ] Update sync flow to pass activity_at through

### Session 3: Activity Feed Query & Frontend
- [ ] Update activity feed SQL query to use `activity_at`
- [ ] Update ActivityFeedItem struct
- [ ] Update frontend component

### Session 4: End-to-End Testing
- [ ] Manual testing checklist
- [ ] Verify ordering in Running/Review/Done tabs

## Next Session Recommendations

1. Start Session 2: SharedTask Model & Sync Flow
2. Focus on `crates/db/src/models/shared_task.rs` first
3. Then update sync flow in `crates/services/src/services/share/processor.rs`
4. Run tests after each file modification
