# Task Archive Feature - Progress Tracker

## Status: in-progress

## Overview
Implementing task archiving functionality to allow users to archive completed tasks and free up disk space by cleaning up associated worktrees.

## Completed Items

### Session 1: Database Schema + Model Methods ✅
- [x] Created migration `20251217000000_add_archived_to_tasks.sql`
  - Added `archived_at` nullable timestamp column
  - Added index `idx_tasks_archived_at` for efficient queries
- [x] Added `archived_at` field to `Task` struct in `crates/db/src/models/task.rs`
- [x] Updated all SELECT queries to include `archived_at` field
- [x] Added `include_archived: bool` parameter to `find_by_project_id_with_attempt_status()`
- [x] Added `Task::archive(pool, id)` method
- [x] Added `Task::unarchive(pool, id)` method
- [x] Added `Task::archive_many(pool, ids)` method for subtask cascade
- [x] Updated `TaskWithProjectInfo` in `all_tasks.rs` with `archived_at` field
- [x] Updated `AllTasksResponse::fetch()` with `include_archived` parameter
- [x] Updated route handlers in `all_tasks.rs` and `tasks.rs` with query params
- [x] Updated WebSocket handler to pass `include_archived` through stream
- [x] Updated event service to include archived tasks in real-time updates
- [x] Updated share service to exclude archived tasks from Hive sharing
- [x] Regenerated TypeScript types (`shared/types.ts`)
- [x] Updated SQLx offline cache
- [x] All checks pass (`npm run check`)
- [x] All tests pass (except pre-existing doctest issue)

### Session 2: API Endpoints ✅
- [x] Created `POST /api/tasks/:task_id/archive` endpoint
  - Archives task by setting `archived_at` timestamp
  - Validates task is not remote (remote tasks cannot be archived locally)
  - Validates task is not already archived
  - Validates no running execution processes
  - Returns 202 Accepted with `ArchiveTaskResponse`
- [x] Created `POST /api/tasks/:task_id/unarchive` endpoint
  - Clears `archived_at` timestamp
  - Validates task is not remote
  - Validates task is currently archived
  - Returns 200 OK with updated `Task`
- [x] Added `include_subtasks: bool` parameter to archive endpoint (defaults to `true`)
  - Fetches children via `Task::find_children_by_parent_id`
  - Validates no child has running processes
  - Archives all children with `Task::archive_many`
  - Returns count of archived subtasks in response
- [x] Created `GET /api/tasks/:task_id/children` endpoint
  - Returns list of child tasks for archive dialog UI
- [x] Implemented worktree cleanup on archive
  - Gathers all task attempts for task and subtasks
  - Collects `WorktreeCleanup` data with worktree paths
  - Spawns background cleanup task (same pattern as delete_task)
- [x] Added `ArchiveTaskRequest` and `ArchiveTaskResponse` types
- [x] Registered types in `generate_types.rs` for TypeScript generation
- [x] Added routes to router: `/archive`, `/unarchive`, `/children`
- [x] Added analytics tracking for archive/unarchive events
- [x] Regenerated TypeScript types (`shared/types.ts`)
- [x] All checks pass (`npm run check`)
- [x] All tests pass (36 passed, pre-existing doctest issue)
- [x] API tested via curl - all endpoints working correctly
- [x] Frontend verified loading in browser (Playwright)

### Session 3: Frontend Archive Dialog + Actions ✅
- [x] Added `tasksApi.archive()`, `tasksApi.unarchive()`, `tasksApi.getChildren()` to `frontend/src/lib/api.ts`
- [x] Created `ArchiveTaskConfirmationDialog` component in `frontend/src/components/dialogs/tasks/`
  - Shows task title in description
  - Info alert explaining worktree cleanup and data preservation
  - Fetches children on mount and shows checkbox for subtask cascading
  - Cancel and Archive Task buttons with loading states
- [x] Added archive/unarchive handlers to `actions-dropdown.tsx`
  - Archive option shown for non-archived tasks
  - Unarchive option shown for archived tasks
  - Both disabled for remote tasks
- [x] Added translations to `frontend/src/i18n/locales/en/tasks.json`
  - `actionsMenu.archive` and `actionsMenu.unarchive` menu items
  - `archiveDialog.*` translations for dialog content
- [x] All checks pass (`npm run check`)
- [x] E2E tested in browser with Playwright
  - Verified Archive menu item appears in dropdown
  - Verified Archive dialog opens with correct content
  - Verified Cancel button closes dialog

## Remaining Work

### Session 4: Filter Toggle + Styling
- [ ] Add "Show Archived" toggle to task list toolbar
- [ ] Persist filter preference (localStorage or URL param)
- [ ] Add visual styling for archived tasks (muted/greyed)
- [ ] Add archived badge/indicator
- [ ] E2E browser testing with Playwright

## Design Decisions Made
1. **Archive vs Delete**: Archive preserves all DB records, only sets `archived_at` timestamp
2. **Worktree Cleanup**: Archiving triggers immediate worktree cleanup (user has 5-10GB per worktree)
3. **Subtask Handling**: User choice with checkbox, default is to cascade archive to subtasks
4. **Auto-archive**: Manual only via dropdown menu (no automatic archiving)
5. **Filter Default**: Hide archived tasks by default, toggle to show
6. **Remote Tasks**: Cannot archive/unarchive remote tasks locally - must be done on origin node

## Files Modified in Session 3
- `frontend/src/lib/api.ts` - Added archive(), unarchive(), getChildren() methods to tasksApi
- `frontend/src/components/dialogs/tasks/ArchiveTaskConfirmationDialog.tsx` - New dialog component
- `frontend/src/components/ui/actions-dropdown.tsx` - Added archive/unarchive menu items and handlers
- `frontend/src/i18n/locales/en/tasks.json` - Added translations

## API Endpoints Added
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/tasks/:task_id/archive` | Archive a task (with optional subtasks) |
| POST | `/api/tasks/:task_id/unarchive` | Unarchive a task |
| GET | `/api/tasks/:task_id/children` | Get child tasks for archive dialog |

## Next Session Recommendations
1. Start with Session 4: Filter Toggle + Styling
2. Add "Show Archived" toggle to toolbar (follow existing filter patterns)
3. Update WebSocket connection to include `include_archived` query param
4. Add visual styling for archived tasks (muted appearance, badge)
5. Test full archive/unarchive flow end-to-end
