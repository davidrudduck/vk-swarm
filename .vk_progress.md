# Performance Fixes - Session 1: Bulk Database Operations

## Status: needs-review

## Overview
Replaced N+1 query patterns with single bulk SQL operations using SQLx `QueryBuilder` for improved database performance.

## Completed Items

### Task::archive_many() ✅
- [x] Added `QueryBuilder` import to sqlx imports
- [x] Replaced loop-based UPDATE with single bulk UPDATE using `IN (...)` clause
- [x] Added documentation explaining O(1) vs O(n) improvement
- **File:** `crates/db/src/models/task.rs:889-906`

### Task::delete_stale_remote_tasks() ✅
- [x] Replaced fetch-all + loop with single DELETE using `NOT IN (...)` clause
- [x] Added documentation explaining O(1) vs O(n+m) improvement
- **File:** `crates/db/src/models/task.rs:930-956`

### Project::delete_stale_remote_projects() ✅
- [x] Added `QueryBuilder` import to sqlx imports
- [x] Replaced fetch-all + loop with single DELETE using `NOT IN (...)` clause
- [x] Added documentation explaining O(1) vs O(n+m) improvement
- **File:** `crates/db/src/models/project.rs:632-657`

## Validation Results

### cargo test -p db ✅
```text
running 52 tests
test result: ok. 52 passed; 0 failed; 0 ignored
```

### npm run check ✅
- Frontend TypeScript check: passed
- Backend cargo check: passed

## Files Changed

| File | Change |
|------|--------|
| `crates/db/src/models/task.rs` | Added QueryBuilder import, refactored `archive_many()` and `delete_stale_remote_tasks()` |
| `crates/db/src/models/project.rs` | Added QueryBuilder import, refactored `delete_stale_remote_projects()` |

## Performance Impact

| Function | Before | After |
|----------|--------|-------|
| `archive_many(100 tasks)` | 100 UPDATE queries | 1 UPDATE query |
| `delete_stale_remote_tasks(50 remote, 10 stale)` | 1 SELECT + 10 DELETE queries | 1 DELETE query |
| `delete_stale_remote_projects(20 remote, 5 stale)` | 1 SELECT + 5 DELETE queries | 1 DELETE query |

## Next Steps (Session 2)
- Implement recursive CTE for `TaskVariable::find_inherited()`
- Replace parent chain traversal loop with single SQL query

## Next Steps (Session 3)
- Add database indexes for running processes and parent_task_id
- Implement visibility-based polling in frontend hooks
