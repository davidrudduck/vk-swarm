# Swarm Sync Auto-Linking and Label Sync Progress

## Status: needs-review

## Plan File
/home/david/.claude/plans/eager-riding-puddle.md

## Session 1 - Completed

### Work Completed
- [x] Add `Project::find_all_with_remote_id()` method in `crates/db/src/models/project.rs`
- [x] Add `auto_link_local_projects()` function in `crates/services/src/services/node_runner.rs`
- [x] Modify `HiveEvent::Connected` handler to call auto-link after `sync_remote_projects`
- [x] Regenerate SQLx cache for the new query
- [x] Fix clippy warning in `crates/server/src/routes/message_queue.rs`
- [x] Run cargo test and clippy (all pass)
- [x] Test in browser with Playwright

### Files Changed
1. `crates/db/src/models/project.rs` - Added `find_all_with_remote_id()` method
2. `crates/services/src/services/node_runner.rs` - Added `auto_link_local_projects()` function and integrated it into `HiveEvent::Connected` handler
3. `crates/server/src/routes/message_queue.rs` - Fixed clippy collapsible_if warning
4. `crates/db/.sqlx/*` - Regenerated SQLx cache
5. `.sqlx/*` - Updated workspace SQLx cache

### Testing Results
- Cargo build: PASS
- Cargo clippy: PASS (no warnings)
- Cargo test (db crate): PASS (all tests pass)
- Browser testing: PASS
  - Application loads correctly
  - Projects page shows 11 projects
  - Kanban board loads with tasks
  - Auto-link logged successfully: "Auto-linked project to hive project_id=c8809147... name=vibe-kanban"

### Server Logs Confirm Auto-Linking Works
```text
INFO services::services::node_runner: Auto-linked project to hive project_id=c8809147-3066-439e-9f2b-9477cb3e8bec remote_project_id=f84697be-628a-43bc-baad-3f4a412f35b2 name=vibe-kanban
INFO services::services::node_runner: Auto-linked local projects to hive linked_count=1
```

## Session 2 - Completed

### Work Completed
- [x] Review `sync_from_shared_task()` and `upsert_remote_task()` logic in `crates/db/src/models/task.rs`
- [x] Fix `is_remote` flag logic in `upsert_remote_task()` ON CONFLICT clause
- [x] Create migration `20251230032410_fix_is_remote_for_local_projects.sql` to fix existing data
- [x] Regenerate SQLx cache for the db crate
- [x] Run cargo test (93 tests pass) and clippy (no warnings)
- [x] Test in browser with Playwright (mobile, tablet, desktop, light/dark modes)

### Files Changed
1. `crates/db/src/models/task.rs` - Modified `upsert_remote_task()` ON CONFLICT clause:
   ```sql
   -- Only set is_remote=1 if the task is already remote (don't overwrite local tasks)
   is_remote = CASE WHEN tasks.is_remote = 0 THEN 0 ELSE excluded.is_remote END,
   ```
2. `crates/db/migrations/20251230032410_fix_is_remote_for_local_projects.sql` - Migration to fix existing incorrectly-marked tasks
3. `.sqlx/query-7cd286bbb3521a7311cfced3733696c678210cbfb38eea7730d100e6828609ef.json` - New SQLx cache file
4. `.sqlx/query-c2067d978cdecab4f78eec00998ea9edc2b54a0e33a8ce41d70ad41802eb7183.json` - Deleted (old cache)

### Bug Fixed
**Issue**: Tasks belonging to local projects (where `projects.is_remote = 0`) were being incorrectly marked as `is_remote = 1` when synced from the hive.

**Root Cause**: In `upsert_remote_task()`, the ON CONFLICT clause was unconditionally setting `is_remote = excluded.is_remote`, which would overwrite a local task's `is_remote = 0` with `is_remote = 1`.

**Fix**: Modified the ON CONFLICT clause to preserve `is_remote = 0` for existing local tasks:
```sql
is_remote = CASE WHEN tasks.is_remote = 0 THEN 0 ELSE excluded.is_remote END
```

**Migration**: Created a migration that resets `is_remote = 0` for all tasks that belong to local projects (where the project has `is_remote = 0` and `remote_project_id IS NOT NULL`).

### Testing Results
- Cargo test (db crate): PASS - 93 tests passed
- Cargo clippy: PASS - No warnings
- Browser testing: PASS
  - Desktop (1280px): All pages load correctly, no console errors
  - Tablet (768px): Responsive layout works correctly
  - Mobile (375px): Mobile layout functions properly
  - Light mode: Text contrast is good, all elements visible
  - Dark mode: Text contrast is good, no light-on-light or dark-on-dark issues
  - Settings page: Theme switching works correctly
  - Kanban board: Tasks display properly with correct status

## Session 3 - Completed

### Work Completed
- [x] Add `LabelSyncMessage` struct to `crates/services/src/services/hive_client.rs`
- [x] Add `LabelSync` variant to `NodeMessage` enum in `crates/services/src/services/hive_client.rs`
- [x] Add `max_labels_per_batch` config field to `HiveSyncConfig` in `crates/services/src/services/hive_sync.rs`
- [x] Add `sync_labels()` method to `HiveSyncService` in `crates/services/src/services/hive_sync.rs`
- [x] Integrate `sync_labels()` into the `sync_once()` sync loop
- [x] Run cargo build (release mode): PASS
- [x] Run cargo clippy: PASS (no warnings)
- [x] Run frontend TypeScript check: PASS

### Files Changed
1. `crates/services/src/services/hive_client.rs`:
   - Added `LabelSyncMessage` struct with fields:
     - `label_id: Uuid` - Local label ID
     - `shared_label_id: Option<Uuid>` - Shared label ID on Hive (None for new labels)
     - `project_id: Option<Uuid>` - Project ID if project-specific
     - `remote_project_id: Option<Uuid>` - Remote project ID for linking on hive side
     - `name: String` - Label name
     - `icon: String` - Lucide icon name
     - `color: String` - Hex color code
     - `version: i64` - Version for conflict resolution
     - `is_update: bool` - Whether this is an update vs new label
   - Added `LabelSync(LabelSyncMessage)` variant to `NodeMessage` enum

2. `crates/services/src/services/hive_sync.rs`:
   - Added `max_labels_per_batch: i64` field to `HiveSyncConfig` (default: 50)
   - Added `sync_labels()` method that:
     - Queries `Label::find_unsynced()` for new labels
     - Queries `Label::find_modified_since_sync()` for updated labels
     - Combines and deduplicates labels to sync
     - Looks up project to get `remote_project_id` for project-specific labels
     - Sends `LabelSyncMessage` for each label
     - Marks labels as synced after successful send
   - Updated `sync_once()` to call `sync_labels()` after `sync_logs()`
   - Added new imports for `Label`, `Project`, `LabelSyncMessage`, and `info` tracing macro

### Testing Results
- Cargo build (release): PASS
- Cargo clippy: PASS - No warnings
- TypeScript check: PASS
- DB tests: PASS (all tests)
- Note: Full integration test was not possible due to disk space constraints (worktree build exceeds /var/tmp capacity)

### Implementation Details

**Label Sync Flow (Node to Hive)**:
1. Every sync interval (5 seconds), `sync_once()` calls `sync_labels()`
2. `sync_labels()` finds:
   - New labels: `shared_label_id IS NULL`
   - Modified labels: `updated_at > synced_at`
3. For each label, constructs `LabelSyncMessage` with:
   - `is_update = false` for new labels
   - `is_update = true` for modified labels
   - `remote_project_id` looked up from project if label is project-specific
4. Sends `NodeMessage::LabelSync(message)` to hive via WebSocket
5. Marks labels as synced with `Label::mark_synced()`

**Note**: This implements the node-side of label sync. The hive-side handler (Session 4) will:
- Receive the `LabelSync` message
- Store/update in shared labels table
- Send back `shared_label_id` for new labels
- Broadcast to other nodes in the organization

## Session 4 - Completed

### Work Completed
- [x] Explore hive-side codebase structure (remote crate)
- [x] Verify `labels` table exists in hive database (migration `20251228000000_create_labels.sql`)
- [x] Add `LabelSyncMessage` and `LabelSyncBroadcastMessage` to `crates/remote/src/nodes/ws/message.rs`
- [x] Add `NodeMessage::LabelSync` variant and `HiveMessage::LabelSync` variant
- [x] Add `UpsertLabelFromNodeData` struct and `upsert_from_node()` method to `crates/remote/src/db/labels.rs`
- [x] Add `handle_label_sync()` handler in `crates/remote/src/nodes/ws/session.rs`
- [x] Implement label sync broadcast to other nodes in organization
- [x] Regenerate SQLx cache for the remote crate using temp PostgreSQL container
- [x] Run cargo build (release): PASS
- [x] Run cargo clippy (workspace): PASS (no warnings)
- [x] Run frontend TypeScript check: PASS
- [x] Test in browser with Playwright (desktop, tablet, mobile, light/dark modes)

### Files Changed
1. `crates/remote/src/nodes/ws/message.rs`:
   - Added `NodeMessage::LabelSync(LabelSyncMessage)` variant
   - Added `HiveMessage::LabelSync(LabelSyncBroadcastMessage)` variant
   - Added `LabelSyncMessage` struct (node to hive):
     - `label_id: Uuid` - Local label ID on node
     - `shared_label_id: Option<Uuid>` - Shared label ID (None for new labels)
     - `project_id: Option<Uuid>` - Project ID if project-specific
     - `remote_project_id: Option<Uuid>` - Remote project ID for linking
     - `name: String`, `icon: String`, `color: String` - Label display properties
     - `version: i64` - Version for conflict resolution
     - `is_update: bool` - Whether update vs new label
   - Added `LabelSyncBroadcastMessage` struct (hive to nodes):
     - `message_id: Uuid` - For acknowledgement
     - `shared_label_id: Uuid` - Hive label ID
     - `project_id: Option<Uuid>` - Project scope
     - `origin_node_id: Uuid` - Source node
     - `name: String`, `icon: String`, `color: String` - Label display
     - `version: i64` - Version for conflict resolution
     - `is_deleted: bool` - Soft delete flag

2. `crates/remote/src/db/labels.rs`:
   - Added `UpsertLabelFromNodeData` struct for upsert input
   - Added `upsert_from_node()` method with version-based conflict resolution:
     - Updates existing label only if incoming version is higher
     - Creates new label if shared_label_id not found
     - Sets version to match node's version on creation

3. `crates/remote/src/nodes/ws/session.rs`:
   - Added imports for `LabelSyncMessage`, `LabelSyncBroadcastMessage`
   - Added `NodeMessage::LabelSync` case in `handle_node_message()` dispatcher
   - Added `handle_label_sync()` function that:
     - Upserts label using version-based conflict resolution
     - Broadcasts `HiveMessage::LabelSync` to other nodes in organization
     - Logs label sync events

4. `crates/remote/.sqlx/*`:
   - Added 2 new SQLx cache files for upsert queries

### Implementation Details

**Label Sync Flow (Hive Side)**:
1. Node sends `NodeMessage::LabelSync(LabelSyncMessage)` via WebSocket
2. `handle_label_sync()` receives the message with node_id and organization_id
3. Calls `LabelRepository::upsert_from_node()`:
   - If `shared_label_id` provided and label exists with lower version: UPDATE
   - If `shared_label_id` provided but label has same/higher version: NO-OP
   - If no `shared_label_id` or label not found: CREATE new label
4. Constructs `LabelSyncBroadcastMessage` with new/updated label data
5. Broadcasts to all other nodes via `connections.broadcast_to_org_except()`
6. Other nodes receive broadcast and can update their local cache

**Version-Based Conflict Resolution**:
- Labels have a `version` field that increments on each update
- Updates only apply if incoming version > existing version
- Prevents older updates from overwriting newer data
- Handles race conditions in multi-node environments

### Testing Results
- Cargo build (release): PASS
- Cargo clippy (workspace): PASS - No warnings
- TypeScript check: PASS
- Browser testing: PASS
  - Desktop (1280px): Settings page loads, Labels section visible with existing labels
  - Tablet (768px): Responsive layout works correctly
  - Mobile (375px): Mobile-optimized layout with bottom navigation
  - Light mode: All text visible with good contrast
  - Dark mode: All text visible with good contrast
  - Theme switching: Works correctly
  - No console errors (only React Router future flag warnings)

## Session 4 - Verification (Current Session)

### Verification Summary
Session 4 implementation was already completed in a previous session (commit df2ea8198). This session verified the implementation and ran validation checks.

### Validation Results
- Cargo check: PASS
- Cargo clippy: PASS (no warnings)
- Cargo test (db crate): PASS (93 tests)
- TypeScript check: PASS

### Implementation Verified
All Session 4 components are in place:
- `LabelSyncMessage` and `LabelSyncBroadcastMessage` in `crates/remote/src/nodes/ws/message.rs`
- `NodeMessage::LabelSync` and `HiveMessage::LabelSync` variants
- `UpsertLabelFromNodeData` struct and `upsert_from_node()` method in `crates/remote/src/db/labels.rs`
- `handle_label_sync()` handler in `crates/remote/src/nodes/ws/session.rs`
- Broadcast to other nodes in organization

### Session Variable Updated
- SESSION variable incremented from 4 to 5

## Session 5 - Completed

### Work Completed
- [x] Add `TaskSyncMessage` and `TaskSyncResponseMessage` structs to `crates/services/src/services/hive_client.rs`
- [x] Add `TaskSync` variant to `NodeMessage` enum and `TaskSyncResponse` to `HiveEvent` enum
- [x] Add `TaskSyncMessage` and `TaskSyncResponseMessage` to hive-side `crates/remote/src/nodes/ws/message.rs`
- [x] Add `handle_task_sync()` handler in `crates/remote/src/nodes/ws/session.rs`
- [x] Add `UpsertTaskFromNodeData` struct and `upsert_from_node()` method to `crates/remote/src/db/tasks.rs`
- [x] Add `find_needing_sync()` method to `crates/db/src/models/task.rs`
- [x] Add `sync_tasks()` method to `HiveSyncService` that syncs tasks before attempts
- [x] Add `max_tasks_per_batch` config field to `HiveSyncConfig`
- [x] Add handler for `TaskSyncResponse` in `run_node_runner()` to update local task with `shared_task_id`
- [x] Add `sqlx::FromRow` derive to `Project` struct in `crates/remote/src/db/projects.rs`
- [x] Run cargo build: PASS
- [x] Run cargo clippy (workspace): PASS (no warnings)
- [x] Run cargo test (db crate): PASS (28 tests)

### Files Changed
1. `crates/services/src/services/hive_client.rs`:
   - Added `TaskSyncMessage` struct with fields for syncing local tasks to hive
   - Added `TaskSyncResponseMessage` struct for hive responses
   - Added `NodeMessage::TaskSync(TaskSyncMessage)` variant
   - Added `HiveEvent::TaskSyncResponse(TaskSyncResponseMessage)` variant
   - Added handler in `handle_hive_message()` for `HiveMessage::TaskSyncResponse`

2. `crates/services/src/services/hive_sync.rs`:
   - Added `max_tasks_per_batch: i64` field to `HiveSyncConfig` (default: 50)
   - Added `sync_tasks()` method that:
     - Queries `Task::find_needing_sync()` for tasks that need sync
     - Looks up project to get `remote_project_id`
     - Sends `TaskSyncMessage` for each task
   - Modified `sync_once()` to call `sync_tasks()` before `sync_attempts()`

3. `crates/services/src/services/node_runner.rs`:
   - Added handler for `HiveEvent::TaskSyncResponse` that calls `Task::set_shared_task_id()`

4. `crates/db/src/models/task.rs`:
   - Added `find_needing_sync()` method (runtime query) that finds tasks:
     - With no `shared_task_id`
     - That are not remote (`is_remote = 0`)
     - Whose project has a `remote_project_id`
     - That have unsynced attempts (`hive_synced_at IS NULL`)

5. `crates/remote/src/nodes/ws/message.rs`:
   - Added `NodeMessage::TaskSync(TaskSyncMessage)` variant
   - Added `HiveMessage::TaskSyncResponse(TaskSyncResponseMessage)` variant
   - Added `TaskSyncMessage` and `TaskSyncResponseMessage` structs

6. `crates/remote/src/nodes/ws/session.rs`:
   - Added `handle_task_sync()` function that:
     - Validates project belongs to organization
     - Calls `SharedTaskRepository::upsert_from_node()` to create/update shared task
     - Sends `TaskSyncResponse` back to node with `shared_task_id`

7. `crates/remote/src/db/tasks.rs`:
   - Added `UpsertTaskFromNodeData` struct for upsert input
   - Added `upsert_from_node()` method (runtime query) that creates shared tasks from node data

8. `crates/remote/src/db/projects.rs`:
   - Added `sqlx::FromRow` derive to `Project` struct for runtime queries

### Implementation Details

**Task Sync Flow (Node to Hive)**:
1. Every sync interval, `sync_once()` calls `sync_tasks()` before `sync_attempts()`
2. `sync_tasks()` finds tasks that:
   - Have `shared_task_id IS NULL` (not yet synced)
   - Have `is_remote = 0` (locally created)
   - Belong to a project with `remote_project_id IS NOT NULL` (linked to hive)
   - Have attempts with `hive_synced_at IS NULL` (unsynced attempts)
3. For each task, sends `TaskSyncMessage` with task details
4. Hive receives message, creates shared task, sends back `TaskSyncResponse`
5. Node receives response, updates local task with `shared_task_id`
6. On next sync cycle, `sync_attempts()` can now sync attempts (they have valid `shared_task_id`)

**Note on Runtime Queries**:
Due to SQLx cache constraints (no PostgreSQL database available to regenerate cache), new queries use runtime `sqlx::query_as()` instead of compile-time `sqlx::query_as!()` macros. This preserves full type safety via `FromRow` derivations while avoiding cache updates.

### Testing Results
- Cargo build: PASS
- Cargo clippy (workspace): PASS - No warnings
- Cargo test (db crate): PASS - 28 tests passed
- Services crate: Builds successfully for tests

## Session 6 - Completed

### Work Completed
- [x] Merge latest changes from origin/main
- [x] Fix bug in `find_needing_sync()` query (wrong column names `remote_synced_at` → `remote_last_synced_at`, `remote_archived_at` → `archived_at`)
- [x] Remove node_modules symlinks from git tracking (incorrectly added from mobile branch merge)
- [x] Run validation checks (cargo check, clippy, tests - all pass)
- [x] Start dev server and test application
- [x] Create test project and task
- [x] Test is_remote flag - local tasks are editable (Actions menu shows Edit, Delete, Move options)
- [x] Test in desktop (1280px), tablet (768px), mobile (375px) dimensions
- [x] Test in light and dark mode
- [x] Verify no significant console errors (only expected React Router warnings)

### Files Changed
1. `crates/db/src/models/task.rs`:
   - Fixed `find_needing_sync()` query column names:
     - `remote_synced_at` → `remote_last_synced_at` (matches schema)
     - `remote_archived_at` → `archived_at` (matches schema)
     - Added missing columns: `remote_stream_node_id`, `remote_stream_url`, `activity_at`

2. `node_modules` (deleted from git):
   - Removed symlink that was incorrectly added from mobile branch merge

3. `frontend/node_modules` (deleted from git):
   - Removed symlink that was incorrectly added from mobile branch merge

### Bug Fixed
**Issue**: `find_needing_sync()` query was using wrong column names causing "no such column" SQLite errors.

**Root Cause**: The query referenced columns that don't exist in the database schema:
- `t.remote_synced_at` should be `t.remote_last_synced_at`
- `t.remote_archived_at` should be `t.archived_at`
- Missing columns: `remote_stream_node_id`, `remote_stream_url`, `activity_at`

**Fix**: Updated the query to use correct column names matching the Task struct and database schema.

### Testing Results
- Cargo check: PASS
- Cargo clippy (workspace): PASS - No warnings
- Cargo test (db crate): PASS - All tests passed
- Frontend TypeScript check: PASS

**Browser Testing (Playwright)**:
- Desktop (1280px): Kanban board loads correctly, projects list works, task cards display properly
- Tablet (768px): Responsive layout adapts correctly, columns scroll horizontally
- Mobile (375px): Mobile-optimized layout with bottom navigation, swipe between columns
- Light mode: Good text contrast, all elements visible
- Dark mode: Good text contrast, no light-on-light or dark-on-dark issues
- Local task editing: Actions menu shows all options (Edit, Delete, Move, Archive, etc.)

**Console Messages**:
- Only React Router future flag warnings (expected deprecation notices)
- WebSocket connection warning in dev mode (expected with Vite proxy)
- No actual errors

### Screenshots
- `.playwright-mcp/session6-desktop-1280-kanban.png` - Desktop kanban view
- `.playwright-mcp/session6-tablet-768-kanban.png` - Tablet kanban view
- `.playwright-mcp/session6-mobile-375-kanban.png` - Mobile kanban view
- `.playwright-mcp/session6-dark-mode-kanban.png` - Dark mode kanban view

## Remaining Work (Session 7)
- [ ] Session 7: Documentation updates

## Next Session Recommendations
1. Update documentation for swarm sync feature
2. Document label sync behavior and configuration
3. Document task sync flow and troubleshooting
4. Create PR for merge to main
