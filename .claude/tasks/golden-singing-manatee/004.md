---
name: Add LogBatcher to Container and call finish on exit
status: done
created: 2026-01-08T05:59:37Z
updated: 2026-01-09T05:50:00Z
depends_on: [003]
conflicts_with: [005]
---

# Task: Add LogBatcher to Container and call finish on exit

## Description
Modify the Container struct to hold a reference to the LogBatcher handle and call `finish(execution_id)` when execution completes, before calling `push_finished()`. This ensures all buffered logs are persisted.

## Acceptance Criteria
- [x] LogBatcher handle accessible in Container or spawn_exit_monitor
- [x] `log_batcher.finish(exec_id).await` called before `push_finished()`
- [x] No logs lost on fast execution completion
- [x] Existing executor tests still pass

## Technical Details
- **File**: `crates/local-deployment/src/container.rs`
- **Location**: Around line 631 in `spawn_exit_monitor` function

```rust
// In spawn_exit_monitor, before push_finished():
if let Some(log_batcher) = &self.log_batcher_handle {
    log_batcher.finish(exec_id).await;
}

// Existing code:
msg_arc.push_finished();
```

- May need to add `log_batcher_handle: Option<LogBatcherHandle>` field to Container struct
- Or pass it as a parameter to spawn_exit_monitor

## Dependencies
- [x] Task 003: Write test for log batcher finish signal

## Effort Estimate
- Size: M
- Hours: 2

## Definition of Done
- [x] Code implemented
- [x] Tests from Task 003 pass
- [x] Existing tests pass
- [ ] Manual verification with short execution

## Implementation Notes (2026-01-09)
- `LocalContainerService` already had `log_batcher: LogBatcherHandle` field and `log_batcher()` accessor
- Added `log_batcher.finish(exec_id).await` call in two locations:
  1. `spawn_exit_monitor` (line 630-633): before `push_finished()` in msg store cleanup
  2. `stop_execution` (line 1429-1432): before `push_finished()` for consistency
- All tests pass:
  - local-deployment: 10 tests
  - services log_batcher_test: 3 tests (Task 003)
  - services: all tests pass
  - db: all tests pass
  - utils: 69 tests
