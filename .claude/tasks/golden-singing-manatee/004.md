---
name: Add LogBatcher to Container and call finish on exit
status: open
created: 2026-01-08T05:59:37Z
updated: 2026-01-08T05:59:37Z
depends_on: [003]
conflicts_with: [005]
---

# Task: Add LogBatcher to Container and call finish on exit

## Description
Modify the Container struct to hold a reference to the LogBatcher handle and call `finish(execution_id)` when execution completes, before calling `push_finished()`. This ensures all buffered logs are persisted.

## Acceptance Criteria
- [ ] LogBatcher handle accessible in Container or spawn_exit_monitor
- [ ] `log_batcher.finish(exec_id).await` called before `push_finished()`
- [ ] No logs lost on fast execution completion
- [ ] Existing executor tests still pass

## Technical Details
- **File**: `crates/local-deployment/src/container.rs`
- **Location**: Around line 631 in `spawn_exit_monitor` function

```rust
// In spawn_exit_monitor, before push_finished():
if let Some(log_batcher) = &self.log_batcher_handle {
    log_batcher.finish(exec_id).await;
}

// Existing code:
msg_arc.push_finished();
```

- May need to add `log_batcher_handle: Option<LogBatcherHandle>` field to Container struct
- Or pass it as a parameter to spawn_exit_monitor

## Dependencies
- [ ] Task 003: Write test for log batcher finish signal

## Effort Estimate
- Size: M
- Hours: 2

## Definition of Done
- [ ] Code implemented
- [ ] Tests from Task 003 pass
- [ ] Existing tests pass
- [ ] Manual verification with short execution
