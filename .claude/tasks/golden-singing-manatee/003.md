---
name: Write test for log batcher finish signal
status: open
created: 2026-01-08T05:59:37Z
updated: 2026-01-08T05:59:37Z
depends_on: []
conflicts_with: []
---

# Task: Write test for log batcher finish signal

## Description
Create a test to verify that calling `log_batcher.finish(execution_id)` properly flushes all buffered logs to the database, even when the batch size threshold hasn't been reached.

## Acceptance Criteria
- [ ] Test file created/updated: `crates/services/tests/log_batcher_test.rs`
- [ ] Test: `test_finish_flushes_remaining_logs` - Add logs, call finish, verify all persisted
- [ ] Test: `test_finish_idempotent` - Calling finish twice doesn't duplicate
- [ ] Test: `test_finish_no_pending` - finish() on empty buffer is safe

## Technical Details
- **File**: `crates/services/tests/log_batcher_test.rs` (new or existing)
- Test pattern:
  1. Create LogBatcher
  2. Add logs without reaching batch size
  3. Call finish()
  4. Verify all logs in database

```rust
#[tokio::test]
async fn test_finish_flushes_remaining_logs() {
    let (handle, _) = LogBatcher::spawn(pool.clone());
    let exec_id = Uuid::new_v4();

    for i in 0..10 {
        handle.add_log(exec_id, LogMsg::Stdout(format!("line {}", i))).await;
    }

    handle.finish(exec_id).await;
    tokio::time::sleep(Duration::from_millis(100)).await;

    let logs = ExecutionProcessLogs::find_by_execution_id(&pool, exec_id).await.unwrap();
    assert!(logs.logs.lines().count() >= 10);
}
```

## Dependencies
- [ ] None (test can be written first, TDD style)

## Effort Estimate
- Size: S
- Hours: 1.5

## Definition of Done
- [ ] Tests written
- [ ] Tests compile (may fail initially until implementation)
