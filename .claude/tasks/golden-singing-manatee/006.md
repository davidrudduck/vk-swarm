---
name: Modify normalize_logs to return JoinHandle
status: completed
created: 2026-01-08T05:59:37Z
updated: 2026-01-09T08:45:00Z
depends_on: [005]
conflicts_with: [007]
---

# Task: Modify normalize_logs to return JoinHandle

## Description
Modify the `normalize_logs` function in Cursor and OpenCode executors to return a `JoinHandle<()>` instead of spawning fire-and-forget tasks. This allows the caller to await completion.

## Acceptance Criteria
- [x] `cursor.rs` normalize_logs returns `JoinHandle<()>`
- [x] `opencode.rs` normalize_logs returns `JoinHandle<()>`
- [x] Function signatures updated consistently
- [x] Build succeeds

## Technical Details
- **Files**:
  - `crates/executors/src/executors/cursor.rs:141-167`
  - `crates/executors/src/executors/opencode.rs:292-370`

```rust
// Before:
pub fn normalize_logs(/* params */) {
    tokio::spawn(async move {
        // existing logic
    });
}

// After:
pub fn normalize_logs(/* params */) -> JoinHandle<()> {
    tokio::spawn(async move {
        // existing logic
    })
}
```

## Dependencies
- [x] Task 005: Write test for normalization completion

## Effort Estimate
- Size: S
- Hours: 1

## Definition of Done
- [x] Code implemented in both executors
- [x] Build passes
- [x] Return type is `JoinHandle<()>`

## Implementation Notes

### Changes Made

1. **Trait definition** (`mod.rs:222`): Updated `StandardCodingAgentExecutor::normalize_logs` to return `JoinHandle<()>`

2. **Cursor executor** (`cursor.rs:134`): Modified to return a JoinHandle that awaits both stderr and stdout normalization tasks

3. **OpenCode executor** (`opencode.rs:272`): Modified to return a JoinHandle that awaits both log_lines and share_events normalization tasks

4. **All other executors** updated to return `JoinHandle<()>`:
   - `claude.rs:195`
   - `amp.rs:159`
   - `codex.rs:168`
   - `copilot.rs:193`
   - `droid.rs:164`
   - `gemini.rs:75`
   - `qwen.rs:66`

5. **Helper functions** updated to return `JoinHandle<()>`:
   - `stderr_processor.rs:49`: `normalize_stderr_logs`
   - `acp/normalize_logs.rs:24`: `normalize_logs`
   - `codex/normalize_logs.rs:364`: `normalize_logs`
   - `droid/normalize_logs.rs:26`: `normalize_logs`
   - `claude.rs:371`: `ClaudeLogProcessor::process_logs`

### Pattern Used

For functions that spawn multiple tasks, a wrapper task is returned that awaits all inner tasks:

```rust
fn normalize_logs(...) -> JoinHandle<()> {
    let stderr_handle = normalize_stderr_logs(...);
    let stdout_handle = tokio::spawn(async move { ... });

    tokio::spawn(async move {
        let _ = stderr_handle.await;
        let _ = stdout_handle.await;
    })
}
```

### Tests Verified
- All executors crate tests pass (63 tests)
- All services crate tests pass (including normalize_sync_test.rs)
