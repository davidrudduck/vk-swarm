---
name: Await normalization handles before finalization
status: open
created: 2026-01-08T05:59:37Z
updated: 2026-01-08T05:59:37Z
depends_on: [004, 006]
conflicts_with: [004]
---

# Task: Await normalization handles before finalization

## Description
Store the JoinHandle returned by `normalize_logs()` and await it (with timeout) before calling `push_finished()`. This replaces the arbitrary 50ms sleep with proper synchronization.

## Acceptance Criteria
- [ ] Normalization JoinHandle stored when spawning
- [ ] Handle awaited with 5-second timeout before push_finished()
- [ ] Timeout handled gracefully (log warning, continue)
- [ ] Tests from Task 005 pass

## Technical Details
- **File**: `crates/local-deployment/src/container.rs:633`
- Remove or replace the 50ms sleep with proper awaiting

```rust
// Store handles when spawning normalization
let norm_handle = normalize_logs(...);

// Before push_finished():
if let Some(handle) = norm_handle {
    if let Err(_) = tokio::time::timeout(Duration::from_secs(5), handle).await {
        tracing::warn!("Normalization timed out");
    }
}
```

## Dependencies
- [ ] Task 004: Add LogBatcher to Container
- [ ] Task 006: Modify normalize_logs to return JoinHandle

## Effort Estimate
- Size: M
- Hours: 2

## Definition of Done
- [ ] Code implemented
- [ ] Tests from Task 005 pass
- [ ] 50ms sleep removed
- [ ] Timeout handling verified
