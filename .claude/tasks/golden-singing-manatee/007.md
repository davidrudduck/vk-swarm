---
name: Await normalization handles before finalization
status: done
created: 2026-01-08T05:59:37Z
updated: 2026-01-09T09:30:00Z
depends_on: [004, 006]
conflicts_with: [004]
---

# Task: Await normalization handles before finalization

## Description
Store the JoinHandle returned by `normalize_logs()` and await it (with timeout) before calling `push_finished()`. This replaces the arbitrary 50ms sleep with proper synchronization.

## Acceptance Criteria
- [x] Normalization JoinHandle stored when spawning
- [x] Handle awaited with 5-second timeout before push_finished()
- [x] Timeout handled gracefully (log warning, continue)
- [x] Tests from Task 005 pass

## Technical Details
- **File**: `crates/local-deployment/src/container.rs:633`
- Remove or replace the 50ms sleep with proper awaiting

```rust
// Store handles when spawning normalization
let norm_handle = normalize_logs(...);

// Before push_finished():
if let Some(handle) = norm_handle {
    if let Err(_) = tokio::time::timeout(Duration::from_secs(5), handle).await {
        tracing::warn!("Normalization timed out");
    }
}
```

## Dependencies
- [x] Task 004: Add LogBatcher to Container
- [x] Task 006: Modify normalize_logs to return JoinHandle

## Effort Estimate
- Size: M
- Hours: 2

## Definition of Done
- [x] Code implemented
- [x] Tests from Task 005 pass
- [x] 50ms sleep removed
- [x] Timeout handling verified

## Implementation Summary (2026-01-09)

### Changes Made
1. **LocalContainerService struct** (`crates/local-deployment/src/container.rs`):
   - Added `normalization_handles: Arc<RwLock<HashMap<Uuid, JoinHandle<()>>>>` field
   - Added `store_normalization_handle()` method to store handles
   - Added `take_normalization_handle()` method to retrieve and remove handles

2. **spawn_exit_monitor** (`container.rs:655-666`):
   - Added normalization handle await with 5-second timeout before `push_finished()`
   - Removed the 50ms sleep that was insufficient for the race condition

3. **stop_execution** (`container.rs:1466-1477`):
   - Added same normalization handle await with 5-second timeout

4. **ContainerService trait** (`crates/services/src/services/container.rs`):
   - Added `store_normalization_handle()` and `take_normalization_handle()` trait methods
   - Updated `try_start_action()` to store the handle when calling `executor.normalize_logs()`

### Test Results
- All 5 Task 005 normalization tests pass
- All 10 local-deployment tests pass
- Clippy passes with no warnings

### Git Commit
`5b1b44c24` - feat(task-007): await normalization handles before finalization
