---
name: Add Remote Context to fix_sessions Endpoint with Proxy
status: open
created: 2026-01-11T11:04:49Z
updated: 2026-01-11T11:04:49Z
depends_on: []
conflicts_with: []
---

# Task: Add Remote Context to fix_sessions Endpoint with Proxy

## Description
Add `RemoteTaskAttemptContext` extraction to `fix_sessions` handler and proxy the request to the owning node for remote tasks. This is a write operation that must execute on the node that owns the task.

## Acceptance Criteria
- [ ] Handler signature includes `remote_ctx: Option<Extension<RemoteTaskAttemptContext>>`
- [ ] Remote tasks proxy to owning node using `check_remote_task_attempt_proxy`
- [ ] Proxy path is `/task-attempts/by-task-id/{shared_task_id}/fix-sessions`
- [ ] Local behavior unchanged
- [ ] Write operations succeed on remote tasks via proxy

## Technical Details
- **File**: `crates/server/src/routes/task_attempts/handlers/core.rs` (line ~755)
- **Pattern**: Follow `stop_task_attempt_execution` handler as reference (line ~723)
- Use `check_remote_task_attempt_proxy` to detect and handle remote tasks
- Use `deployment.node_proxy_client().proxy_post()` for proxying

## Code Location
```rust
// Current (line 755):
pub async fn fix_sessions(
    Extension(task_attempt): Extension<TaskAttempt>,
    State(deployment): State<DeploymentImpl>,
) -> Result<ResponseJson<ApiResponse<FixSessionsResponse>>, ApiError>

// Updated:
pub async fn fix_sessions(
    Extension(task_attempt): Extension<TaskAttempt>,
    remote_ctx: Option<Extension<RemoteTaskAttemptContext>>,  // ADD
    State(deployment): State<DeploymentImpl>,
) -> Result<ResponseJson<ApiResponse<FixSessionsResponse>>, ApiError> {
    // Proxy to owning node - this is a write operation
    if let Some(proxy_info) = check_remote_task_attempt_proxy(remote_ctx.as_ref().map(|e| &e.0))? {
        let path = format!("/task-attempts/by-task-id/{}/fix-sessions", proxy_info.target_id);
        let response: ApiResponse<FixSessionsResponse> = deployment
            .node_proxy_client()
            .proxy_post(&proxy_info.node_url, &path, &(), proxy_info.node_id)
            .await?;
        return Ok(ResponseJson(response));
    }
    // ... existing local logic
}
```

## Dependencies
- [ ] Task 005 must add `/fix-sessions` route to by_task_id_router for proxy to work

## Effort Estimate
- Size: XS
- Hours: 0.5

## Definition of Done
- [ ] Code implemented
- [ ] Handler proxies to owning node for remote tasks
- [ ] Build passes with `cargo check`
- [ ] Clippy passes
