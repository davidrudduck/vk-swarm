---
name: Add integration test for variant display
status: open
created: 2026-01-20T22:56:20Z
updated: 2026-01-20T22:56:20Z
depends_on: ["001"]
conflicts_with: []
model_hint: moderate
estimated_minutes: 30
---

# Task: Add integration test for variant display

## Description
Add an integration test that verifies the complete data flow from ExecutionProcess to the displayed variant in UserMessage, ensuring the feature works end-to-end.

## Acceptance Criteria
- [ ] Test verifies that variant from ExecutionProcess is displayed in UI
- [ ] Test uses realistic ExecutionProcess data structure
- [ ] Test passes successfully
- [ ] Test is added to DisplayConversationEntry.test.tsx

## Technical Details
This test should verify that when an ExecutionProcess with a variant is available via ExecutionProcessesContext, the variant is correctly extracted by getExecutorVariant and displayed in the UserMessage component.

The test needs to:
1. Mock ExecutionProcessesContext to provide a test ExecutionProcess with variant
2. Render DisplayConversationEntry with that executionProcessId
3. Verify the variant appears in the rendered output

## Dependencies
- Task 001 must be completed (ExecutionProcess wiring)

## Steps

### Step 1: Create test file if it doesn't exist
**File**: `frontend/src/components/NormalizedConversation/__tests__/DisplayConversationEntry.test.tsx`

If this file doesn't exist, create it. If it exists, add the test to the existing file.

### Step 2: Write the integration test

**File**: `frontend/src/components/NormalizedConversation/__tests__/DisplayConversationEntry.test.tsx`

Add this complete test:

```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import DisplayConversationEntry from '../DisplayConversationEntry';
import { NormalizedEntry, ExecutionProcess } from 'shared/types';

// Mock ExecutionProcessesContext
const mockExecutionProcessesById: Record<string, ExecutionProcess> = {
  'test-process-id': {
    id: 'test-process-id',
    executor_action: {
      typ: {
        type: 'CodingAgentInitialRequest',
        executor_profile_id: {
          executor: 'CLAUDE_CODE',
          variant: 'PLAN',
        },
      },
    },
  } as ExecutionProcess,
};

vi.mock('@/contexts/ExecutionProcessesContext', () => ({
  useExecutionProcesses: () => ({
    executionProcessesByIdAll: mockExecutionProcessesById,
    executionProcessesAll: Object.values(mockExecutionProcessesById),
    executionProcessesByIdVisible: mockExecutionProcessesById,
    executionProcessesVisible: Object.values(mockExecutionProcessesById),
    isAttemptRunningAll: false,
    isAttemptRunningVisible: false,
    isLoading: false,
    isConnected: true,
    error: null,
  }),
}));

// Mock other required dependencies
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string) => key,
  }),
}));

vi.mock('@/components/ConfigProvider', () => ({
  useUserSystem: () => ({
    capabilities: {
      CLAUDE_CODE: ['session.fork']
    }
  }),
}));

vi.mock('@/hooks/useProcessRetry', () => ({
  useProcessRetry: () => null,
}));

vi.mock('@/hooks/follow-up/useDraftStream', () => ({
  useDraftStream: () => ({ retryDraft: null }),
}));

vi.mock('@/contexts/RetryUiContext', () => ({
  useRetryUi: () => ({
    activeRetryProcessId: null,
    isProcessGreyed: () => false,
  }),
}));

vi.mock('@/contexts/FileViewerContext', () => ({
  useFileViewer: () => ({
    openFile: vi.fn(),
  }),
}));

describe('DisplayConversationEntry - Executor Variant Integration', () => {
  it('displays executor variant from ExecutionProcess data', () => {
    const entry: NormalizedEntry = {
      entry_index: 0,
      entry_type: {
        type: 'user_message',
        content: 'Test message',
      },
      timestamp: new Date().toISOString(),
    };

    const mockTaskAttempt = {
      id: 'attempt-123',
      executor: 'CLAUDE_CODE',
    };

    render(
      <DisplayConversationEntry
        entry={entry}
        expansionKey="test-key"
        executionProcessId="test-process-id"
        taskAttempt={mockTaskAttempt as any}
      />
    );

    // Verify that the variant "PLAN" is displayed alongside the executor
    expect(screen.getByText('CLAUDE_CODE / PLAN')).toBeInTheDocument();
  });

  it('displays only executor when ExecutionProcess has no variant', () => {
    const mockExecutionProcessNoVariant: Record<string, ExecutionProcess> = {
      'no-variant-id': {
        id: 'no-variant-id',
        executor_action: {
          typ: {
            type: 'CodingAgentInitialRequest',
            executor_profile_id: {
              executor: 'CLAUDE_CODE',
              // No variant
            },
          },
        },
      } as ExecutionProcess,
    };

    vi.mocked(vi.importMock('@/contexts/ExecutionProcessesContext')).useExecutionProcesses.mockReturnValue({
      executionProcessesByIdAll: mockExecutionProcessNoVariant,
      executionProcessesAll: Object.values(mockExecutionProcessNoVariant),
      executionProcessesByIdVisible: mockExecutionProcessNoVariant,
      executionProcessesVisible: Object.values(mockExecutionProcessNoVariant),
      isAttemptRunningAll: false,
      isAttemptRunningVisible: false,
      isLoading: false,
      isConnected: true,
      error: null,
    });

    const entry: NormalizedEntry = {
      entry_index: 0,
      entry_type: {
        type: 'user_message',
        content: 'Test message',
      },
      timestamp: new Date().toISOString(),
    };

    const mockTaskAttempt = {
      id: 'attempt-123',
      executor: 'CLAUDE_CODE',
    };

    render(
      <DisplayConversationEntry
        entry={entry}
        expansionKey="test-key-2"
        executionProcessId="no-variant-id"
        taskAttempt={mockTaskAttempt as any}
      />
    );

    // Should show executor only, without variant
    expect(screen.getByText('CLAUDE_CODE')).toBeInTheDocument();
    expect(screen.queryByText('/')).not.toBeInTheDocument();
  });
});
```

## Files to Modify
- `frontend/src/components/NormalizedConversation/__tests__/DisplayConversationEntry.test.tsx` (create or update)
  - Add integration tests for executor variant display

## Validation
- [ ] Test file exists and is properly formatted
- [ ] Tests run successfully: `cd frontend && npm run test -- DisplayConversationEntry.test.tsx`
- [ ] Both test cases pass
- [ ] Tests verify the complete data flow from ExecutionProcess to UI

## Commit
```bash
test: add integration tests for executor variant display

- Test variant display from ExecutionProcess data
- Test executor-only display when no variant
- Verify complete data flow through getExecutorVariant
```

## Notes
- This test mocks the entire ExecutionProcessesContext to provide controlled test data
- The test creates realistic ExecutionProcess objects with the correct type structure
- The test verifies both cases: with variant and without variant
- If the test file doesn't exist, create it with appropriate imports and setup
