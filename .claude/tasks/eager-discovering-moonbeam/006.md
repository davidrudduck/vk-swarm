---
name: Update handle_backfill_response with Tracking
status: done
created: 2026-01-08T21:22:12Z
updated: 2026-01-09T09:40:00Z
depends_on: [003, 004, 005]
conflicts_with: []
---

# Task: Update handle_backfill_response with Tracking

## Description
Update the backfill response handler to use the tracker to correlate responses with their original attempt IDs, then mark them complete or reset on failure.

## Acceptance Criteria
- [x] Add `tracker: &BackfillRequestTracker` parameter to `handle_backfill_response()`
- [x] Call `tracker.complete(response.request_id)` to get attempt IDs
- [x] On success: call `repo.mark_complete(attempt_id)` for each attempt
- [x] On failure: call `repo.reset_attempt_to_partial(attempt_id)` for each attempt
- [x] Log appropriate warnings if tracker has no mapping for response
- [x] Update call site in `handle_message()` to pass tracker

## Technical Details
- Location: `crates/remote/src/nodes/ws/session.rs`
- Function at lines 1421-1470 (approximately)
- Need to get tracker from state and pass to handler
- Use `NodeTaskAttemptRepository::new(pool)` to create repo instance

## Dependencies
- [x] Task 003 - BackfillService must have tracker
- [x] Task 004 - reset_attempt_to_partial must exist
- [x] Task 005 - AppState must expose tracker

## Effort Estimate
- Size: M
- Hours: 2

## Definition of Done
- [x] Handler updated with tracker parameter
- [x] Success path marks attempts complete
- [x] Failure path resets attempts to partial
- [x] Logging is appropriate
- [x] Call site updated
- [x] `cargo check -p remote` passes
- [x] `cargo clippy -p remote -- -D warnings` passes

## Implementation Notes (Session 6 - 2026-01-09)

### Changes Made
1. Added `use crate::nodes::backfill::BackfillRequestTracker` import
2. Added tracker extraction in `handle()` function: `let tracker = backfill.tracker();`
3. Updated `handle_node_message()` to accept `tracker: &BackfillRequestTracker` parameter
4. Updated `handle_backfill_response()` to accept `tracker: &BackfillRequestTracker` parameter
5. Implemented success path: calls `tracker.complete()` and `repo.mark_complete()` for each attempt
6. Implemented failure path: calls `tracker.complete()` and `repo.reset_attempt_to_partial()` for each attempt
7. Added fallback to `repo.reset_failed_backfill()` when no tracker mapping exists
8. Added `#[allow(clippy::too_many_arguments)]` attribute for handle_node_message

### Git Commit
- 79671edf1 feat(backfill): integrate tracker into handle_backfill_response
