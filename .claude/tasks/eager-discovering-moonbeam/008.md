---
name: Add Disconnect Cleanup Logic
status: done
created: 2026-01-08T21:22:12Z
updated: 2026-01-09T06:30:00Z
depends_on: [007]
conflicts_with: [007]
---

# Task: Add Disconnect Cleanup Logic

## Description
When a node disconnects, clear all its pending backfill requests and reset those attempts to partial state so they can be retried.

## Acceptance Criteria
- [x] In session `handle()` cleanup section, call `tracker.clear_node(node_id)`
- [x] For each cleared attempt ID, call `repo.reset_attempt_to_partial(attempt_id)`
- [x] Log count of cleared pending backfill requests
- [x] Errors during reset are logged but don't prevent cleanup

## Technical Details
- Location: `crates/remote/src/nodes/ws/session.rs`
- Add cleanup code after the main message loop exits (in the disconnect/cleanup section)
- Use `NodeTaskAttemptRepository::new(&pool)` to get repo

## Implementation
Added cleanup code at lines 258-278 in session.rs:
- After connection unregister, calls `tracker.clear_node(auth_result.node_id)`
- If any attempt IDs are returned, logs the count
- For each attempt ID, calls `repo.reset_attempt_to_partial(attempt_id)`
- Errors are logged with warning level but don't prevent cleanup

## Dependencies
- [x] Task 007 - Tracker must be available in session handle()

## Effort Estimate
- Size: S
- Hours: 0.5

## Definition of Done
- [x] Disconnect cleanup implemented
- [x] Cleared attempts reset to partial
- [x] Appropriate logging added
- [x] `cargo check -p remote` passes
- [x] `cargo clippy -p remote -- -D warnings` passes

## Verification
- All 8 backfill tests pass
- Clippy passes with no warnings
- Frontend loads without errors
