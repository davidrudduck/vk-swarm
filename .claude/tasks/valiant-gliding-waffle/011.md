---
name: Fix Retry Session Lookup Order in follow_up Handler
status: complete
created: 2026-01-18T05:57:09Z
updated: 2026-01-19T02:00:00Z
depends_on: ['010']
conflicts_with: []
---

# Task: Fix Retry Session Lookup Order in follow_up Handler

## Description
Update the follow_up route handler to look up session ID BEFORE dropping processes for retries. This preserves context from the pre-retry session.

## Acceptance Criteria
- [x] Session lookup moved before drop_at_and_after for retries
- [x] Pre-retry session ID stored before dropping
- [x] Stored session ID used if available
- [x] Normal follow-ups (non-retry) unchanged
- [x] Code compiles and tests pass

## Technical Details
In crates/server/src/routes/task_attempts/handlers/follow_up.rs:

```rust
// For retries, get session BEFORE dropping processes
let pre_retry_session_id = if payload.retry_process_id.is_some() && !skip_context {
    ExecutionProcess::find_session_id_before_process(
        &deployment.db().pool,
        task_attempt.id,
        payload.retry_process_id.unwrap(),
    ).await?
} else {
    None
};

// Now safe to drop processes
if let Some(retry_process_id) = payload.retry_process_id {
    ExecutionProcess::drop_at_and_after(/* ... */).await?;
}

// Use pre_retry_session_id if available
let latest_session_id = if skip_context {
    None
} else if let Some(session_id) = pre_retry_session_id {
    Some(session_id)
} else {
    ExecutionProcess::find_latest_session_id_by_task_attempt(/* ... */).await?
};
```

## Dependencies
- [x] 010

## Effort Estimate
- Size: S
- Hours: 1

## Definition of Done
- [x] Session lookup reordered
- [x] Pre-retry session preserved
- [x] Fallback logic correct
- [x] Code compiles
- [x] Integration test passes
