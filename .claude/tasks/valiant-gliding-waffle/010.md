---
name: Add find_session_id_before_process Query
status: complete
created: 2026-01-18T05:57:09Z
updated: 2026-01-19T01:30:00Z
depends_on: []
conflicts_with: []
---

# Task: Add find_session_id_before_process Query

## Description
Create new database query to find the session ID from the process immediately before a retry target process.

## Acceptance Criteria
- [x] find_session_id_before_process function added to ExecutionProcess model
- [x] Function queries for session ID of process before target
- [x] Function filters by codingagent run_reason
- [x] Function filters out dropped processes
- [x] Function orders by created_at DESC
- [x] SQLx compile-time checks pass

## Technical Details
Add to crates/db/src/models/execution_process/queries.rs:

```rust
pub async fn find_session_id_before_process(
    pool: &SqlitePool,
    task_attempt_id: Uuid,
    process_id: Uuid,
) -> Result<Option<String>, sqlx::Error> {
    let row = sqlx::query!(
        r#"SELECT es.session_id
           FROM execution_processes ep
           JOIN executor_sessions es ON ep.id = es.execution_process_id
           WHERE ep.task_attempt_id = $1
             AND ep.run_reason = 'codingagent'
             AND ep.dropped = FALSE
             AND es.session_id IS NOT NULL
             AND ep.created_at < (SELECT created_at FROM execution_processes WHERE id = $2)
           ORDER BY ep.created_at DESC
           LIMIT 1"#,
        task_attempt_id,
        process_id
    )
    .fetch_optional(pool)
    .await?;
    Ok(row.and_then(|r| r.session_id))
}
```

## Dependencies

## Effort Estimate
- Size: S
- Hours: 0.75

## Definition of Done
- [x] Query function added
- [x] SQL query correct
- [x] SQLx checks pass
- [x] Function returns Option<String>
- [x] Code compiles
