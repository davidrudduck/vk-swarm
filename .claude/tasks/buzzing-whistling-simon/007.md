---
name: Wrap unlink operation in database transaction
status: completed
created: 2026-01-16T02:45:11Z
updated: 2026-01-16T22:00:00Z
depends_on: [005, 006]
conflicts_with: []
---

# Task: Wrap unlink operation in database transaction

## Description
Update the unlink_from_swarm handler to wrap all three database operations in a single transaction, ensuring atomicity. Use the new `_tx` functions from Tasks 005 and 006.

## Acceptance Criteria
- [x] Begin transaction using pool.begin().await
- [x] Call Task::clear_all_shared_task_ids_for_project_tx with transaction
- [x] Call TaskAttempt::clear_hive_sync_for_project_tx with transaction
- [x] Call Project::set_remote_project_id_tx with transaction
- [x] Commit transaction after all operations succeed
- [x] Transaction rolls back on any error
- [x] Return correct counts after successful transaction
- [ ] Compiles without errors (blocked by pre-existing sqlx cache issues)
- [ ] Clippy passes (blocked by pre-existing sqlx cache issues)

## Technical Details
- Location: `crates/server/src/routes/projects/handlers/swarm.rs`
- Function: `unlink_from_swarm`
- Use `pool.begin()` to create transaction
- Pass `&mut *tx` to all _tx functions
- Call `tx.commit()` after all operations

## Dependencies
- [x] Task 005 completed (Task::clear_all_shared_task_ids_for_project_tx)
- [x] Task 006 completed (TaskAttempt::clear_hive_sync_for_project_tx)

## Effort Estimate
- Size: S
- Hours: 0.5

## Definition of Done
- [x] All database operations wrapped in transaction
- [x] Transaction commits on success
- [x] Transaction rolls back on error
- [ ] Compiles without errors (blocked by pre-existing sqlx cache issues)
- [ ] Clippy passes with -D warnings (blocked by pre-existing sqlx cache issues)
- [ ] Code committed with descriptive message
