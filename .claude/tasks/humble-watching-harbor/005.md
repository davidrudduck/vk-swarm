---
name: Backend EntryIndexProvider Tests
status: open
created: 2026-01-20T11:25:43Z
updated: 2026-01-20T11:25:43Z
depends_on: []
conflicts_with: []
model_hint: simple
estimated_minutes: 15
---

# Task: Backend EntryIndexProvider Tests

## Description
Add comprehensive unit tests for the EntryIndexProvider struct in the executors crate. Currently, the `reset()` and `start_from()` methods lack test coverage.

## Acceptance Criteria
- [ ] `reset()` method has unit test
- [ ] `start_from()` method has integration tests for:
  - Empty MsgStore
  - MsgStore with sequential entries
  - MsgStore with non-sequential entries (gaps)
- [ ] All tests pass
- [ ] Code coverage improved for EntryIndexProvider

## Technical Details
**Current test coverage:**
- ✓ `new()` - tested
- ✓ `next()` - tested
- ✓ `current()` - tested
- ✗ `reset()` - NOT tested
- ✗ `start_from()` - NOT tested
- ✓ Clone behavior - tested

**EntryIndexProvider location:**
`crates/executors/src/logs/utils/entry_index.rs`

**Test strategy:**
1. Add `reset()` test to inline `#[cfg(test)] mod tests` in entry_index.rs
2. Create new integration test file for `start_from()` tests (requires MsgStore)

## Dependencies
None - this is a standalone testing task

## Steps

### Step 1: Add reset() test to inline module
**File**: `crates/executors/src/logs/utils/entry_index.rs`
**Location**: Inside the existing `#[cfg(test)] mod tests` block

Add this test:
```rust
#[test]
fn test_reset() {
    let provider = EntryIndexProvider::test_new();
    // Advance the counter
    assert_eq!(provider.next(), 0);
    assert_eq!(provider.next(), 1);
    assert_eq!(provider.current(), 2);

    // Reset should return to 0
    provider.reset();
    assert_eq!(provider.current(), 0);
    assert_eq!(provider.next(), 0);
}
```

### Step 2: Create integration test file
**File**: `crates/executors/tests/entry_index_provider_tests.rs`

Create this new file with:
```rust
use executors::logs::utils::EntryIndexProvider;
use workspace_utils::msg_store::MsgStore;
use json_patch::{AddOperation, PatchOperation};
use serde_json::json;
use std::sync::Arc;

#[test]
fn test_start_from_empty_msg_store() {
    let msg_store = Arc::new(MsgStore::new());
    let provider = EntryIndexProvider::start_from(&msg_store);

    // Empty store should start at 0
    assert_eq!(provider.current(), 0);
}

#[test]
fn test_start_from_with_existing_entries() {
    let msg_store = Arc::new(MsgStore::new());

    // Add patch with entry index 5
    let patch = vec![PatchOperation::Add(AddOperation {
        path: "/entries/5".to_string(),
        value: json!({"content": "test"}),
    })];
    msg_store.push_patch(patch);

    let provider = EntryIndexProvider::start_from(&msg_store);

    // Should start at max_index + 1 = 6
    assert_eq!(provider.current(), 6);
}

#[test]
fn test_start_from_with_non_sequential_entries() {
    let msg_store = Arc::new(MsgStore::new());

    // Add patches with gaps in indices: 0, 2, 5, 10
    for idx in [0, 2, 5, 10] {
        let patch = vec![PatchOperation::Add(AddOperation {
            path: format!("/entries/{}", idx),
            value: json!({"content": "test"}),
        })];
        msg_store.push_patch(patch);
    }

    let provider = EntryIndexProvider::start_from(&msg_store);

    // Should start at max_index + 1 = 11
    assert_eq!(provider.current(), 11);
}
```

### Step 3: Run the tests
```bash
# Run the inline test
cargo test -p executors test_reset

# Run the integration tests
cargo test -p executors --test entry_index_provider_tests

# Run all executors tests
cargo test -p executors
```

All tests should pass.

## Files to Create/Modify
- `crates/executors/src/logs/utils/entry_index.rs` - Add reset() test to existing test module
- `crates/executors/tests/entry_index_provider_tests.rs` - CREATE new integration test file

## Validation
- [ ] Run `cargo test -p executors test_reset`
- [ ] Run `cargo test -p executors --test entry_index_provider_tests`
- [ ] Run `cargo test -p executors` (all tests in crate)
- [ ] Verify all tests pass

## Commit
```bash
test: add comprehensive tests for EntryIndexProvider

- Add reset() test to inline test module
- Add integration tests for start_from() method
- Test empty store, sequential entries, and non-sequential entries
- Improve code coverage for entry index provider
```

## Notes
- The `start_from()` method analyzes MsgStore patches to find the highest entry index
- It extracts indices from paths like "/entries/5" using regex
- The new provider starts at max_index + 1 to avoid conflicts
- Integration tests use `json_patch` and `MsgStore` from workspace_utils crate
- The `test_new()` method is used for unit tests (doesn't require MsgStore)
