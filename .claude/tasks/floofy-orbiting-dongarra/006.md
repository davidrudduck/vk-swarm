---
name: Rewrite process_share_events() as process_json_events()
status: complete
created: 2026-01-18T05:57:17Z
updated: 2026-01-19T00:00:00Z
depends_on: [005]
conflicts_with: []
---

# Task: Rewrite process_share_events() as process_json_events()

## Description
Completely rewrite the event processing function to handle JSON events instead of share bridge events, creating conversation patches for assistant messages and tool calls.

## Acceptance Criteria
- [x] New `process_json_events()` function created
- [x] Deserialises JsonEvent structs from JSON lines
- [x] Extracts and sets session ID from first event
- [x] Creates AssistantMessage entries for text events
- [x] Detects tool call JSON within text events
- [x] Creates ToolUse entries for tool calls
- [x] Handles step_start and step_finish events
- [x] Message texts accumulated by message_id
- [x] Code compiles successfully

## Technical Details
- Implementation approach: Process each JSON event and create appropriate conversation patches
- Key considerations:
  - Text may arrive in multiple events for same message (accumulate by message_id)
  - Some text events contain tool call JSON (detect by checking for `{"name":` pattern)
  - Use ConversationPatch::replace for upserts
- Code locations/files affected: `crates/executors/src/executors/opencode.rs` lines 383-854

Core logic structure:
1. Deserialise JSON line to JsonEvent
2. Set session ID on first event
3. Match on event_type:
   - "text" → Check if tool call JSON, otherwise create/update AssistantMessage
   - "step_start" / "step_finish" → Track step boundaries (optional)
4. Accumulate message text by message_id
5. Use entry_index_counter for stable indices

## Dependencies
- [ ] Task 005 (normalize_logs updated to stream JSON)

## Effort Estimate
- Size: S
- Hours: 1.0

## Definition of Done
- [x] Function implemented
- [x] Test written (`test_text_event_creates_assistant_message`)
- [x] Test written (`test_tool_call_detection`)
- [x] Test written (`test_session_id_extracted`)
- [x] Code compiles
- [x] Tests pass
