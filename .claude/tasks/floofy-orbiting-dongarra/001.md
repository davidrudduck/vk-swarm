---
name: Add --format json to OpenCode command builder
status: complete
created: 2026-01-18T05:57:17Z
updated: 2026-01-19T15:44:00Z
depends_on: []
conflicts_with: []
---

# Task: Add --format json to OpenCode command builder

## Description
Update the `build_command_builder()` function to add the `--format json` flags to enable structured JSON event output from OpenCode.

## Acceptance Criteria
- [x] `--format` and `json` added to command params array
- [x] Code compiles successfully
- [x] Test written to verify flags are present in command

## Technical Details
- Implementation approach: Add two new string literals to the params array in `build_command_builder()`
- Key considerations: This is the foundation for JSON-based event processing
- Code locations/files affected: `crates/executors/src/executors/opencode.rs` lines 112-128

**Current code:**
```rust
fn build_command_builder(&self) -> CommandBuilder {
    let mut builder = CommandBuilder::new("opencode run").params([
        "--print-logs",
        "--log-level",
        "ERROR",
    ]);
```

**Change to:**
```rust
fn build_command_builder(&self) -> CommandBuilder {
    let mut builder = CommandBuilder::new("opencode run").params([
        "--print-logs",
        "--log-level",
        "ERROR",
        "--format",
        "json",
    ]);
```

## Dependencies
- [x] None - this is the first task

## Effort Estimate
- Size: XS
- Hours: 0.25

## Definition of Done
- [x] Code implemented (crates/executors/src/executors/opencode.rs:197-204)
- [x] Unit test added (`test_command_builder_includes_format_json` at line 781-806)
- [x] Code compiles (`cargo build --package executors`)
- [x] Tests pass (all 7 OpenCode tests passing)

## Implementation Notes

**CRITICAL FIX APPLIED** - This task was initially missed in the original implementation, rendering the entire OpenCode JSON format feature non-functional. The validation report identified that without the `--format json` flag, OpenCode runs in default text mode and emits NO JSON events to stdout, making all the JSON parsing infrastructure created in Tasks 004-006 useless.

**Changes Made:**
- Added `--format` and `json` parameters to command builder (lines 197-204)
- Created test `test_command_builder_includes_format_json` to verify flag presence (lines 781-806)
- Test verifies the --format flag exists and is followed by "json"
- All 7 OpenCode unit tests passing

**Verification:**
```bash
cargo test --package executors opencode
# Result: 7 tests passed
```

**Git Commit:** aabba359f - "feat: add --format json flag to OpenCode command builder"
