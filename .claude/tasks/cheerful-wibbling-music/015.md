---
name: Add integration test for env var context resolution
status: complete
created: 2026-01-23T08:42:27Z
updated: 2026-01-25T19:44:00Z
depends_on: [010, 011, 012]
parallel: false
conflicts_with: []
---

# Task: Add integration test for env var context resolution

## Description
Create an integration test that verifies MCP context tools correctly use environment variables when present and fall back to path-based resolution when not.

## Acceptance Criteria
- [x] Test sets VK_ATTEMPT_ID, VK_TASK_ID env vars
- [x] Test calls get_context, get_task_id, get_project_id
- [x] Test verifies correct IDs returned based on env vars
- [x] Test clears env vars and verifies fallback works
- [x] Test uses create_test_pool() for database
- [x] Test passes successfully

## Technical Details
**File**: `crates/server/tests/mcp_context_test.rs` (create new file)

Create a test like:
```rust
#[tokio::test]
async fn test_mcp_context_with_env_vars() {
    let (pool, _temp_dir) = create_test_pool().await;

    // Create test data
    let project = Project::create(&pool, "test").await.unwrap();
    let task = Task::create(&pool, project.id, "test").await.unwrap();
    let attempt = TaskAttempt::create(&pool, task.id, "/tmp/test").await.unwrap();

    // Set environment variables
    std::env::set_var("VK_ATTEMPT_ID", attempt.id.to_string());
    std::env::set_var("VK_TASK_ID", task.id.to_string());

    // Create MCP server instance
    let mcp_server = TaskServer::new(pool.clone());

    // Test get_context uses env var
    let ctx = mcp_server.get_context("/any/path".to_string()).await.unwrap();
    assert_eq!(ctx.task_id, task.id);

    // Clear env vars
    std::env::remove_var("VK_ATTEMPT_ID");
    std::env::remove_var("VK_TASK_ID");

    // Test fallback to path-based resolution
    let ctx2 = mcp_server.get_context("/tmp/test".to_string()).await.unwrap();
    assert_eq!(ctx2.task_id, task.id);
}
```

## Dependencies
- [x] Task 010: get_context env var logic
- [x] Task 011: get_task_id env var logic
- [x] Task 012: get_project_id env var logic

## Effort Estimate
- Size: S
- Hours: 1
- Parallel: false (needs MCP updates complete)

## Definition of Done
- [x] Test implemented for all three MCP methods
- [x] Test covers both env var and fallback paths
- [x] Test passes
- [x] Code compiles without errors
- [x] Changes committed to git
