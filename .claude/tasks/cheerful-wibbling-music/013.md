---
name: Improve resolve_container_ref fallback query
status: completed
created: 2026-01-23T08:42:27Z
updated: 2026-01-24T11:25:00Z
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Improve resolve_container_ref fallback query

## Description
Enhance the `resolve_container_ref` query in task_attempt model to prioritize attempts with running execution processes when multiple attempts share the same worktree path.

## Acceptance Criteria
- [x] Query JOINs with execution_processes table
- [x] Prioritizes attempts with status='running' execution process
- [x] Orders by execution process start time (most recent first)
- [x] Falls back to most recent attempt if no running process
- [x] Returns deterministic result
- [x] Code compiles without errors

## Technical Details
**File**: `crates/db/src/models/task_attempt.rs`

Find the `resolve_container_ref` function and update the SQL query to:

```sql
SELECT ta.id, ta.task_id, t.project_id
FROM task_attempts ta
JOIN tasks t ON ta.task_id = t.id
LEFT JOIN execution_processes ep ON ep.task_attempt_id = ta.id
    AND ep.status = 'running'
WHERE ta.container_ref = ?
ORDER BY
    CASE WHEN ep.id IS NOT NULL THEN 0 ELSE 1 END,
    ep.started_at DESC NULLS LAST,
    ta.created_at DESC
LIMIT 1
```

This ensures:
1. Running execution processes are prioritized (CASE WHEN returns 0 for running, 1 for others)
2. Among running processes, most recent started_at wins
3. If no running processes, falls back to most recent attempt

## Dependencies
- None - this is an independent improvement to the fallback layer

## Effort Estimate
- Size: S
- Hours: 1
- Parallel: true (independent of env var work)

## Definition of Done
- [ ] Query updated with JOIN and ORDER BY
- [ ] Query tested with sqlx compile-time checking
- [ ] Code compiles without errors
- [ ] Returns deterministic results
- [ ] Changes committed to git
