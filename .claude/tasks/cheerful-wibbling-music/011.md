---
name: Add env var priority to MCP get_task_id
status: completed
created: 2026-01-23T08:42:27Z
updated: 2026-01-24T10:40:00Z
depends_on: [009]
parallel: true
conflicts_with: []
---

# Task: Add env var priority to MCP get_task_id

## Description
Modify the MCP task_server's get_task_id method to prioritize VK_TASK_ID environment variable for resolution before falling back to path-based resolution.

## Acceptance Criteria
- [x] get_task_id checks for VK_TASK_ID env var first
- [x] If env var present and valid UUID, returns it directly
- [x] Falls back to path-based resolution if env var not found
- [x] Returns correct task_id for subtasks in shared worktrees
- [x] Code compiles without errors

## Technical Details
**File**: `crates/server/src/mcp/task_server.rs`

Update the `get_task_id` method with this two-layer approach:

```rust
async fn get_task_id(&self, cwd: String) -> Result<...> {
    // Layer 1: Direct return if env var available
    if let Ok(task_id_str) = std::env::var("VK_TASK_ID") {
        if let Ok(task_id) = Uuid::parse_str(&task_id_str) {
            return TaskServer::success(&task_id);
        }
    }

    // Layer 2: Fallback to cwd-based resolution
    if let Some(ctx) = self.fetch_context_for_path(&cwd).await {
        return TaskServer::success(&ctx.task_id);
    }

    TaskServer::err("No task found", None)
}
```

This is simpler than get_context since we just need to return the UUID directly.

## Dependencies
- [x] Task 009: Container module passes context to executors (so env vars are set)

## Effort Estimate
- Size: XS
- Hours: 0.5
- Parallel: true (can be done alongside other MCP updates)

## Definition of Done
- [x] Env var check implemented
- [x] Direct return logic added
- [x] Fallback logic preserved
- [x] Code compiles without errors
- [x] Changes committed to git
