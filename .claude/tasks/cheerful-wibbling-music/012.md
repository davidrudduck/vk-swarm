---
name: Add env var priority to MCP get_project_id
status: complete
created: 2026-01-23T08:42:27Z
updated: 2026-01-24T11:14:00Z
depends_on: [009]
parallel: true
conflicts_with: []
---

# Task: Add env var priority to MCP get_project_id

## Description
Modify the MCP task_server's get_project_id method to prioritize environment variable for resolution before falling back to path-based resolution.

## Acceptance Criteria
- [x] get_project_id checks for VK_ATTEMPT_ID env var first
- [x] If env var present, uses it to look up project_id
- [x] Falls back to path-based resolution if env var not found
- [x] Returns correct project_id for subtasks in shared worktrees
- [x] Code compiles without errors

## Technical Details
**File**: `crates/server/src/mcp/task_server.rs`

Update the `get_project_id` method with this two-layer approach:

```rust
async fn get_project_id(&self, cwd: String) -> Result<...> {
    // Layer 1: Lookup via env var if available
    if let Ok(attempt_id_str) = std::env::var("VK_ATTEMPT_ID") {
        if let Ok(attempt_id) = Uuid::parse_str(&attempt_id_str) {
            if let Some(ctx) = self.fetch_context_by_attempt_id(attempt_id).await {
                return TaskServer::success(&ctx.project_id);
            }
        }
    }

    // Layer 2: Fallback to cwd-based resolution
    if let Some(ctx) = self.fetch_context_for_path(&cwd).await {
        return TaskServer::success(&ctx.project_id);
    }

    TaskServer::err("No project found", None)
}
```

Reuses the `fetch_context_by_attempt_id` helper from task 010.

## Dependencies
- [ ] Task 009: Container module passes context to executors (so env vars are set)
- [ ] Task 010: fetch_context_by_attempt_id helper exists

## Effort Estimate
- Size: XS
- Hours: 0.5
- Parallel: true (can be done alongside other MCP updates)

## Definition of Done
- [x] Env var check implemented
- [x] Uses shared helper method
- [x] Fallback logic preserved
- [x] Code compiles without errors
- [x] Changes committed to git
