---
name: Add env var priority to MCP get_context
status: completed
created: 2026-01-23T08:42:27Z
updated: 2026-01-24T10:30:00Z
depends_on: [009]
parallel: true
conflicts_with: []
---

# Task: Add env var priority to MCP get_context

## Description
Modify the MCP task_server's get_context method to prioritize VK_ATTEMPT_ID environment variable for context resolution before falling back to path-based resolution.

## Acceptance Criteria
- [x] get_context checks for VK_ATTEMPT_ID env var first
- [x] If env var present and valid UUID, uses direct lookup
- [x] Falls back to path-based resolution if env var not found
- [x] Returns correct context for subtasks in shared worktrees
- [x] Code compiles without errors

## Technical Details
**File**: `crates/server/src/mcp/task_server.rs`

Update the `get_context` method with this two-layer approach:

```rust
async fn get_context(&self, cwd: String) -> Result<...> {
    // Layer 1: Direct lookup if env var available
    if let Ok(attempt_id_str) = std::env::var("VK_ATTEMPT_ID") {
        if let Ok(attempt_id) = Uuid::parse_str(&attempt_id_str) {
            if let Some(ctx) = self.fetch_context_by_attempt_id(attempt_id).await {
                return TaskServer::success(&ctx);
            }
        }
    }

    // Layer 2: Fallback to cwd-based resolution
    if let Some(ctx) = self.fetch_context_for_path(&cwd).await {
        return TaskServer::success(&ctx);
    }

    TaskServer::err("No task attempt found", None)
}
```

You'll need to implement `fetch_context_by_attempt_id` helper method that does a direct database lookup by attempt_id.

## Dependencies
- [x] Task 009: Container module passes context to executors (so env vars are set)

## Effort Estimate
- Size: S
- Hours: 1
- Parallel: true (can be done alongside other MCP updates)

## Definition of Done
- [x] Env var check implemented
- [x] Helper method for direct lookup created
- [x] Fallback logic preserved
- [x] Code compiles without errors
- [x] Changes committed to git
