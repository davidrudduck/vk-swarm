---
name: Fix variable expansion in follow_up.rs
status: completed
created: 2026-01-23T09:31:15Z
updated: 2026-01-23T09:54:00Z
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Fix variable expansion in follow_up.rs

## Description
Change the variable expansion function call in `follow_up.rs` to include system variables. Currently, user-defined variables like `$TASKPLAN` expand correctly, but system variables like `$TASK_ID`, `$PROJECT_ID`, and `$PARENT_TASK_ID` appear as literal strings in executor prompts.

## Acceptance Criteria
- [x] Line 239 in `crates/server/src/routes/task_attempts/handlers/follow_up.rs` updated
- [x] Function call changed from `get_variable_map` to `get_variable_map_with_system`
- [x] Code compiles without errors
- [x] Existing tests continue to pass

## Technical Details

**File Location**: `crates/server/src/routes/task_attempts/handlers/follow_up.rs`

**Current Code (line 239)**:
```rust
let variables = TaskVariable::get_variable_map(&deployment.db().pool, task.id)
```

**Required Change**:
```rust
let variables = TaskVariable::get_variable_map_with_system(&deployment.db().pool, task.id)
```

**Why This Works**: The `get_variable_map_with_system` function includes all 8 system variables (TASK_ID, PARENT_TASK_ID, TASK_TITLE, TASK_DESCRIPTION, TASK_LABEL, PROJECT_ID, PROJECT_TITLE, IS_SUBTASK) in addition to user-defined variables.

**Context**: This code runs when a user sends a follow-up prompt to an executor. The variables HashMap is used to expand `$VARIABLE_NAME` placeholders in the user's prompt before sending it to the executor.

## Dependencies
- [x] None - this is a standalone change

## Effort Estimate
- Size: XS
- Hours: 0.25
- Parallel: true

## Definition of Done
- [x] Code change implemented at the exact line specified
- [x] `cargo build` completes successfully
- [x] `cargo test -p server` passes (45/45 tests passed)
- [x] Code committed with descriptive message (commit 17b8b1b18)
