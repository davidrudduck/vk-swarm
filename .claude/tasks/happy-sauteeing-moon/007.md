---
name: Integrate reject_if_remote into remove_queued_message handler
status: done
created: 2026-01-12T00:16:47Z
updated: 2026-01-12T00:16:47Z
depends_on: [005]
conflicts_with: [005, 006]
---

# Task: Integrate reject_if_remote into remove_queued_message handler

## Description
Call the `reject_if_remote` helper function in the `remove_queued_message` handler immediately after loading the task attempt to prevent deletions from message queues for remote task attempts.

## Acceptance Criteria
- [x] `reject_if_remote(&deployment.db().pool, &task_attempt).await?;` added to handler
- [x] Call placed immediately after `let task_attempt = ...` line
- [x] Comment explaining why manual check is needed (bypass middleware)
- [x] Handler continues to work for local task attempts
- [x] Handler returns BadRequest for remote task attempts

## Technical Details
- Implementation approach: Add single line call + comment after task_attempt loading
- Key considerations:
  - Must be placed after the TaskAttempt lookup but before any message queue operations
  - Comment should explain: "Check if this belongs to a remote project (bypass middleware needs manual check)"
- Code locations/files affected: `crates/server/src/routes/message_queue.rs` - `remove_queued_message` function

## Dependencies
- [ ] Task 005 - `reject_if_remote` function must exist and be tested

## Effort Estimate
- Size: XS
- Hours: 0.25

## Definition of Done
- [x] Code implemented
- [x] Handler compiles
- [x] Existing tests pass
