---
name: Remove Unsafe Blocks from Session Index Tests
status: completed
created: 2026-01-19T04:59:32Z
updated: 2026-01-19T05:29:00Z
depends_on: []
conflicts_with: []
---

# Task: Remove Unsafe Blocks from Session Index Tests

## Description
Refactor session index tests to remove all `unsafe { std::env::set_var() }` blocks by implementing dependency injection for the home directory. This makes tests safe to run in parallel.

## Acceptance Criteria
- [x] New function `get_claude_project_dir_with_home()` implemented
- [x] New function `repair_sessions_index_with_home()` implemented
- [x] All 6 tests updated to use new safe API
- [x] All tests pass
- [x] No `unsafe` blocks remain in test code
- [x] Clippy shows no warnings

## Technical Details
**File**: `crates/executors/src/executors/session_index.rs`

**Tests to Update** (6 total):
1. `test_repair_adds_missing_sessions` (line ~751)
2. `test_repair_no_op_when_complete` (line ~829)
3. `test_repair_handles_nonexistent_project_directory` (line ~895)
4. `test_repair_creates_new_index_when_missing` (line ~916)
5. `test_repair_handles_empty_session_directory` (line ~957)
6. `test_repair_handles_malformed_files` (line ~993)

**Implementation Pattern**:
- Extract home directory logic into separate function
- Add `_with_home` variants for testing
- Update tests to pass home directory explicitly

## Dependencies
- None

## Effort Estimate
- Size: S
- Hours: 1

## Definition of Done
- [x] Code implemented following TDD RED-GREEN cycle
- [x] All 6 existing tests pass without unsafe blocks
- [x] New test `test_get_claude_project_dir_with_home_override` passes
- [x] `cargo test session_index --lib` passes
- [x] Clippy shows no warnings
- [x] Code committed
