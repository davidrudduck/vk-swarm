---
name: Add Database Query Tests for find_session_id_before_process
status: complete
created: 2026-01-19T04:59:32Z
updated: 2026-01-19T21:35:00Z
depends_on: []
conflicts_with: []
---

# Task: Add Database Query Tests for find_session_id_before_process

## Description
Add comprehensive test coverage for the `find_session_id_before_process()` database query that looks up session IDs during retry flows. Tests should cover normal operation, edge cases, and filtering logic.

## Acceptance Criteria
- [x] Test module added to `execution_process/queries.rs`
- [x] Helper functions for test data creation implemented
- [x] Test: Returns previous session ID
- [x] Test: Returns None for first process
- [x] Test: Skips dropped processes
- [x] All tests pass

## Technical Details
**File**: `crates/db/src/models/execution_process/queries.rs`

**Test Scenarios**:
1. **Previous Session Lookup**: P1 has session → P2 created → query finds P1's session
2. **No Previous Process**: P1 only → query returns None
3. **Skips Dropped**: P1 (not dropped) → P2 (dropped) → P3 → query finds P1's session

**Implementation Pattern**:
- Follow existing test patterns from `crates/db/src/models/execution_process/mod.rs` (lines 264-339)
- Use `create_test_pool()` from `crate::test_utils`
- Create helper functions for: project, task, attempt, execution with session
- Use `tokio::time::sleep()` to ensure created_at ordering

## Dependencies
- None

## Effort Estimate
- Size: S
- Hours: 1

## Definition of Done
- [x] Test module exists with 3 test functions
- [x] Helper functions implemented following existing patterns
- [x] `cargo test execution_process --lib` passes
- [x] Tests validate query behaviour correctly
- [x] Code committed
