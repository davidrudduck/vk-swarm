---
name: Implement existing patch detection in stream_normalized_logs
status: done
created: 2026-01-12T08:02:12Z
updated: 2026-01-12T20:00:00Z
depends_on: [001]
conflicts_with: [001]
---

# Task: Implement existing patch detection in stream_normalized_logs

## Description
Modify `stream_normalized_logs` in container.rs to detect existing JsonPatch entries and stream them directly instead of re-normalizing.

## Acceptance Criteria
- [x] Function checks if JsonPatch entries already exist in raw messages
- [x] If patches exist, stream them directly without running normalizer
- [x] If no patches exist, normalize only stdout/stderr (exclude existing JsonPatch)
- [x] Test from task 001 passes

## Technical Details
- Location: `crates/services/src/services/container.rs` lines 547-637
- Add conditional logic early in the fallback path
- Extract JsonPatch entries from raw_messages
- Use temp_store to collect and stream existing patches
- Filter raw messages to only include Stdout/Stderr for normalization

## Code Changes
```rust
// Check for existing normalized patches
let existing_patches: Vec<_> = raw_messages
    .iter()
    .filter(|msg| matches!(msg, LogMsg::JsonPatch(_)))
    .cloned()
    .collect();

if !existing_patches.is_empty() {
    // Already normalized - stream existing patches directly
    // ... implementation
}
```

## Dependencies
- [x] Task 001 complete

## Effort Estimate
- Size: S
- Hours: 1

## Definition of Done
- [x] Code implemented
- [x] Test from task 001 passes
- [x] No regressions in existing tests
- [x] Code follows project patterns
