---
name: Implement patch separation in log_migration
status: done
created: 2026-01-12T08:02:12Z
updated: 2026-01-12T20:40:00Z
depends_on: [004]
conflicts_with: [004]
---

# Task: Implement patch separation in log_migration

## Description
Modify `migrate_execution_logs_with_options` to separate existing JsonPatch entries from raw logs and insert patches directly instead of re-normalizing.

## Acceptance Criteria
- [x] Function separates JsonPatch entries from Stdout/Stderr
- [x] If patches exist, inserts them directly to log_entries
- [x] If no patches exist, runs normal normalization
- [x] Test from task 004 passes

## Technical Details
- Location: `crates/services/src/services/log_migration.rs` lines 257-300
- Collect messages in two vectors: existing_patches and stdout_stderr_messages
- Check if existing_patches is non-empty and use directly
- Add debug logging for which path is taken

## Code Changes
```rust
// Collect all messages, separating patches from raw logs
let mut stdout_stderr_messages = Vec::new();
let mut existing_patches: Vec<Patch> = Vec::new();

for line in record.logs.lines() {
    // ... parsing logic separating patches from raw
}

if !existing_patches.is_empty() {
    // Insert patches directly
} else {
    // Run normalization on raw logs
}
```

## Dependencies
- [x] Task 004 complete

## Effort Estimate
- Size: S
- Hours: 1

## Definition of Done
- [x] Code implemented
- [x] Test from task 004 passes
- [x] No regressions in existing tests
