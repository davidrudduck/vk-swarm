---
name: Enhance get_task_attempt_status response
status: open
created: 2026-01-19T12:00:00Z
updated: 2026-01-19T12:00:00Z
depends_on: []
conflicts_with: []
model_hint: moderate
estimated_minutes: 30
---

# Task: Enhance get_task_attempt_status response

## Goal
Add `task_title`, `is_running`, and `has_failed` computed fields to status response.

## Context
The `get_task_attempt_status` tool returns information about a task attempt. Orchestrators need additional fields to make decisions:
- `task_title`: Human-readable task name (currently need separate API call)
- `is_running`: Quick check if any process is running
- `has_failed`: Quick check if the latest CodingAgent process failed

**File location**: `crates/server/src/mcp/task_server.rs`

**Existing response struct** (lines 338-347):
```rust
#[derive(Debug, Serialize, schemars::JsonSchema)]
pub struct TaskAttemptStatusResponse {
    pub attempt_id: String,
    pub task_id: String,
    pub branch: String,
    pub executor: String,
    pub worktree_deleted: bool,
    pub created_at: String,
    pub processes: Vec<ExecutionProcessSummary>,
}
```

**Existing tool** (starts around line 1100):
```rust
#[tool(description = "Get attempt status with execution details.")]
async fn get_task_attempt_status(...)
```

## Steps
1. Update `TaskAttemptStatusResponse` struct to add new fields
2. Update `get_task_attempt_status` tool to fetch task and compute new fields

## Files to Modify
- `crates/server/src/mcp/task_server.rs` - Update struct (line 339), update tool implementation

## Code

### Step 1: Update TaskAttemptStatusResponse struct

Find `TaskAttemptStatusResponse` (around line 338) and update it:

Change:
```rust
#[derive(Debug, Serialize, schemars::JsonSchema)]
pub struct TaskAttemptStatusResponse {
    pub attempt_id: String,
    pub task_id: String,
    pub branch: String,
    pub executor: String,
    pub worktree_deleted: bool,
    pub created_at: String,
    pub processes: Vec<ExecutionProcessSummary>,
}
```

To:
```rust
#[derive(Debug, Serialize, schemars::JsonSchema)]
pub struct TaskAttemptStatusResponse {
    pub attempt_id: String,
    pub task_id: String,
    pub task_title: String,
    pub branch: String,
    pub executor: String,
    pub worktree_deleted: bool,
    pub created_at: String,
    pub processes: Vec<ExecutionProcessSummary>,
    /// True if any process has status "running"
    pub is_running: bool,
    /// True if latest CodingAgent process has status "failed"
    pub has_failed: bool,
}
```

### Step 2: Update get_task_attempt_status tool

Find the `get_task_attempt_status` tool (around line 1100). Look for where `TaskAttemptStatusResponse` is constructed and update it.

The tool needs to:
1. Fetch the task to get the title
2. Compute `is_running` from processes
3. Compute `has_failed` from processes

Find the section that creates the response (should be near the end of the function) and replace it:

```rust
        // Compute is_running: any process has status "running"
        let is_running = process_summaries
            .iter()
            .any(|p| p.status.to_lowercase() == "running");

        // Compute has_failed: latest CodingAgent process has status "failed"
        let has_failed = process_summaries
            .iter()
            .filter(|p| p.run_reason.to_lowercase() == "codingagent")
            .last()
            .map(|p| p.status.to_lowercase() == "failed")
            .unwrap_or(false);

        // Fetch task title
        let task_url = self.url(&format!("/api/tasks/{}", attempt.task_id));
        let task_title = match self.send_json::<Task>(self.client.get(&task_url)).await {
            Ok(t) => t.title,
            Err(_) => "Unknown".to_string(),
        };

        let response = TaskAttemptStatusResponse {
            attempt_id: attempt.id.to_string(),
            task_id: attempt.task_id.to_string(),
            task_title,
            branch: attempt.branch,
            executor: attempt.executor,
            worktree_deleted: attempt.worktree_deleted,
            created_at: attempt.created_at.to_rfc3339(),
            processes: process_summaries,
            is_running,
            has_failed,
        };
```

Note: The exact location and variable names may vary. Look for where `TaskAttemptStatusResponse` is currently constructed and update that section.

If `Task` is not already in scope, the tool may need to define a local struct for deserializing:

```rust
        #[derive(Deserialize)]
        struct TaskInfo {
            title: String,
        }

        let task_url = self.url(&format!("/api/tasks/{}", attempt.task_id));
        let task_title = match self.send_json::<TaskInfo>(self.client.get(&task_url)).await {
            Ok(t) => t.title,
            Err(_) => "Unknown".to_string(),
        };
```

## Verification
- [ ] Run `cargo check -p server` - should succeed with no errors
- [ ] `is_running` is true when any process has status "running"
- [ ] `has_failed` is true only when the LATEST CodingAgent process failed
- [ ] `task_title` is fetched from the task

## Commit
`feat(mcp): enhance get_task_attempt_status with computed fields`

## Notes
- The `is_running` check is case-insensitive
- The `has_failed` check only considers CodingAgent processes (not SetupScript, etc.)
- The `has_failed` check uses the LAST (most recent) CodingAgent process, not any failed one
- If the task fetch fails, `task_title` defaults to "Unknown" rather than failing the whole request
- The `Task` type may already be imported from db::models at the top of the file
