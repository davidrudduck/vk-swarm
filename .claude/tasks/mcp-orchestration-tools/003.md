---
name: Add get_all_templates endpoint
status: completed
created: 2026-01-19T12:00:00Z
updated: 2026-01-19T12:00:00Z
depends_on: ["001", "002"]
conflicts_with: []
model_hint: moderate
estimated_minutes: 30
---

# Task: Add get_all_templates endpoint

## Goal
Create endpoint that returns all templates (system + swarm + local) with source indicators.

## Context
This endpoint powers the unified templates API. It merges templates from three sources:
1. System templates (hardcoded in `SYSTEM_TEMPLATES` constant)
2. Swarm templates (fetched from Hive if connected)
3. Local templates (from SQLite database)

The endpoint returns `Vec<UnifiedTemplate>` sorted alphabetically by name.

**File location**: `crates/server/src/routes/templates.rs`

**Existing imports** (line 8):
```rust
use db::models::template::{CreateTemplate, Template, UpdateTemplate};
```

**Router function** (around line 73-86):
```rust
pub fn router(deployment: &DeploymentImpl) -> Router<DeploymentImpl> {
    let template_router = Router::new()
        .route("/", put(update_template).delete(delete_template))
        .layer(from_fn_with_state(...));

    let inner = Router::new()
        .route("/", get(get_templates).post(create_template))
        .nest("/{template_id}", template_router);

    Router::new().nest("/templates", inner)
}
```

## Steps
1. Update the import on line 8 to include `UnifiedTemplate`
2. Add the `get_all_templates` handler function after `get_templates` (around line 40)
3. Update the router to add the new route

## Files to Modify
- `crates/server/src/routes/templates.rs` - Update import (line 8), add handler (after line 40), update router (line 81-82)

## Code

### Step 1: Update import (line 8)

Change:
```rust
use db::models::template::{CreateTemplate, Template, UpdateTemplate};
```

To:
```rust
use db::models::template::{CreateTemplate, Template, UnifiedTemplate, UpdateTemplate};
```

### Step 2: Add handler function

Add this function after `get_templates` (after line 40, before `create_template`):

```rust
/// GET /api/templates/all - Returns all templates from all sources
pub async fn get_all_templates(
    State(deployment): State<DeploymentImpl>,
) -> Result<ResponseJson<ApiResponse<Vec<UnifiedTemplate>>>, ApiError> {
    let mut all_templates: Vec<UnifiedTemplate> = Vec::new();

    // 1. Add system templates
    for t in SYSTEM_TEMPLATES {
        all_templates.push(UnifiedTemplate {
            id: t.id.to_string(),
            name: t.name.to_string(),
            content: t.content.to_string(),
            description: Some(t.description.to_string()),
            source: "system".to_string(),
            created_at: None,
            updated_at: None,
        });
    }

    // 2. Add swarm templates if connected to Hive
    if let Ok(remote_client) = deployment.remote_client() {
        if let Ok(swarm_templates) = remote_client.list_swarm_templates().await {
            for t in swarm_templates {
                all_templates.push(UnifiedTemplate {
                    id: t.id.to_string(),
                    name: t.template_name,
                    content: t.content,
                    description: None,
                    source: "swarm".to_string(),
                    created_at: Some(t.created_at),
                    updated_at: Some(t.updated_at),
                });
            }
        }
    }

    // 3. Add local templates
    let local_templates = Template::find_all(&deployment.db().pool).await?;
    for t in local_templates {
        all_templates.push(UnifiedTemplate {
            id: t.id.to_string(),
            name: t.template_name,
            content: t.content,
            description: None,
            source: "local".to_string(),
            created_at: Some(t.created_at),
            updated_at: Some(t.updated_at),
        });
    }

    // Sort alphabetically by name
    all_templates.sort_by(|a, b| a.name.to_lowercase().cmp(&b.name.to_lowercase()));

    Ok(ResponseJson(ApiResponse::success(all_templates)))
}
```

### Step 3: Update router

Find the `router` function (around line 73) and update the `inner` Router:

Change:
```rust
    let inner = Router::new()
        .route("/", get(get_templates).post(create_template))
        .nest("/{template_id}", template_router);
```

To:
```rust
    let inner = Router::new()
        .route("/", get(get_templates).post(create_template))
        .route("/all", get(get_all_templates))
        .nest("/{template_id}", template_router);
```

## Verification
- [ ] Run `cargo check -p server` - should succeed with no errors
- [ ] Run `cargo test -p server` - all tests pass
- [ ] The handler returns system templates even without Hive connection

## Commit
`feat(server): add GET /api/templates/all endpoint`

## Notes
- The `deployment.remote_client()` returns `Result`, so we use `if let Ok(...)` to gracefully handle no Hive connection
- Swarm template failures are silently ignored (endpoint still returns system + local templates)
- The `?` operator on `Template::find_all` will return a 500 error if the local database query fails
- Templates are sorted case-insensitively by name
