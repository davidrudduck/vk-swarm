---
name: Move rand::Rng import to module level
status: completed
created: 2026-01-20T22:54:54Z
updated: 2026-01-21T08:51:00Z
depends_on: []
conflicts_with: []
model_hint: simple
estimated_minutes: 15
---

# Task: Move rand::Rng import to module level

## Description
Move the `use rand::Rng;` trait import from inside the `generate_secret()` function to the module-level imports section in `crates/server/src/routes/oauth.rs`. This aligns with Rust conventions where trait imports should be at module level for clarity and consistency.

## Acceptance Criteria
- [x] `use rand::Rng;` added to module-level imports (lines 1-19)
- [x] `use rand::Rng as RngTrait;` removed from `generate_secret()` function (line 212)
- [x] Code compiles without errors: `cargo build -p server`
- [x] No clippy warnings: `cargo clippy -p server -- -D warnings`
- [x] Existing functionality unchanged

## Technical Details
Currently, the `generate_secret()` function has a function-scoped import:
```rust
fn generate_secret() -> String {
    use rand::Rng as RngTrait;  // Line 212 - REMOVE THIS
    let mut rng = rand::rng();
    // ...
}
```

This should be moved to the top of the file with other imports. The import section currently ends at line 19.

**Key considerations:**
- The alias `as RngTrait` was only needed to avoid confusion within the function scope
- At module level, simply use `use rand::Rng;` (no alias needed)
- The `rand::rng()` call and `rng.random_range()` method will work identically after the change

## Dependencies
None - this is a standalone refactoring task.

## Steps

### Step 1: Add module-level import
Open `crates/server/src/routes/oauth.rs` and add the following import after line 17 (after `use uuid::Uuid;`):

```rust
use rand::Rng;
```

The import section should look like this after the change:
```rust
use axum::{
    Router,
    extract::{Json, Query, State},
    http::{Response, StatusCode},
    response::Json as ResponseJson,
    routing::{get, post},
};
use deployment::Deployment;
use rand::Rng;  // <-- ADD THIS LINE
use serde::{Deserialize, Serialize};
use services::services::oauth_credentials::Credentials;
use sha2::{Digest, Sha256};
use utils::{
    api::oauth::{HandoffInitRequest, HandoffRedeemRequest, StatusResponse},
    jwt::extract_expiration,
    response::ApiResponse,
};
use uuid::Uuid;

use crate::{DeploymentImpl, error::ApiError};
```

### Step 2: Remove function-local import
In the same file, remove line 212 which contains:
```rust
    use rand::Rng as RngTrait;
```

The `generate_secret()` function should now start like this:
```rust
fn generate_secret() -> String {
    let mut rng = rand::rng();
    (0..64)
        .map(|_| {
            let idx = rng.random_range(0..62);
            const CHARS: &[u8] = b"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
            CHARS[idx] as char
        })
        .collect()
}
```

### Step 3: Verify the changes
Run the following commands to ensure everything works:

```bash
# Build the server crate
cargo build -p server

# Run clippy to check for warnings
cargo clippy -p server -- -D warnings

# Optionally run tests
cargo test -p server
```

All commands should complete without errors or warnings.

## Files to Modify
- `crates/server/src/routes/oauth.rs` - Add `use rand::Rng;` at module level (after line 17), remove `use rand::Rng as RngTrait;` from line 212

## Code

**Complete import section (lines 1-20):**
```rust
use axum::{
    Router,
    extract::{Json, Query, State},
    http::{Response, StatusCode},
    response::Json as ResponseJson,
    routing::{get, post},
};
use deployment::Deployment;
use rand::Rng;
use serde::{Deserialize, Serialize};
use services::services::oauth_credentials::Credentials;
use sha2::{Digest, Sha256};
use utils::{
    api::oauth::{HandoffInitRequest, HandoffRedeemRequest, StatusResponse},
    jwt::extract_expiration,
    response::ApiResponse,
};
use uuid::Uuid;

use crate::{DeploymentImpl, error::ApiError};
```

**Complete generate_secret() function (lines 211-221):**
```rust
fn generate_secret() -> String {
    let mut rng = rand::rng();
    (0..64)
        .map(|_| {
            let idx = rng.random_range(0..62);
            const CHARS: &[u8] = b"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
            CHARS[idx] as char
        })
        .collect()
}
```

## Validation
- [x] Code implemented correctly
- [x] `cargo build -p server` succeeds
- [x] `cargo clippy -p server -- -D warnings` produces no warnings in oauth.rs
- [x] OAuth functionality still works (no behavior changes)
- [x] Code committed with appropriate message

## Commit
```bash
refactor: move rand::Rng import to module level in oauth.rs
```

## Notes
- This file uses spaces for indentation (standard Rust formatting)
- The change is purely cosmetic and does not affect runtime behavior
- After making the change, run `cargo fmt` to ensure consistent formatting
- The `Rng` trait is needed for the `random_range()` method used in the function
